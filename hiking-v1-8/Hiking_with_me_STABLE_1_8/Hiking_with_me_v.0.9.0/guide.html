<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>è·Ÿæˆ‘èµ° Â· å¾’æ­¥é¢†é˜ŸæŒ‡å—</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <style>
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    html,body{
      margin:0;padding:0;height:100%;overflow:hidden;
      font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",Arial,sans-serif;
      background:#f4f4f5;color:#111827;
    }
    body{display:flex;flex-direction:column;}
    .page{
      height:100dvh;
      max-height:100dvh;
      width:100%;
      margin:0 auto;
      display:flex;
      flex-direction:column;
    }
    header{
      flex:0 0 auto;
      height:56px;
      padding:0 12px;
      display:flex;align-items:center;
      background:#111827;color:#f9fafb;
    }
    header .back{
      width:34px;height:34px;border-radius:17px;border:1px solid #e5e7eb;
      display:flex;align-items:center;justify-content:center;
      margin-right:8px;font-size:18px;
    }
    header .titles{display:flex;flex-direction:column;overflow:hidden;}
    header .titles .main{font-size:17px;font-weight:600;}
    header .titles .sub{font-size:12px;color:#d1d5db;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .content{
      flex:1 1 auto;
      display:flex;
      flex-direction:column;
      padding:8px 8px 0;
      overflow:hidden;
    }
    .search-row{
      flex:0 0 auto;
      display:flex;
      align-items:center;
      margin-bottom:8px;
    }
    .search-input{
      flex:1;
      height:34px;
      border-radius:17px;
      background:#111827;
      color:#e5e7eb;
      border:none;
      padding:0 12px;
      font-size:13px;
    }
    .lock-btn{
      width:30px;height:30px;margin-left:8px;
      border-radius:15px;
      border:none;
      background:#374151;
      display:flex;align-items:center;justify-content:center;
      color:#facc15;
      font-size:18px;
    }
    .main-row{
      flex:1 1 auto;
      display:flex;
      overflow:hidden;
    }
    .display-panel{
      flex:3;
      margin-right:6px;
      border-radius:24px;
      background:#ffffff;
      box-shadow:0 6px 18px rgba(0,0,0,.06);
      padding:8px;
      display:flex;
      flex-direction:column;
    }
    .scene-image-wrapper{
      position:relative;
      flex:1 1 auto;
      border-radius:18px;
      overflow:hidden;
      background:#e5e7eb;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    #sceneImage{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .img-nav{
      position:absolute;
      top:50%;
      transform:translateY(-50%);
      width:30px;height:30px;
      border-radius:15px;
      border:none;
      background:rgba(0,0,0,.45);
      color:#f9fafb;
      font-size:18px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .img-nav.prev{left:8px;}
    .img-nav.next{right:8px;}
    .img-counter{
      position:absolute;
      bottom:6px;right:8px;
      padding:3px 7px;
      border-radius:999px;
      background:rgba(0,0,0,.65);
      color:#f9fafb;
      font-size:11px;
    }
    .scene-caption{
      flex:0 0 auto;
      margin-top:6px;
      font-size:12px;
      color:#4b5563;
    }
    .scene-caption strong{color:#111827;}
    .scene-list{
      flex:1;
      overflow-y:auto;
      padding-left:4px;
    }
    .scene-btn{
      width:100%;
      border-radius:20px;
      border:1px solid #d1d5db;
      background:#fff;
      padding:8px 12px;
      font-size:14px;
      text-align:left;
      margin-bottom:8px;
    }
    .scene-btn span{
      display:block;
      font-size:11px;
      color:#6b7280;
      margin-top:2px;
    }
    .scene-btn.active{
      background:#c42020;
      color:#fff;
      border-color:#c42020;
    }
    .scene-btn.active span{color:#fee2e2;}
    .audio-bar{
      flex:0 0 auto;
      margin-top:8px;
      margin-bottom:4px;
      padding:8px 10px;
      border-radius:18px;
      background:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,.06);
      display:flex;
      align-items:center;
      gap:8px;
    }
    .audio-btn{
      width:30px;height:30px;border-radius:15px;border:none;
      background:#111827;color:#fff;font-size:15px;
      display:flex;align-items:center;justify-content:center;
      padding:0;
    }
    .audio-btn svg.skip-icon{
      width:22px;
      height:22px;
    }
    .time-label{font-size:11px;min-width:60px;text-align:center;}
    .progress{
      flex:1;
      height:4px;border-radius:2px;
      background:#e5e7eb;position:relative;
      cursor:pointer;
    }
    .progress-inner{
      position:absolute;left:0;top:0;bottom:0;
      width:0;background:#c42020;border-radius:2px;
    }
    .speed-btn{
      padding:0 8px;
      border-radius:14px;
      border:1px solid #c42020;
      background:#fff;
      color:#c42020;
      font-size:12px;
      height:26px;
    }
    .bottom-nav{
      flex:0 0 auto;
      height:72px;
      background:#111827;
      display:flex;
      align-items:center;
      justify-content:space-around;
      color:#9ca3af;
      font-size:12px;
      padding-bottom:4px;
    }
    .nav-item{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      flex:1;
    }
    .nav-icon{
      width:32px;height:32px;border-radius:16px;
      border:1px solid currentColor;
      margin-bottom:4px;
      font-size:14px;
      display:flex;align-items:center;justify-content:center;
    }
    .nav-item.active{color:#f97373;}
  </style>
  <script src="assets/config/config.js"></script>
</head>
<body>
<div class="page">
  <header>
    <div class="back" onclick="window.location.href='Hiking With Me.html'">â€¹</div>
    <div class="titles">
      <span class="main">å¾’æ­¥é¢†é˜ŸæŒ‡å— Â· Hiking With Me</span>
      <span class="sub" id="guideSubtitle">è·¯çº¿æ€»è§ˆ</span>
    </div>
  </header>
  <div class="content">
    <div class="search-row">
      <input class="search-input" id="routeSearch" placeholder="çº¿è·¯æœç´¢ / å…³é”®å­—ï¼ˆé¢„ç•™ï¼‰" />
      <button class="lock-btn" id="lockBtn" aria-label="è§£é”ç¼–è¾‘">ğŸ”“</button>
    </div>
    <div class="main-row">
      <div class="display-panel">
        <div class="scene-image-wrapper">
          <img id="sceneImage" src="" alt="åœºæ™¯å›¾ç‰‡" />
          <button class="img-nav prev" id="imgPrev">â€¹</button>
          <button class="img-nav next" id="imgNext">â€º</button>
          <div class="img-counter" id="imgCounter">0/0</div>
        </div>
        <div class="scene-caption" id="sceneCaption">
          å½“å‰åœºæ™¯è¯´æ˜
        </div>
      </div>
      <div class="scene-list" id="sceneList">
      </div>
    </div>
    <div class="audio-bar">
      <button class="audio-btn" id="prevBtn" aria-label="åé€€10ç§’">
        <svg class="skip-icon" viewBox="0 0 32 32">
          <circle cx="16" cy="16" r="11" fill="none" stroke="white" stroke-width="2"></circle>
          <text x="16" y="20" text-anchor="middle" fill="white" font-size="11" font-family="system-ui, -apple-system, BlinkMacSystemFont">-10"</text>
        </svg>
      </button>
      <button class="audio-btn" id="playPauseBtn">â–¶</button>
      <button class="audio-btn" id="nextBtn" aria-label="å¿«è¿›10ç§’">
        <svg class="skip-icon" viewBox="0 0 32 32">
          <circle cx="16" cy="16" r="11" fill="none" stroke="white" stroke-width="2"></circle>
          <text x="16" y="20" text-anchor="middle" fill="white" font-size="11" font-family="system-ui, -apple-system, BlinkMacSystemFont">+10"</text>
        </svg>
      </button>
      <div class="time-label"><span id="currentTime">0:00</span> / <span id="duration">0:00</span></div>
      <div class="progress" id="progress">
        <div class="progress-inner" id="progressInner"></div>
      </div>
      <button class="speed-btn" id="speedBtn">1x</button>
      <button class="audio-btn" id="replayBtn">â†»</button>
    </div>
  </div>
  <div class="bottom-nav">
    <div class="nav-item active" data-cat="route">
      <div class="nav-icon">çº¿</div>
      <div>è·¯çº¿</div>
    </div>
    <div class="nav-item" data-cat="gear">
      <div class="nav-icon">è£…</div>
      <div>è£…å¤‡</div>
    </div>
    <div class="nav-item" data-cat="skill">
      <div class="nav-icon">æŠ€</div>
      <div>æŠ€èƒ½</div>
    </div>
    <div class="nav-item" data-cat="know">
      <div class="nav-icon">çŸ¥</div>
      <div>çŸ¥è¯†</div>
    </div>
    <div class="nav-item" data-cat="safety">
      <div class="nav-icon">å®‰</div>
      <div>å®‰å…¨</div>
    </div>
  </div>
</div>

<audio id="guideAudio" preload="auto"></audio>

<script>
(function(){
  const cfg = window.ROUTE_GUIDE_CONFIG || {
    home: { title:"è·¯çº¿æ€»è§ˆ" },
    categories:{
      route:[],
      gear:[],
      skill:[],
      know:[],
      safety:[]
    }
  };

  document.getElementById('guideSubtitle').textContent =
    (cfg.home && cfg.home.title) ? cfg.home.title : "è·¯çº¿æ€»è§ˆ";

  const audio = document.getElementById('guideAudio');
  const sceneImage = document.getElementById('sceneImage');
  const sceneCaption = document.getElementById('sceneCaption');
  const sceneListEl = document.getElementById('sceneList');
  const playPauseBtn = document.getElementById('playPauseBtn');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const replayBtn = document.getElementById('replayBtn');
  const speedBtn = document.getElementById('speedBtn');
  const currentTimeEl = document.getElementById('currentTime');
  const durationEl = document.getElementById('duration');
  const progress = document.getElementById('progress');
  const progressInner = document.getElementById('progressInner');
  const lockBtn = document.getElementById('lockBtn');
  const navItems = document.querySelectorAll('.nav-item');
  const imgPrev = document.getElementById('imgPrev');
  const imgNext = document.getElementById('imgNext');
  const imgCounter = document.getElementById('imgCounter');

  let currentCategory = 'route';
  let currentSceneIndex = -1;
  let currentImageIndex = 0;
  let locked = false;
  let speeds = [1, 1.5, 2.0];
  let speedIndex = 0;

  const categories = cfg.categories || {route:[],gear:[],skill:[],know:[],safety:[]};

  function secToMMSS(sec){
    sec = Math.floor(sec||0);
    const m = Math.floor(sec/60);
    const s = sec%60;
    return m + ':' + (s<10?'0'+s:s);
  }

  function getScenes(){
    return categories[currentCategory] || [];
  }

  
  function renderSceneList(){
    const scenes = getScenes();
    sceneListEl.innerHTML = '';
    scenes.forEach(function(scene, index){
      const btn = document.createElement('button');
      btn.className = 'scene-btn' + (index===currentSceneIndex ? ' active':'');
      btn.dataset.index = index;
      const main = document.createElement('div');
      main.textContent = scene.label || '(æœªå‘½ååœºæ™¯)';

      const sub = document.createElement('span');
      const audios = (scene.audios && scene.audios.length) ? scene.audios :
                     (scene.audio ? [scene.audio] : []);
      const images = (scene.images && scene.images.length) ? scene.images :
                     (scene.image ? [scene.image] : []);
      const audioCount = audios.length;
      const imageCount = images.length;

      if (audioCount || imageCount){
        sub.textContent = 'éŸ³é¢‘ ' + (audioCount||0) + ' Â· å›¾ç‰‡ ' + (imageCount||0);
      }else{
        sub.textContent = '';
      }

      btn.appendChild(main);
      btn.appendChild(sub);
      btn.addEventListener('click', function(){
        if (locked) return;
        currentSceneIndex = index;
        currentImageIndex = 0;
        updateScene();
      });
      sceneListEl.appendChild(btn);
    });
  }

  function updateImage(){
    const scenes = getScenes();
    const scene = scenes[currentSceneIndex];
    if (!scene){
      sceneImage.src = '';
      imgCounter.textContent = '0/0';
      imgPrev.style.display = 'none';
      imgNext.style.display = 'none';
      return;
    }
    const imgs = scene.images || [];
    if (imgs.length>0){
      if (currentImageIndex<0) currentImageIndex = imgs.length-1;
      if (currentImageIndex>=imgs.length) currentImageIndex = 0;
      const filename = imgs[currentImageIndex];
      sceneImage.src = 'assets/images/' + filename;
      imgCounter.textContent = (currentImageIndex+1) + '/' + imgs.length;
      imgPrev.style.display = imgs.length>1 ? 'flex' : 'none';
      imgNext.style.display = imgs.length>1 ? 'flex' : 'none';
      imgCounter.style.display = 'block';
    }else{
      sceneImage.src = '';
      imgCounter.textContent = '0/0';
      imgPrev.style.display = 'none';
      imgNext.style.display = 'none';
    }
  }

  
  function updateScene(){
    const scenes = getScenes();
    if (!scenes.length){
      sceneCaption.textContent = 'è¯¥åˆ†ç±»æš‚æ— åœºæ™¯';
      sceneImage.src = '';
      imgCounter.textContent = '0/0';
      progressInner.style.width = '0';
      currentTimeEl.textContent = '0:00';
      durationEl.textContent = '0:00';
      audio.removeAttribute('src');
      audio.load();
      playPauseBtn.textContent = 'â–¶';
      return;
    }

    // å°šæœªé€‰æ‹©åœºæ™¯ï¼šæ˜¾ç¤ºå½“å‰åˆ†ç±»å°é¢å›¾ï¼Œä¸è‡ªåŠ¨æ’­æ”¾
    if (currentSceneIndex < 0){
      const btns = sceneListEl.querySelectorAll('.scene-btn');
      btns.forEach(function(b){ b.classList.remove('active'); });

      const cfgAll = window.ROUTE_GUIDE_CONFIG || {};
      const covers = cfgAll.covers || {};
      let filename = covers[currentCategory] || '';
      if (!filename && cfgAll.home && currentCategory === 'route'){
        filename = cfgAll.home.mapImage || '';
      }

      if (filename){
        sceneImage.src = 'assets/images/' + filename;
        imgCounter.textContent = '1/1';
      }else{
        sceneImage.src = '';
        imgCounter.textContent = '0/0';
      }

      sceneCaption.textContent = 'è¯·é€‰æ‹©åœºæ™¯åå¼€å§‹æ’­æ”¾';
      progressInner.style.width = '0';
      currentTimeEl.textContent = '0:00';
      durationEl.textContent = '0:00';
      audio.removeAttribute('src');
      audio.load();
      playPauseBtn.textContent = 'â–¶';
      return;
    }

    if (currentSceneIndex>=scenes.length) currentSceneIndex = scenes.length-1;
    const scene = scenes[currentSceneIndex];

    const btns = sceneListEl.querySelectorAll('.scene-btn');
    btns.forEach(function(b,idx){ b.classList.toggle('active', idx===currentSceneIndex); });

    updateImage();

    const catLabelMap = {route:'è·¯çº¿',gear:'è£…å¤‡',skill:'æŠ€èƒ½',know:'çŸ¥è¯†',safety:'å®‰å…¨'};
    const catLabel = catLabelMap[currentCategory] || '';
    sceneCaption.innerHTML = '<strong>' + (scene.label || '') + '</strong>' + (catLabel ? ' Â· ' + catLabel : '');

    const audios = (scene.audios && scene.audios.length) ? scene.audios :
                   (scene.audio ? [scene.audio] : []);
    const firstAudio = audios.length ? audios[0] : '';

    if (firstAudio){
      audio.src = 'assets/audio/' + firstAudio;
      audio.currentTime = 0;
      audio.playbackRate = speeds[speedIndex];
      audio.play().catch(function(){});
      playPauseBtn.textContent = 'â¸';
    }else{
      audio.removeAttribute('src');
      audio.load();
      playPauseBtn.textContent = 'â–¶';
      progressInner.style.width = '0';
      currentTimeEl.textContent = '0:00';
      durationEl.textContent = '0:00';
    }
  }

  function setCategory(cat){
    if (locked) return;
    currentCategory = cat;
    currentSceneIndex = -1;
    currentImageIndex = 0;
    navItems.forEach(function(item){
      item.classList.toggle('active', item.dataset.cat===cat);
    });
    renderSceneList();
    updateScene();
  }

  playPauseBtn.addEventListener('click', function(){
    if (!audio.src){
      updateScene();
      return;
    }
    if (audio.paused){
      audio.play().catch(function(){});
      playPauseBtn.textContent = 'â¸';
    }else{
      audio.pause();
      playPauseBtn.textContent = 'â–¶';
    }
  });

  prevBtn.addEventListener('click', function(){
    if (locked) return;
    if (!audio.src) return;
    const cur = audio.currentTime || 0;
    const nextTime = Math.max(0, cur - 10);
    audio.currentTime = nextTime;
  });

  nextBtn.addEventListener('click', function(){
    if (locked) return;
    if (!audio.src) return;
    const cur = audio.currentTime || 0;
    const dur = isFinite(audio.duration) ? audio.duration : cur + 10;
    const nextTime = Math.min(dur, cur + 10);
    audio.currentTime = nextTime;
  });

  replayBtn.addEventListener('click', function(){
    if (!audio.src) return;
    audio.currentTime = 0;
    audio.play().catch(function(){});
    playPauseBtn.textContent = 'â¸';
  });

  speedBtn.addEventListener('click', function(){
    speedIndex = (speedIndex+1)%speeds.length;
    audio.playbackRate = speeds[speedIndex];
    speedBtn.textContent = speeds[speedIndex] + 'x';
  });

  audio.addEventListener('timeupdate', function(){
    currentTimeEl.textContent = secToMMSS(audio.currentTime);
    durationEl.textContent = secToMMSS(audio.duration);
    if (audio.duration>0){
      const p = (audio.currentTime/audio.duration)*100;
      progressInner.style.width = p + '%';
    }else{
      progressInner.style.width = '0';
    }
  });

  progress.addEventListener('click', function(e){
    const rect = progress.getBoundingClientRect();
    const ratio = (e.clientX - rect.left)/rect.width;
    if (audio.duration>0){
      audio.currentTime = Math.max(0, Math.min(audio.duration*ratio, audio.duration));
    }
  });

  lockBtn.addEventListener('click', function(){
    locked = !locked;
    lockBtn.style.background = locked ? '#c42020' : '#374151';
    lockBtn.textContent = locked ? 'ğŸ”’' : 'ğŸ”“';
    lockBtn.setAttribute('aria-label', locked ? 'å·²é”å®šï¼ˆé”å®šå½“å‰åˆ†ç±»ä¸åœºæ™¯ï¼‰' : 'è§£é”ç¼–è¾‘');
  });

  navItems.forEach(function(item){
    item.addEventListener('click', function(){
      setCategory(item.dataset.cat);
    });
  });

  imgPrev.addEventListener('click', function(){
    const scenes = getScenes();
    if (!scenes.length) return;
    currentImageIndex--;
    updateImage();
  });
  imgNext.addEventListener('click', function(){
    const scenes = getScenes();
    if (!scenes.length) return;
    currentImageIndex++;
    updateImage();
  });

  renderSceneList();
  updateScene();
})();
</script>
</body>
</html>
