<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>ä½“éªŒå‘å¯¼ Â· è·Ÿæˆ‘èµ° Hiking With Me</title>

  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

  <link rel="stylesheet" href="assets/css/leaflet.css" />
  <script src="assets/js/leaflet.js"></script>
  <script src="assets/config/config.js"></script>
  <script src="./progress_state.js"></script>

<script src="./progress_state.js"></script>
<style id="FORCED_CHECKIN_BUTTON_STYLE">
/* === æ‰“å¡æŒ‰é’®å¤–è§‚ï¼ˆä¸ç¢°è¡Œä¸ºï¼‰ === */
.scene-drawer-handle,
.scene-drawer-handle-button{
  background: rgba(40,40,40,0.8) !important;
  backdrop-filter: blur(12px) !important;
  -webkit-backdrop-filter: blur(12px) !important;
  border-radius: 999px !important;
  box-shadow: 0 6px 18px rgba(0,0,0,0.25) !important;
}

/* æ¸…ç©ºå†…éƒ¨æ—§æ ·å¼ */
.scene-drawer-handle *,
.scene-drawer-handle-button *{
  background: transparent !important;
  box-shadow: none !important;
}

/* ç™½è‰²å‘ä¸Šä¸‰è§’ */
.scene-drawer-handle-arrow,
.scene-drawer-arrow{
  width: 0 !important;
  height: 0 !important;
  border-left: 6px solid transparent !important;
  border-right: 6px solid transparent !important;
  border-bottom: 8px solid #ffffff !important;
  border-top: 0 !important;
}
</style>





  <style>

    
    *{
      margin:0;
      padding:0;
      box-sizing:border-box;
      -webkit-tap-highlight-color:transparent;
    }
    html,body{
      height:100%;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,
        "PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;
      background:#f5f5f5;
    }
    body{ overflow:hidden; }

    .page{
      position:relative;
      width:100%;
      height:100%;
      display:flex;
      flex-direction:column;
      background:#f5f5f5;
    }
    .map-wrapper{
      position:relative;
      flex:1 1 auto;
      overflow:hidden;
      background:#e6e9f5;
    }
    #map{
      width:100%;
      height:100%;
    }

    .stats-card{
      position:absolute;
      top:12px;
      left:12px;
      background:rgba(255,255,255,0.96);
      border-radius:10px;
      padding:8px 10px;
      box-shadow:0 2px 6px rgba(0,0,0,0.15);
      font-size:11px;
      line-height:1.5;
      color:#444;
      z-index:800;
    }
    .stats-card strong{
      color:#b20000;
      font-weight:600;
    }

    /* éšè—å³ä¸‹è§’ Leaflet é»˜è®¤çš„ç‰ˆæƒ/åœ°å›¾æ¥æºå¡ç‰‡ */
    .leaflet-control-attribution{
      display:none !important;
    }

    /* ç»Ÿä¸€å…³é—­åœ°å›¾ä¸Šçš„é•¿æŒ‰å‘¼å‡ºèœå• & æ–‡æœ¬é€‰æ‹© */
    body, #map{
      -webkit-touch-callout:none;
      -webkit-user-select:none;
      user-select:none;
    }

    .map-tools{
      position:absolute;
      top:18px;
      right:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      z-index:810;
    }

    /* === è·¯çº¿èŠ‚ç‚¹æ°”æ³¡ï¼ˆçº¢è¾¹æ ‡ç­¾ï¼‰ === */
    .poi-marker{
      pointer-events:auto;
    }

    /* é»˜è®¤ï¼šä¸æ˜¾ç¤ºç«–çº¿ + æ™®é€šè½»æŠ•å½± */
    .poi-label{
      position:relative;
      display:inline-flex;
      align-items:center;
      padding:2px 9px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,0.08);
      background:rgba(255,255,255,0.96);
      color:#222;
      font-size:11px;
      font-weight:400;
      white-space:nowrap;
      box-shadow:none;
    }

    /* é»˜è®¤ï¼šç«–çº¿éšè— */
    .poi-label::before{
      content:"";
      display:none;
    }

    /* é€‰ä¸­çŠ¶æ€ï¼šçº¢è¾¹ + çº¢å­— + ç«–çº¿ */
    .poi-label--active{
      border-color:#d62828;
      color:#d62828;
      font-weight:500;
      box-shadow:none;
    }
    .poi-label--active::before{
      display:block;
      position:absolute;
      left:50%;
      top:100%;
      margin-top:2px;
      width:2px;
      height:14px;
      transform:translateX(-50%);
      background:#d62828;
      border-radius:999px;
      box-shadow:0 1px 2px rgba(214,40,40,0.45);
    }
    .poi-label--active::after{
      content:"";
      position:absolute;
      left:45%;
      top:100%;
      margin-top:15px;
      width:70%;
      height:8px;
      transform:translateX(-50%);
      border-radius:50%;
      background:rgba(0,0,0,0.22);
      filter:blur(4px);
      pointer-events:none;
    }

    .tool-btn{
      width:40px;
      height:40px;
      border-radius:20px;
      border:none;
      background:rgba(255,255,255,0.96);
      box-shadow:0 2px 6px rgba(0,0,0,0.15);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:13px;
      color:#222;
      cursor:pointer;
    }
    .tool-btn:active{
      transform:scale(0.96);
      box-shadow:0 1px 3px rgba(0,0,0,0.2);
    }

    /* æŒ‰é’®æ¿€æ´»çŠ¶æ€ï¼šåªå˜æˆçº¢å­— + ç¨å¾®åŠ ç²— */
    .tool-btn.active{
      color:#d60000;
      font-weight:600;
    }

    /* èŠ‚ç‚¹å›¾å±‚æŒ‰é’®çš„å°å›¾æ ‡ï¼šä¸‰æ¡å åœ¨ä¸€èµ·çš„â€œå›¾å±‚â€ */
    .icon-layerstack{
      display:flex;
      flex-direction:column;
      gap:3px;
      align-items:center;
      justify-content:center;
    }
    .icon-layerstack .layer{
      display:block;
      width:16px;
      height:1.6px;
      border-radius:1px;
      background:#222;
    }
    /* åªæœ‰èŠ‚ç‚¹æŒ‰é’®æ¿€æ´»æ—¶ï¼Œè®©å›¾å±‚å›¾æ ‡å˜çº¢ */
    #btnNodeToggle.active .icon-layerstack .layer{
      background:#d60000;
    }

    /* SAT æŒ‰é’®æ¿€æ´»æ—¶ï¼šæ–‡å­—å˜çº¢ã€åŠ ç²— */
    #btnLayerToggle.active{
      color:#d60000;
      font-weight:600;
    }

    .map-tools-bottom{
      position:absolute;
      right:12px;
      bottom:90px;
      display:flex;
      flex-direction:column;
      gap:10px;
      z-index:810;
    }
    .tool-round{
      width:44px;
      height:44px;
      border-radius:22px;
      border:none;
      background:rgba(255,255,255,0.96);
      box-shadow:0 2px 6px rgba(0,0,0,0.18);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
    }
    .tool-round:active{
      transform:scale(0.95);
      box-shadow:0 1px 3px rgba(0,0,0,0.2);
    }
    .tool-round svg{
      width:24px;
      height:24px;
      stroke:#000;
      fill:none;
    }

    .cache-status{
      position:absolute;
      left:50%;
      bottom:140px;
      transform:translateX(-50%);
      background:rgba(0,0,0,0.7);
      color:#fff;
      padding:6px 10px;
      border-radius:14px;
      font-size:11px;
      line-height:1.4;
      max-width:80%;
      text-align:center;
      z-index:820;
      display:none;
    }

    .leaflet-control-attribution{
      font-size:9px;
      background:rgba(255,255,255,0.9);
      position:absolute !important;
      bottom:72px !important;
      right:5px !important;
      z-index:600 !important;
      padding:3px 6px;
      border-radius:4px;
      max-width:65%;
    }
    /* ===== åœºæ™¯ä¿¡æ¯æµæ‚¬æµ®çª— ===== */
    .scene-panel{
      position:absolute;
      left:8px;
      right:8px;
      bottom:72px;                 /* åˆšå¥½é¡¶åœ¨åº•éƒ¨ Tab ä¸Šé¢ */
      border-radius:12px 12px 0 0;
      background:rgba(40,40,40,0.88);
      box-shadow:0 -6px 18px rgba(0,0,0,0.45);
      color:#fff;
      font-size:11px;
      overflow:hidden;
      backdrop-filter:blur(14px);
      -webkit-backdrop-filter:blur(14px);
      z-index:830;
    }

    /* é¡¶éƒ¨çŠ¶æ€æ¡ + å±…ä¸­ä¸‹æ‹‰ä¸‰è§’ï¼Œç•™å‡ºç©ºç™½ä¸è¢«æ–‡å­—è¦†ç›– */
    .scene-header{
      display:flex;
      align-items:center;
      padding:4px 8px 6px;
      border-bottom:1px solid rgba(255,255,255,0.15);
      background:rgba(30,30,30,0.95);
    }
    .scene-header-left,
    .scene-header-right{
      flex:1;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      color:rgba(255,255,255,0.9);
    }
    .scene-header-left{
      text-align:left;
    }
    .scene-header-right{
      text-align:right;
    }

    .scene-header-arrow{
      width:56px;             /* è¿™ä¸ªå®½åº¦å°±æ˜¯ç•™ç™½åŒºåŸŸ */
      height:20px;
      position:relative;
    }
    .scene-header-arrow::after{
      content:"";
      position:absolute;
      left:50%;
      top:2px;
      transform:translateX(-50%);
      width:0;
      height:0;
      border-left:16px solid transparent;
      border-right:16px solid transparent;
      border-top:10px solid #f5f5f5;   /* ç™½è‰²å°ä¸‰è§’ */
    }

    /* æ•´ä½“è¡¨æ ¼åŒºåŸŸ */
    .scene-table{
      width:100%;
    }

    .scene-row{
      display:flex;
      align-items:stretch;
      min-height:32px;
      border-top:1px solid rgba(255,255,255,0.12);
    }

    /* å½“å‰è¡Œï¼šæ•´è¡Œç»¿è‰²åº•ï¼Œç™½å­—ï¼ŒåŠ ç²— */
    .scene-row-current{
      background:#09a540;
      font-weight:600;
    }

    .scene-col{
      padding:4px 6px;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* å·¦ä¾§è·ç¦»è‰²å—åˆ—ï¼šå®½å›ºå®šï¼Œå­—å·ç•¥å¤§ä¸€ç‚¹ */
    .scene-col-distance{
      width:68px;
      flex:0 0 68px;
      font-weight:600;
      justify-content:center;
      color:#fff;
    }
    .scene-distance--green{  background:#00aa40; }
    .scene-distance--yellow{ background:#ffb400; }
    .scene-distance--orange{ background:#ff7a00; }
    .scene-distance--red{    background:#e02020; }

    /* ä¸­é—´ä¸¤åˆ—ï¼šæ ‡é¢˜ & åœºæ™¯ç»„åˆæ–‡å­— */
    .scene-col-title{
      flex:1.1;
      flex-direction:column;
      align-items:flex-start;
      justify-content:center;
      gap:2px;
    }
    .scene-title-main{
      font-size:12px;
      font-weight:600;
    }
    .scene-title-sub{
      font-size:11px;
      color:rgba(255,255,255,0.75);
    }

    /* å³ä¾§ä¸¤åˆ—ï¼šè·ç¦»/æ—¶é—´ å’Œ è¿›åº¦æ¡ */
    .scene-col-length{
      width:70px;
      flex:0 0 70px;
      justify-content:flex-end;
      font-variant-numeric:tabular-nums;
    }
    .scene-col-progress{
      width:70px;
      flex:0 0 70px;
      padding-right:10px;
      justify-content:flex-end;
    }

    .scene-progress-bar{
      width:100%;
      height:6px;
      border-radius:999px;
      background:rgba(255,255,255,0.25);
      overflow:hidden;
    }
    .scene-progress-fill{
      height:100%;
      border-radius:999px;
      background:#00e676;
    }

    /* è®©æ™®é€šè¡Œç•¥å¾®æ·±ä¸€ç‚¹ã€åˆ†å±‚æ„Ÿæ›´å¥½ */
    .scene-row:nth-child(2n+1):not(.scene-row-current){
      background:rgba(0,0,0,0.12);
    }

    /* === åº•éƒ¨ Tab æ ç»Ÿä¸€æ ·å¼ === */
    .tab-bar{
      position:fixed;
      left:0;
      right:0;
      bottom:0;
      display:flex;
      gap:10px;
      padding:8px 12px calc(8px + env(safe-area-inset-bottom));
      background:#f9fafb;
      box-shadow:0 -2px 6px rgba(0,0,0,0.06);
      z-index:900;
    }

    /* === åº•éƒ¨åœºæ™¯æŠ½å±‰å°æŒ‰é’®ï¼ˆç°è‰²ä¸Šæ‹‰ï¼‰ === */
    .scene-drawer-handle{
      position:absolute;
      left:50%;
      bottom:60px; /* åœ¨åº•éƒ¨ Tab æ ä¸Šæ–¹ä¸€ç‚¹ */
      transform:translateX(-50%);
      z-index:840;
    }

    /* åº•éƒ¨æŠ½å±‰æ‰‹æŸ„æŒ‰é’®ï¼ˆä¸Šæ‹‰ï¼‰ */
    .scene-drawer-button{
      width:90px;
      height:30px;
      border-radius:12px;
      background:rgba(40,40,40,0.32);
      box-shadow:0 2px 8px rgba(0,0,0,0.25);
      backdrop-filter:blur(8px);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition:background 0.2s;
    }

    /* é»˜è®¤ï¼šç™½è‰²å‘ä¸Šçš„å°ç®­å¤´ */
    .scene-drawer-arrow{
      width:0;
      height:0;
      border-left:7px solid transparent;
      border-right:7px solid transparent;
      border-bottom:9px solid #ffffff;
    }

    /* å½“æŸä¸ªèŠ‚ç‚¹æœ‰åœºæ™¯ä¿¡æ¯æµæ—¶ï¼šåº•éƒ¨æ‰‹æŸ„ç®­å¤´å˜çº¢ */
    .scene-drawer-handle--active .scene-drawer-arrow{
      border-bottom-color:#d62828;
    }

    /* åŸºç¡€æŒ‰é’®æ ·å¼ï¼ˆé«˜åº¦ã€åœ†è§’ã€å­—ä½“éƒ½ç»Ÿä¸€ï¼‰ */
    .tab-btn,
    .bottom-tab{
      flex:1;
      height:40px;
      border-radius:12px;
      border:1px solid #e5e5e5;
      background:#ffffff;
      color:#333333;
      font-size:20px;
      font-weight:600;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0;
    }

    /* æœªé€‰ä¸­çŠ¶æ€ï¼ˆç™½åº•é»‘ç°å­—ï¼‰ */
    .tab-btn-ghost,
    .bottom-tab{
      background:#ffffff;
      color:#333333;
    }

    /* é€‰ä¸­çŠ¶æ€ï¼ˆçº¢åº•ç™½å­—ï¼‰ */
    .tab-btn-primary,
    .bottom-tab.active{
      border-color:#d62828;
      background:#d62828;
      color:#ffffff;
    }

    @media (min-width:768px){
      .page{ max-width:480px; margin:0 auto; }
      .tab-bar{ max-width:480px; margin:0 auto; left:50%; transform:translateX(-50%); }
    }

    /* ====== è§†é¢‘å…¨å±å±‚ ====== */
    .video-overlay{
      position:fixed;
      inset:0;
      z-index:1200;
      background:#000;
      display:none;
      align-items:center;
      justify-content:center;
    }
    .video-overlay.show{
      display:flex;
    }

    /* ====== è·¯çº¿å‰–é¢å›¾ï¼šé¡¶éƒ¨ 1/4 åŠé€æ˜æ‚¬æµ®å±‚ ====== */
    .elev-panel{
      position:absolute;
      left:8px;
      right:8px;
      top:0;
      height:25%;
      max-height:180px;
      background:rgba(0,0,0,0.55);
      border-radius:0 0 12px 12px;
      padding:6px 10px 10px;
      z-index:820;
      display:none;
      backdrop-filter:blur(6px);
      -webkit-backdrop-filter:blur(6px);
    }
    .elev-panel-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:4px;
      color:#fff;
      font-size:11px;
    }
    .elev-panel-title{
      font-weight:500;
    }
    .elev-panel-close{
      font-size:16px;
      line-height:1;
      padding:2px 6px;
      display:none;   /* éšè—å³ä¸Šè§’å° X */
    }
    #elevCanvas{
      width:100%;
      height:100%;
      display:block;
    }

    /* å‰–é¢äº¤äº’æ ‡ç­¾ */
    .elev-tooltip{
      position:absolute;
      padding:4px 8px;
      background:#ffffff;
      color:#e10e0e;
      border-radius:8px;
      font-size:11px;
      line-height:1.4;
      box-shadow:0 2px 6px rgba(217, 4, 4, 0.35);
      top:8px;
      left:40px;
      pointer-events:auto;
      white-space:nowrap;
    }
    .elev-tooltip-label{
      color:#222;
    }
    .elev-tooltip-value{
      color:#b20000;
      font-weight:600;
    }

    /* è§†é¢‘å®¹å™¨å æ»¡ */
    .video-container{
      position:relative;
      width:100%;
      height:100%;
      padding:0;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    #routeVideo{
      width:100%;
      height:100%;
      object-fit:cover;
      background:#000;
    }

    .video-controls{
      position:absolute;
      left:50%;
      bottom:30px;
      transform:translateX(-50%);
      display:flex;
      align-items:center;
      gap:15px;
      padding:6px 12px;
      border-radius:999px;
      background:rgba(0,0,0,0.35);
      backdrop-filter:blur(10px);
      -webkit-backdrop-filter:blur(10px);
    }
    .video-btn-icon{
      width:30px;
      height:30px;
      border-radius:15px;
      border:none;
      background:transparent;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
    }
    .video-btn-icon:active{
      transform:scale(0.95);
    }
    .icon-shape{
      position:relative;
      display:block;
    }
    .icon-back{
      width:0;
      height:0;
      border-top:6px solid transparent;
      border-bottom:6px solid transparent;
      border-right:8px solid #fff;
    }
    .icon-back::before{
      content:"";
      position:absolute;
      left:-9px;
      top:-6px;
      width:0;
      height:0;
      border-top:6px solid transparent;
      border-bottom:6px solid transparent;
      border-right:8px solid #fff;
    }
    .icon-play{
      width:0;
      height:0;
      border-top:7px solid transparent;
      border-bottom:7px solid transparent;
      border-left:11px solid #fff;
      margin-left:2px;
    }
    .icon-pause{
      width:11px;
      height:13px;
      display:flex;
      justify-content:space-between;
    }
    .icon-pause::before,
    .icon-pause::after{
      content:"";
      width:3px;
      height:100%;
      background:#fff;
      border-radius:999px;
    }
    .icon-forward{
      width:0;
      height:0;
      border-top:6px solid transparent;
      border-bottom:6px solid transparent;
      border-left:8px solid #fff;
    }
    .icon-forward::before{
      content:"";
      position:absolute;
      right:-9px;
      top:-6px;
      width:0;
      height:0;
      border-top:6px solid transparent;
      border-bottom:6px solid transparent;
      border-left:8px solid #fff;
    }
    .video-btn-speed{
      min-width:32px;
      height:32px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,0.85);
      color:#fff;
      font-size:11px;
      background:transparent;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
    }
    .video-btn-speed:active{
      transform:scale(0.95);
    }
    .video-btn-close{
      width:26px;
      height:26px;
      border-radius:6px;
      border:1px solid rgba(255,255,255,0.8);
      background:transparent;
      color:#fff;
      font-size:14px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
    }
    .video-btn-close:active{
      transform:scale(0.95);
    }

    html, body {
      touch-action: manipulation;
    }

   /* === æŠ½å±‰å†…å®¹å±‚ï¼ˆé»˜è®¤è—åœ¨åº•éƒ¨ï¼‰=== */
.scene-drawer-panel{
  position:absolute;
  left:8px;
  right:8px;
  bottom:0;
  height:38vh;               /* é»˜è®¤ï¼šçº¦ 1/3 å±å¹• */
  max-height:360px;
  background:rgba(0,0,0,0.45);
  backdrop-filter:blur(12px);
  -webkit-backdrop-filter:blur(12px);
  border-radius:16px 16px 0 0;
  box-shadow:0 -4px 16px rgba(0,0,0,0.25);
  transform:translateY(100%);
  transition:
    transform 0.28s cubic-bezier(.25,.8,.25,1),
    height 0.25s ease;       /* é«˜åº¦å˜åŒ–ä¹Ÿå¸¦åŠ¨ç”» */
  z-index:850;
  display:flex;
  flex-direction:column;
  padding:4px 8px 8px;
}

/* æŠ½å±‰â€œé«˜æ¡£ä½â€ï¼šçº¦ 2/3 å±å¹•é«˜åº¦ï¼Œé¡¶åˆ°å³ä¾§å›¾å±‚æŒ‰é’®ä¸‹é¢ */
.scene-drawer-panel.drawer-tall{
  height:66vh;
  max-height:520px;
}



/* æŠ½å±‰æ‰“å¼€çŠ¶æ€ */
.scene-drawer-panel.open{
  transform:translateY(0);
}
/* ===============================
 * æŠ½å±‰å¤´éƒ¨ï¼ˆé€Ÿåº¦ / æ‹‰æ‰‹ / æ—¶é—´ï¼‰
 * è¦æ±‚ï¼š
 * - é¢œè‰² = å¤©æ°”æ ï¼ˆä½†ç•¥æ·±ï¼‰
 * - å·¦å³ä¸ç•™ç™½ï¼Œå®Œå…¨è´´è¾¹
 * - ä¸Šåœ†è§’ï¼Œä¸‹ç›´è§’
 * - æ‹‰æ‰‹ä¸‰è§’ï¼šå…³ â–² / å¼€ â–¼ï¼Œç™½è‰²
 * =============================== */

.scene-drawer-header{
  position: relative;
  height: 32px;                              /* ç¨åŠ é«˜ï¼Œæ›´åƒç³»ç»Ÿæ  */
  display: flex;
  align-items: center;
  justify-content: center;

  /* ğŸ”´ å…³é”® 1ï¼šé¢œè‰² = å¤©æ°”æ ï¼Œä½†æ›´æ·± */
  background: rgba(32, 32, 32, 0.72);

  /* ğŸ”´ å…³é”® 2ï¼šå®Œå…¨è´´è¾¹ï¼Œä¸ç•™ç™½ */
  margin: 0;
  padding: 0;

  /* ğŸ”´ å…³é”® 3ï¼šä¸Šåœ†è§’ï¼Œä¸‹ç›´è§’ï¼ˆé•œåƒå¤©æ°”æ ï¼‰ */
  border-radius: 16px 16px 0 0;

  /* ğŸ”´ å…³é”® 4ï¼šåˆ†éš”çº¿å¼±åŒ– */
  border-bottom: 1px solid rgba(255,255,255,0.12);

  box-sizing: border-box;
}


/* å·¦ï¼šå½“å‰è¡Œè¿›é€Ÿåº¦ */
.scene-drawer-header-left,
.scene-drawer-header-right{
  flex: 1;
  font-size: 13px;                 /* ä¸å¤©æ°”æ æ–‡å­—ä¸€è‡´ */
  color: #ffffff;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding: 0 10px;                 /* å†…è¾¹è·ç»™æ–‡å­—ï¼Œä¸æ˜¯ç»™æ•´ä½“ç•™ç™½ */
}

.scene-drawer-header-left{
  text-align: left;
}

.scene-drawer-header-right{
  text-align: right;
}


/* ä¸­ï¼šæ‹‰æ‰‹åŒºåŸŸ */
.scene-drawer-header-center{
  width: 56px;
  display: flex;
  align-items: center;
  justify-content: center;
}


/* æ‹‰æ‰‹æŒ‰é’®ï¼ˆé¢œè‰²å¿…é¡»å’Œ header ä¸€è‡´ï¼‰ */
.scene-drawer-header-button{
  width: 56px;
  height: 26px;
  border-radius: 13px;
  background: rgba(32, 32, 32, 0.72);  /* ä¸ header å®Œå…¨åŒè‰² */
  border: none;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}


/* ç™½è‰²ä¸‰è§’å½¢ï¼ˆé»˜è®¤ï¼šå…³é—­çŠ¶æ€ï¼Œâ–² æœä¸Šï¼‰ */
.scene-drawer-header-arrow{
  width: 0;
  height: 0;
  border-left: 9px solid transparent;
  border-right: 9px solid transparent;
  border-bottom: 9px solid #ffffff;  /* â–² */
  transition: transform 0.2s ease;
}


/* æŠ½å±‰æ‰“å¼€åï¼šä¸‰è§’ç¿»è½¬ä¸º â–¼ */
.scene-drawer.open .scene-drawer-header-arrow{
  transform: rotate(180deg);         /* â–² â†’ â–¼ */
}


/* æŠ½å±‰å†…éƒ¨æ»šåŠ¨åŒºåŸŸï¼ˆåªæ»šè¡¨æ ¼ï¼Œä¸æ»šå¤´éƒ¨ï¼‰ */
.drawer-inner{
  flex:1 1 auto;                 /* è·ŸéšæŠ½å±‰é«˜åº¦è‡ªåŠ¨ä¼¸ç¼© */
  min-height:0;                  /* å…³é”®ï¼šå…è®¸å†…éƒ¨å†…å®¹åœ¨å‰©ä½™é«˜åº¦é‡Œæ»šåŠ¨ */
  overflow-y:auto;               /* è¶…å‡ºæ—¶æ»šåŠ¨ */
  padding:0 0 20px 0;
  -webkit-overflow-scrolling:touch;
  overscroll-behavior-y:contain;
}
/* ===============================
 * ğŸ”¥ å¼ºåˆ¶å»æ‰æŠ½å±‰å¤´éƒ¨å¤–å±‚ç•™ç™½ï¼ˆå…³é”®è¡¥ä¸ï¼‰
 * =============================== */

/* æŠ½å±‰æœ€å¤–å±‚ */
.scene-drawer-panel{
  padding: 0 !important;
  background: rgba(45, 45, 45, 0.9);

}

/* æŠ½å±‰å†…å®¹å®¹å™¨ï¼ˆå¸¸è§ç•™ç™½æ¥æºï¼‰ */
.scene-drawer,
.scene-drawer-wrap{
  padding-left: 0 !important;
  padding-right: 0 !important;
  margin-left: 0 !important;
  margin-right: 0 !important;
  width: 100% !important;
  box-sizing: border-box !important;
}

/* ===================================================
 * Drawer Scene List (stable v1) - manualScenes
 * =================================================== */
.drawer-scene-list{
  padding: 10px 10px 18px;
}
.drawer-scene-row{
  display:flex;
  align-items:stretch;
  gap:10px;
  padding:10px 8px;
  border-radius:14px;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.10);
  margin-bottom:10px;
  cursor:pointer;
}
.drawer-scene-row:hover{
  background: rgba(255,255,255,0.09);
}
.drawer-km-pill{
  flex:0 0 auto;
  min-width:58px;
  height:28px;
  border-radius:999px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
  font-size:12px;
  color:#0b0b0b;
  background: rgba(255,255,255,0.85);
}
.drawer-scene-main{
  flex:1 1 auto;
  min-width:0;
}
.drawer-scene-title{
  font-size:14px;
  font-weight:700;
  color: rgba(255,255,255,0.96);
  line-height:1.2;
}
.drawer-scene-desc{
  margin-top:4px;
  font-size:12px;
  color: rgba(255,255,255,0.66);
  line-height:1.2;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
.drawer-scene-metric{
  flex:0 0 92px;
  display:flex;
  flex-direction:column;
  justify-content:center;
  gap:6px;
}
.drawer-scene-bar{
  height:6px;
  border-radius:999px;
  background: rgba(255,255,255,0.20);
  overflow:hidden;
}
.drawer-scene-bar > div{
  height:100%;
  width:0%;
  border-radius:999px;
  background: rgba(255,255,255,0.85);
}
.drawer-scene-metric-text{
  font-size:11px;
  color: rgba(255,255,255,0.75);
  text-align:right;
  white-space:nowrap;
}
.drawer-scene-row.active{
  outline:2px solid rgba(255,255,255,0.35);
}



/* ===== åœºæ™¯ä¿¡æ¯æµè¡¨æ ¼ï¼ˆæ”¾åœ¨æŠ½å±‰é‡Œï¼‰ ===== */
.scene-flow{
  width:100%;
  font-size:13px;
  color:#f5f5f5;
}

/* é¡¶éƒ¨ï¼šå½“å‰é€Ÿåº¦ / å½“å‰åå·®æ—¶é—´ + ä¸­é—´ç®­å¤´ï¼Œæ–‡å­—ä¸é®ç›–ä¸‰è§’ */
.scene-flow-header{
  position:sticky;
  top:0;
  z-index:9999;

  background:rgba(0,0,0,0.45);
  backdrop-filter:blur(10px);

  display:flex;
  align-items:center;
  justify-content:space-between;

  padding:8px 12px;
}


/* è¡¨ä½“ */
.scene-flow-table{
  border-radius:6px;
  overflow:hidden;
}

/* æ¯ä¸€è¡Œ */
.scene-flow-row{
  display:flex;
  align-items:center;
  min-height:36px;        /* åŸæ¥æ˜¯ 30pxï¼Œ+20% */
  padding:4px 12px;       /* æ–°å¢è¿™ä¸€è¡Œï¼Œæ‹‰é«˜è¡Œè· */
  background:rgba(0,0,0,0.18);
  border-top:1px dotted rgba(255,255,255,0.2);
}


.scene-flow-row:first-child{
  border-top:none;
}
.scene-flow-row:nth-child(2n+1){
  background:rgba(0,0,0,0.26);
}

/* å½“å‰è¡Œï¼šæ•´è¡Œæµ…ç»¿åº• */
.scene-flow-row-current{
  background:#14a549;
}
/* å½“å‰åœºæ™¯å·¦ä¾§çº¢è‰²å°ä¸‰è§’æŒ‡é’ˆ */
.scene-flow-row-current::before{
  content:"";
  position:absolute;
  left:8px;                 /* è¶Šå°è¶Šé å·¦ï¼Œä½ è§‰å¾—è¿˜æƒ³å†é å·¦ï¼Œå¯æ”¹æˆ 6pxã€4px */
  top:50%;
  transform:translateY(-50%);
  width:0;
  height:0;
  border-top:6px solid transparent;
  border-bottom:6px solid transparent;
  border-left:8px solid #ff3b30;  /* çº¢è‰²å°ä¸‰è§’ï¼Œå°–å¤´å‘å³ */
}
.scene-flow-row-current .scene-flow-title{
  color:#ffffff;      /* æ¢å¤ç™½è‰² */
}


.scene-flow-cell{
  padding:4px 4px;
  display:flex;
  align-items:center;
  justify-content:flex-start;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* å·¦ä¾§è‰²å—è·ç¦»åˆ—ï¼šè‰²å—åªæ¯”æ–‡å­—ç•¥å®½ */
.scene-flow-cell-distance{
  width:54px;
  flex:0 0 54px;
  justify-content:center;
}
.scene-flow-distance{
  min-width:44px;
  padding:4px 6px;
  border-radius:6px;
  font-weight:600;
  font-size:12px;
  text-align:center;
  color:#ffffff;
}

.scene-flow-distance-green{  background:#00aa40; }
.scene-flow-distance-yellow{ background:#ffb400; }
.scene-flow-distance-orange{ background:#ff7a00; }
.scene-flow-distance-red{    background:#e02020; }

/* ä¸­é—´æ ‡é¢˜ + åœºæ™¯ç»„åˆ */
.scene-flow-cell-main{
  flex:1.9;
  flex-direction:column;
  align-items:flex-start;
  gap:2px;
}
.scene-flow-title{
  font-size:14px;
  font-weight:600;
  color:#ffffff;                  /* ä¸»æ–‡æ¡ˆæ”¹æˆäº®ç™½ */
}
.scene-flow-sub{
  font-size:12px;                 /* å‰¯æ–‡æ¡ˆç•¥å¤§ä¸€ç‚¹ */
  color:rgba(255,255,255,0.96);   /* æ›´äº®çš„ç™½å­— */
}
.scene-flow-sub-current {
    color: #ffffff !important;
}

.scene-flow-length-text-current {
    color: #ffffff !important;
}



/* å³ä¾§ï¼šè·ç¦»/æ—¶é—´ */
/* å³ä¾§ï¼šè¿›åº¦æ¡ + ä¸‹æ–¹æ•°å­— */
.scene-flow-cell-bar{
  width:64px;
  flex:0 0 64px;
  flex-direction:column;
  align-items:flex-end;
  justify-content:center;
  gap:3px;
}
.scene-flow-bar{
  width:100%;
  height:6px;
  border-radius:999px;
  background:rgba(255,255,255,0.28);
  overflow:hidden;
}
.scene-flow-bar-fill{
  height:100%;
  border-radius:999px;
  background:#00e676;
}
.scene-flow-length-text{
  font-size:13px;
  opacity:0.9;
  font-variant-numeric:tabular-nums;
}
/* å½“å‰åœºæ™¯å·¦ä¾§çº¢è‰²ä¸‰è§’æŒ‡é’ˆï¼ˆå°–å¤´å‘å³ï¼‰ */
.scene-flow-row-current{
  position:relative;
  background:#14a549;
  font-weight:600;
}

.scene-flow-row-current::before{
  content:"";
  position:absolute;
  left:4px;
  top:50%;
  transform:translateY(-50%);
  width:0;
  height:0;
  border-top:5px solid transparent;
  border-bottom:5px solid transparent;
  border-left:7px solid #ff3b30; /* â† æ­£ç¡®ï¼šå°–å¤´å‘å³ */
}
.elev-weather-text{
  position:absolute;        /* è®©å¤©æ°”æ ç»å¯¹å®šä½ï¼Œè„±ç¦»æ™®é€šæ–‡æµï¼Œè´´åœ¨æ‚¬æµ®çª—å†…éƒ¨ */
  left:0;                   /* å·¦è¾¹å¯¹é½æ‚¬æµ®çª— */
  right:0;                  /* å³è¾¹å¯¹é½æ‚¬æµ®çª— */
  bottom:6px;               /* â¬…ï¸ æ•´ä¸ªèƒŒæ™¯æ¡è·ç¦»æ‚¬æµ®çª—åº•éƒ¨çš„é«˜åº¦ï¼ˆè°ƒé«˜ä½ï¼‰ */

  /* â€”â€” å†…é—´è·ï¼ˆå†³å®šæ¡çš„é«˜åº¦ + æ–‡å­—ä¸Šä¸‹ä½ç½®ï¼‰ â€”â€” */
  padding:5px 12px 8px;     /* ä¸Šå†…è·5pxï¼Œä¸‹å†…è·8pxï¼Œä½¿æ–‡å­—ç•¥å¾®åä¸‹ã€æ›´å±…ä¸­ */

  /* â€”â€” æ–‡æœ¬è¡Œé«˜ï¼ˆæ§åˆ¶å›¾æ ‡+æ–‡å­—åœ¨ä¸€è¡Œä¸­çš„å‚ç›´å±…ä¸­ï¼‰ â€”â€” */
  line-height:1.35;         /* Emoji åŸºçº¿åé«˜ï¼Œæ­¤å‚æ•°ç”¨æ¥è®©è§†è§‰å±…ä¸­ */

  /* â€”â€” æ–‡æœ¬æ˜¾ç¤º â€”â€” */
  text-align:center;        /* å±…ä¸­æ•´è¡Œæ–‡å­— */
  font-size:13px;           /* å­—ä½“å¤§å° */
  font-weight:600;          /* å­—é‡ï¼Œæé«˜å¯è¯»æ€§ */
  color:#ffffff;            /* ç™½è‰²æ–‡å­— */

  /* â€”â€” æ–‡æœ¬æº¢å‡ºå¤„ç† â€”â€” */
  white-space:nowrap;       /* ä¸æ¢è¡Œ */
  overflow:hidden;          /* è¶…å‡ºè£å‰ª */
  text-overflow:ellipsis;   /* è¶…å‡ºæ˜¾ç¤ºçœç•¥å·ï¼ˆæ­£å¸¸ç”¨ä¸åˆ°ï¼‰ */

  /* â€”â€” èƒŒæ™¯æ ·å¼ â€”â€” */
  background:rgba(0,0,0,0.18);  /* åŠé€æ˜èƒŒæ™¯ï¼Œå¢å¼ºå¯¹æ¯”åº¦ */
  border-radius:0 0 18px 18px;  /* ä¸‹åœ†è§’ä¸æ‚¬æµ®çª—ä¿æŒä¸€è‡´ */

  /* â€”â€” å›¾å±‚å’Œäº¤äº’ â€”â€” */
  z-index:999;              /* ä¿è¯å¤©æ°”æ æ˜¾ç¤ºåœ¨å‰–é¢å›¾ä¹‹ä¸Š */
  pointer-events:none;      /* ç¦æ­¢ç‚¹å‡»ï¼Œé¿å…æŒ¡ä½å‰–é¢å›¾çš„äº¤äº’ */
  
  /* â­â­â­ å…³é”®ï¼šè®©â€œæ•´è¡Œæ–‡å­— + å›¾æ ‡â€å‘ä¸‹å¹³ç§»ä¸€ç‚¹ï¼ŒèƒŒæ™¯ä¸åŠ¨ â­â­â­ */
  transform: translateY(2px);  /* â¬…ï¸ è°ƒè¿™ä¸ªå°±èƒ½è®©æ•´è¡Œå†…å®¹å¾€ä¸‹ç§»åŠ¨ï¼ˆä½ è¦çš„æ•ˆæœï¼‰ */
}






  </style>

<!-- === LEGACY DRAWER CSS (FROM route_restored_old_ui.html) === -->
<style>
/* === åº•éƒ¨åœºæ™¯æŠ½å±‰å°æŒ‰é’®ï¼ˆç°è‰²ä¸Šæ‹‰ï¼‰ === */
    .scene-drawer-handle{
      position:absolute;
      left:50%;
      bottom:60px; /* åœ¨åº•éƒ¨ Tab æ ä¸Šæ–¹ä¸€ç‚¹ */
      transform:translateX(-50%);
      z-index:840;
    }


    /* åº•éƒ¨æŠ½å±‰æ‰‹æŸ„æŒ‰é’®ï¼ˆä¸Šæ‹‰ï¼‰ */
    .scene-drawer-button{
      width:90px;
      height:30px;
      border-radius:12px;
      background:rgba(40,40,40,0.32);
      box-shadow:0 2px 8px rgba(0,0,0,0.25);
      backdrop-filter:blur(8px);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition:background 0.2s;
    }


    /* é»˜è®¤ï¼šç™½è‰²å‘ä¸Šçš„å°ç®­å¤´ */
    .scene-drawer-arrow{
      width:0;
      height:0;
      border-left:7px solid transparent;
      border-right:7px solid transparent;
      border-bottom:9px solid #ffffff;
    }


    /* å½“æŸä¸ªèŠ‚ç‚¹æœ‰åœºæ™¯ä¿¡æ¯æµæ—¶ï¼šåº•éƒ¨æ‰‹æŸ„ç®­å¤´å˜çº¢ */
    .scene-drawer-handle--active .scene-drawer-arrow{
      border-bottom-color:#d62828;
    }


   /* === æŠ½å±‰å†…å®¹å±‚ï¼ˆé»˜è®¤è—åœ¨åº•éƒ¨ï¼‰=== */
.scene-drawer-panel{
  position:absolute;
  left:8px;
  right:8px;
  bottom:0;
  height:38vh;               /* é»˜è®¤ï¼šçº¦ 1/3 å±å¹• */
  max-height:360px;
  background:rgba(0,0,0,0.45);
  backdrop-filter:blur(12px);
  -webkit-backdrop-filter:blur(12px);
  border-radius:16px 16px 0 0;
  box-shadow:0 -4px 16px rgba(0,0,0,0.25);
  transform:translateY(100%);
  transition:
    transform 0.28s cubic-bezier(.25,.8,.25,1),
    height 0.25s ease;       /* é«˜åº¦å˜åŒ–ä¹Ÿå¸¦åŠ¨ç”» */
  z-index:850;
  display:flex;
  flex-direction:column;
  padding:4px 8px 8px;
}


/* æŠ½å±‰â€œé«˜æ¡£ä½â€ï¼šçº¦ 2/3 å±å¹•é«˜åº¦ï¼Œé¡¶åˆ°å³ä¾§å›¾å±‚æŒ‰é’®ä¸‹é¢ */
.scene-drawer-panel.drawer-tall{
  height:66vh;
  max-height:520px;
}




/* æŠ½å±‰æ‰“å¼€çŠ¶æ€ */
.scene-drawer-panel.open{
  transform:translateY(0);
}


/* æŠ½å±‰å¤´éƒ¨ï¼šå·¦ é€Ÿåº¦ Â· ä¸­ ä¸‰è§’ Â· å³ åå·®æ—¶é—´ï¼ˆå›ºå®šä¸æ»šåŠ¨ï¼‰ */
.scene-drawer-header{
  position:relative;
  display:flex;
  align-items:center;
  padding:2px 10px 4px;                     /* æ–‡å­—å’Œç®­å¤´å†å¾€ä¸Šæä¸€ç‚¹ */
  border-bottom:1px solid rgba(255,255,255,0.15);
  background:transparent;                   /* ä¸å†å•ç‹¬ä¸€æ¡é»‘è‰²èƒŒæ™¯ï¼Œç»§æ‰¿æ¯›ç»ç’ƒ */
  z-index:2;
}



.scene-drawer-header-left,
.scene-drawer-header-right{
  flex:1;
  font-size:12px;           /* å­—å·æ”¾å¤§ä¸€å· */
  color:#ffffff;            /* çº¯ç™½ï¼Œæ›´äº® */
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}


.scene-drawer-header-left{ text-align:left; }

.scene-drawer-header-right{ text-align:right; }


/* ä¸­é—´å…³é—­å°ä¸‰è§’æŒ‰é’®ï¼ˆå–ä»£åŸæ¥çš„ .drawer-closeï¼‰ */
.scene-drawer-header-center{
  width:70px;
  display:flex;
  align-items:center;
  justify-content:center;
}

.scene-drawer-header-button{
  width:70px;
  height:24px;
  border-radius:12px;
  background:transparent;
  border:none;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:0;
}

.scene-drawer-header-arrow{
  width:0;
  height:0;
  border-left:8px solid transparent;
  border-right:8px solid transparent;
  border-top:8px solid #f5f5f5;
}






/* ===== åœºæ™¯ä¿¡æ¯æµè¡¨æ ¼ï¼ˆæ”¾åœ¨æŠ½å±‰é‡Œï¼‰ ===== */
.scene-flow{
  width:100%;
  font-size:13px;
  color:#f5f5f5;
}


/* é¡¶éƒ¨ï¼šå½“å‰é€Ÿåº¦ / å½“å‰åå·®æ—¶é—´ + ä¸­é—´ç®­å¤´ï¼Œæ–‡å­—ä¸é®ç›–ä¸‰è§’ */
.scene-flow-header{
  position:sticky;
  top:0;
  z-index:9999;

  background:rgba(0,0,0,0.45);
  backdrop-filter:blur(10px);

  display:flex;
  align-items:center;
  justify-content:space-between;

  padding:8px 12px;
}



/* è¡¨ä½“ */
.scene-flow-table{
  border-radius:6px;
  overflow:hidden;
}


/* æ¯ä¸€è¡Œ */
.scene-flow-row{
  display:flex;
  align-items:center;
  min-height:36px;        /* åŸæ¥æ˜¯ 30pxï¼Œ+20% */
  padding:4px 12px;       /* æ–°å¢è¿™ä¸€è¡Œï¼Œæ‹‰é«˜è¡Œè· */
  background:rgba(0,0,0,0.18);
  border-top:1px dotted rgba(255,255,255,0.2);
}



.scene-flow-row:first-child{
  border-top:none;
}

.scene-flow-row:nth-child(2n+1){
  background:rgba(0,0,0,0.26);
}


/* å½“å‰è¡Œï¼šæ•´è¡Œæµ…ç»¿åº• */
.scene-flow-row-current{
  background:#14a549;
}

/* å½“å‰åœºæ™¯å·¦ä¾§çº¢è‰²å°ä¸‰è§’æŒ‡é’ˆ */
.scene-flow-row-current::before{
  content:"";
  position:absolute;
  left:8px;                 /* è¶Šå°è¶Šé å·¦ï¼Œä½ è§‰å¾—è¿˜æƒ³å†é å·¦ï¼Œå¯æ”¹æˆ 6pxã€4px */
  top:50%;
  transform:translateY(-50%);
  width:0;
  height:0;
  border-top:6px solid transparent;
  border-bottom:6px solid transparent;
  border-left:8px solid #ff3b30;  /* çº¢è‰²å°ä¸‰è§’ï¼Œå°–å¤´å‘å³ */
}

.scene-flow-row-current .scene-flow-title{
  color:#ffffff;      /* æ¢å¤ç™½è‰² */
}



.scene-flow-cell{
  padding:4px 4px;
  display:flex;
  align-items:center;
  justify-content:flex-start;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}


/* å·¦ä¾§è‰²å—è·ç¦»åˆ—ï¼šè‰²å—åªæ¯”æ–‡å­—ç•¥å®½ */
.scene-flow-cell-distance{
  width:54px;
  flex:0 0 54px;
  justify-content:center;
}

.scene-flow-distance{
  min-width:44px;
  padding:4px 6px;
  border-radius:6px;
  font-weight:600;
  font-size:12px;
  text-align:center;
  color:#ffffff;
}


.scene-flow-distance-green{  background:#00aa40; }

.scene-flow-distance-yellow{ background:#ffb400; }

.scene-flow-distance-orange{ background:#ff7a00; }

.scene-flow-distance-red{    background:#e02020; }


/* ä¸­é—´æ ‡é¢˜ + åœºæ™¯ç»„åˆ */
.scene-flow-cell-main{
  flex:1.9;
  flex-direction:column;
  align-items:flex-start;
  gap:2px;
}

.scene-flow-title{
  font-size:14px;
  font-weight:600;
  color:#ffffff;                  /* ä¸»æ–‡æ¡ˆæ”¹æˆäº®ç™½ */
}

.scene-flow-sub{
  font-size:12px;                 /* å‰¯æ–‡æ¡ˆç•¥å¤§ä¸€ç‚¹ */
  color:rgba(255,255,255,0.96);   /* æ›´äº®çš„ç™½å­— */
}

.scene-flow-sub-current {
    color: #ffffff !important;
}


.scene-flow-length-text-current {
    color: #ffffff !important;
}




/* å³ä¾§ï¼šè·ç¦»/æ—¶é—´ */
/* å³ä¾§ï¼šè¿›åº¦æ¡ + ä¸‹æ–¹æ•°å­— */
.scene-flow-cell-bar{
  width:64px;
  flex:0 0 64px;
  flex-direction:column;
  align-items:flex-end;
  justify-content:center;
  gap:3px;
}

.scene-flow-bar{
  width:100%;
  height:6px;
  border-radius:999px;
  background:rgba(255,255,255,0.28);
  overflow:hidden;
}

.scene-flow-bar-fill{
  height:100%;
  border-radius:999px;
  background:#00e676;
}

.scene-flow-length-text{
  font-size:13px;
  opacity:0.9;
  font-variant-numeric:tabular-nums;
}

/* å½“å‰åœºæ™¯å·¦ä¾§çº¢è‰²ä¸‰è§’æŒ‡é’ˆï¼ˆå°–å¤´å‘å³ï¼‰ */
.scene-flow-row-current{
  position:relative;
  background:#14a549;
  font-weight:600;
}


.scene-flow-row-current::before{
  content:"";
  position:absolute;
  left:4px;
  top:50%;
  transform:translateY(-50%);
  width:0;
  height:0;
  border-top:5px solid transparent;
  border-bottom:5px solid transparent;
  border-left:7px solid #ff3b30; /* â† æ­£ç¡®ï¼šå°–å¤´å‘å³ */
}
/* ===== Legacy drawer: disable blur ===== */
.scene-drawer-panel,
.scene-drawer-header{
  backdrop-filter:none !important;
  -webkit-backdrop-filter:none !important;
}

/* ===== Legacy drawer handle size ===== */
.scene-drawer-button{
  width:90px !important;
  height:30px !important;
  border-radius:15px !important;
}

</style>

<style>

/* ===============================
   LEGACY DRAWER FULL RESTORE CSS
   =============================== */

/* Base drawer shell */
.scene-drawer-panel{
  background: #0f0f0f !important;
  border-radius: 18px 18px 0 0 !important;
  box-shadow: 0 -6px 24px rgba(0,0,0,.45) !important;
  backdrop-filter: none !important;
  -webkit-backdrop-filter: none !important;
}

/* Header */
.scene-drawer-header{
  display:flex !important;
  align-items:center !important;
  justify-content:space-between !important;
  padding: 12px 14px 10px !important;
  border-bottom: 1px solid rgba(255,255,255,.08) !important;
  background:#121212 !important;
}

/* Header text */
.scene-drawer-header-left,
.scene-drawer-header-right{
  font-size:13px !important;
  color:#e5e5e5 !important;
  white-space:nowrap;
}

/* Center arrow */
.scene-drawer-header-center{
  flex:0 0 auto !important;
}
.scene-drawer-header-arrow{
  width:18px !important;
  height:18px !important;
  border-left:2px solid #aaa !important;
  border-bottom:2px solid #aaa !important;
  transform: rotate(135deg) !important;
}

/* Handle */
.scene-drawer-button{
  width:90px !important;
  height:30px !important;
  border-radius:15px !important;
  background:rgba(255,255,255,.12) !important;
  color:#fff !important;
  font-size:14px !important;
  margin:6px auto 8px !important;
}

/* Drawer inner */
.drawer-inner,
.legacy-drawer-inner{
  padding: 6px 0 14px !important;
  background:#0f0f0f !important;
}

/* Scene flow table */
.scene-flow{
  padding: 4px 10px 12px !important;
}
.scene-flow-table{
  display:flex;
  flex-direction:column;
  gap:6px;
}

/* Row */
.scene-flow-row{
  display:flex;
  align-items:center;
  background:#161616 !important;
  border-radius:12px !important;
  padding:10px 10px !important;
}

/* Distance pill */
.scene-flow-distance{
  display:inline-block;
  min-width:46px;
  text-align:center;
  padding:4px 8px;
  border-radius:999px;
  font-size:12px;
  font-weight:600;
}
.scene-flow-distance-green{
  background:#22c55e !important;
  color:#083a1e !important;
}

/* Main text */
.scene-flow-title{
  font-size:14px !important;
  color:#f1f1f1 !important;
  margin-bottom:2px;
}
.scene-flow-sub{
  font-size:12px !important;
  color:#a1a1a1 !important;
}

/* Bar */
.scene-flow-cell-bar{
  margin-left:auto;
  text-align:right;
}
.scene-flow-bar-bg{
  width:72px;
  height:6px;
  background:#2a2a2a;
  border-radius:6px;
  overflow:hidden;
  margin-bottom:2px;
}
.scene-flow-bar-fill{
  height:100%;
  background:#22c55e;
}
.scene-flow-bar-label{
  font-size:11px;
  color:#9ca3af;
}

/* Current row highlight */
.scene-flow-row-current{
  background:#1f2937 !important;
  outline:1px solid rgba(34,197,94,.6);
}

</style>
<style>

/* ===== LEGACY STRUCTURE FIX ===== */

/* Remove any extra vertical gaps */
.scene-drawer-panel > * + *{
  margin-top: 0 !important;
}

/* Header sticks directly to list */
.scene-drawer-header{
  margin-bottom: 0 !important;
}

/* Drawer inner starts immediately */
.drawer-inner,
.legacy-drawer-inner{
  padding-top: 6px !important;
}

/* Kill any hidden stat remnants */
.scene-drawer-stats,
.scene-drawer-stat,
.scene-drawer-metrics{
  display:none !important;
}

</style>
<style>

/* =========================================================
   LEGACY DRAWER â€” MATCH ORIGINAL (profile-aligned)
   Goal: tighter side edges, subtle row contrast, left column
         reserved for red triangle, consistent with top profile.
   ========================================================= */

/* Panel: same family as profile card (semi-transparent, no blur) */
.scene-drawer-panel{
  background: rgba(92, 92, 92, 0.58) !important;
  border-radius: 16px 16px 0 0 !important;
  box-shadow: 0 -10px 28px rgba(0,0,0,.30) !important;
}

/* Header bar: thin, consistent, minimal side padding */
.scene-drawer-header{
  background: rgba(95, 95, 95, 0.62) !important;
  border-bottom: 1px solid rgba(255,255,255,0.10) !important;
  padding: 10px 10px !important; /* less edge space */
}

/* Inner: tighter edges like original */
.drawer-inner,
.legacy-drawer-inner{
  padding: 8px 8px 14px !important;
  background: transparent !important;
}

/* Scene flow: remove extra padding */
.scene-flow{
  padding: 0 !important;
}

/* Row: subtle contrast per-row, not heavy "cards" */
.scene-flow-row{
  background: rgba(45, 45, 45, 0.35) !important;
  border-radius: 10px !important;
  padding: 10px 10px !important;
  margin: 0 0 8px 0 !important;
  border: 1px solid rgba(255,255,255,0.06) !important;
}

/* Alternate rows to create gentle "è‰²å·®" */
.scene-flow-row:nth-child(even){
  background: rgba(55, 55, 55, 0.32) !important;
}
.scene-flow-row:nth-child(odd){
  background: rgba(40, 40, 40, 0.30) !important;
}

/* Left column: reserve space for red triangle */
.scene-flow-cell-distance{
  flex: 0 0 78px !important;
  width: 78px !important;
  position: relative !important;
  padding-left: 14px !important;  /* triangle slot */
}

/* Red triangle indicator for "current" row */
.scene-flow-row-current .scene-flow-cell-distance::before{
  content:"";
  position:absolute;
  left: 2px;
  top: 50%;
  transform: translateY(-50%);
  width: 0;
  height: 0;
  border-top: 6px solid transparent;
  border-bottom: 6px solid transparent;
  border-left: 8px solid #ef4444;
}

/* Distance pill: keep bold, centered */
.scene-flow-distance{
  min-width: 52px !important;
  padding: 6px 10px !important;
  font-size: 12px !important;
  font-weight: 700 !important;
  border-radius: 12px !important;
}

/* Title/subtitle typography closer to original */
.scene-flow-title{
  color: rgba(255,255,255,0.92) !important;
  font-size: 15px !important;
  font-weight: 650 !important;
  line-height: 1.1 !important;
}
.scene-flow-sub{
  color: rgba(255,255,255,0.70) !important;
  font-size: 12px !important;
  margin-top: 3px !important;
}

/* Right bar: slimmer + lighter like original */
.scene-flow-cell-bar{
  flex: 0 0 92px !important;
}
.scene-flow-bar-bg{
  width: 82px !important;
  height: 6px !important;
  background: rgba(255,255,255,0.22) !important;
  border-radius: 999px !important;
}
.scene-flow-bar-fill{
  background: rgba(125, 211, 165, 0.75) !important;
  height: 100% !important;
  border-radius: 999px !important;
}
.scene-flow-bar-label{
  color: rgba(255,255,255,0.72) !important;
  font-size: 12px !important;
  margin-top: 4px !important;
}

/* Current row: slightly stronger tint (but still subtle) */
.scene-flow-row-current{
  background: rgba(24, 90, 58, 0.38) !important;
  border-color: rgba(255,255,255,0.08) !important;
  outline: none !important;
}


/* ================= FINAL LEGACY DRAWER POLISH ================= */

/* --- Drawer handle: inverted white triangle --- */
.scene-drawer-handle{
  width:0 !important;
  height:0 !important;
  border-left:7px solid transparent !important;
  border-right:7px solid transparent !important;
  border-top:9px solid rgba(255,255,255,0.95) !important;
  background:none !important;
  box-shadow:none !important;
  margin:4px auto 2px !important;
}

/* --- Header (speed/time): compact, dark, rounded --- */
.scene-drawer-header{
  background: rgba(35,35,35,0.78) !important;
  border: 1px solid rgba(0,0,0,0.55) !important;
  border-radius: 14px !important;
  padding: 6px 10px !important;
}
.scene-drawer-header,
.scene-drawer-header span{
  font-size: 13px !important;
  color: rgba(255,255,255,0.9) !important;
}

/* --- Drawer panel overall --- */
.scene-drawer-panel{
  background: rgba(70,70,70,0.46) !important;
  border-radius: 16px 16px 0 0 !important;
  box-shadow: 0 -8px 22px rgba(0,0,0,0.25) !important;
}

/* --- Inner padding: tighter sides --- */
.drawer-inner,
.legacy-drawer-inner{
  padding: 6px 6px 10px !important;
}

/* --- Row: lower height, subtle contrast --- */
.scene-flow-row{
  background: rgba(28,28,28,0.30) !important;
  border-radius: 10px !important;
  padding: 6px 8px !important;
  margin: 0 0 6px 0 !important;
  border: 1px solid rgba(255,255,255,0.06) !important;
}
.scene-flow-row:nth-child(even){
  background: rgba(38,38,38,0.28) !important;
}

/* --- Left column: reserve triangle space, reduce width --- */
.scene-flow-cell-distance{
  flex: 0 0 70px !important;
  width: 70px !important;
  padding-left: 14px !important;
  position: relative !important;
}

/* --- Current row triangle --- */
.scene-flow-row-current .scene-flow-cell-distance::before{
  content:"";
  position:absolute;
  left:2px;
  top:50%;
  transform:translateY(-50%);
  width:0;
  height:0;
  border-top:5px solid transparent;
  border-bottom:5px solid transparent;
  border-left:7px solid #ef4444;
}

/* --- Distance pill: grass green + white text --- */
.scene-flow-distance{
  background: #34d399 !important;   /* grass green */
  color: #ffffff !important;
  min-width: 50px !important;
  padding: 5px 8px !important;
  font-size: 12px !important;
  font-weight: 700 !important;
  border-radius: 12px !important;
}

/* --- Title & subtitle tighter --- */
.scene-flow-title{
  color: rgba(255,255,255,0.92) !important;
  font-size: 14px !important;
  font-weight: 650 !important;
  line-height: 1.1 !important;
}
.scene-flow-sub{
  color: rgba(255,255,255,0.72) !important;
  font-size: 11.5px !important;
  margin-top: 2px !important;
}

/* --- Right bar: slimmer, same green tone --- */
.scene-flow-cell-bar{
  flex: 0 0 86px !important;
}
.scene-flow-bar-bg{
  width: 78px !important;
  height: 5px !important;
  background: rgba(255,255,255,0.22) !important;
  border-radius: 999px !important;
}
.scene-flow-bar-fill{
  background: #34d399 !important;   /* same grass green */
  height: 100% !important;
  border-radius: 999px !important;
}
.scene-flow-bar-label{
  color: rgba(255,255,255,0.75) !important;
  font-size: 11.5px !important;
  margin-top: 3px !important;
}

/* --- Current row: slightly stronger green tint --- */
.scene-flow-row-current{
  background: rgba(16,110,72,0.38) !important;
}


/* ================= FINAL MIRROR POLISH (WEATHER â†” DRAWER) ================= */

/* === Mirror header to weather bar (same tone, same font, same radius logic) === */
.scene-drawer-header{
  background: rgba(95,95,95,0.55) !important;   /* match weather bar */
  border: none !important;
  border-radius: 18px 18px 0 0 !important;      /* top round, bottom straight */
  padding: 8px 14px !important;
}
.scene-drawer-header,
.scene-drawer-header span{
  font-size: 14px !important;                   /* same as weather */
  font-weight: 500 !important;
  color: rgba(255,255,255,0.92) !important;
}

/* === Drawer handle: inverted white triangle, same size as weather arrow === */
.scene-drawer-handle{
  width:0 !important;
  height:0 !important;
  border-left:9px solid transparent !important;
  border-right:9px solid transparent !important;
  border-top:11px solid rgba(255,255,255,0.95) !important;
  background:none !important;
  box-shadow:none !important;
  margin:6px auto 4px !important;
}

/* === Drawer panel body: same background family as elevation card === */
.scene-drawer-panel{
  background: rgba(90,90,90,0.55) !important;
  border-radius: 18px 18px 0 0 !important;
  box-shadow: none !important;
}

/* === Inner padding: tighter sides === */
.drawer-inner,
.legacy-drawer-inner{
  padding: 6px 6px 8px !important;
}

/* === Scene rows: darker, closer to elevation bg === */
.scene-flow-row{
  background: rgba(70,70,70,0.55) !important;
  border-radius: 12px !important;
  padding: 8px 10px !important;
  margin: 0 0 4px 0 !important;
  border: none !important;
}

/* === Left column: narrower, triangle closer === */
.scene-flow-cell-distance{
  flex: 0 0 64px !important;
  width: 64px !important;
  padding-left: 12px !important;
  position: relative !important;
}

/* Red triangle indicator */
.scene-flow-row-current .scene-flow-cell-distance::before{
  content:"";
  position:absolute;
  left:2px;
  top:50%;
  transform:translateY(-50%);
  border-top:6px solid transparent;
  border-bottom:6px solid transparent;
  border-left:8px solid #ff3b30; /* iOS red */
}

/* === Distance pill: Apple system green, less round, forward === */
.scene-flow-distance{
  background: #34C759 !important;     /* iOS system green */
  color: #ffffff !important;
  min-width: 48px !important;
  padding: 6px 8px !important;
  font-size: 13px !important;
  font-weight: 600 !important;
  border-radius: 8px !important;
  margin-left: -4px !important;
}

/* === Text sizing === */
.scene-flow-title{
  font-size: 14px !important;
  font-weight: 600 !important;
  color: rgba(255,255,255,0.95) !important;
}
.scene-flow-sub{
  font-size: 12px !important;
  color: rgba(255,255,255,0.80) !important;
  margin-top: 2px !important;
}

/* === Progress bar: same system green === */
.scene-flow-cell-bar{
  flex: 0 0 84px !important;
}
.scene-flow-bar-bg{
  width: 76px !important;
  height: 6px !important;
  background: rgba(255,255,255,0.25) !important;
}
.scene-flow-bar-fill{
  background: #34C759 !important;
}
.scene-flow-bar-label{
  font-size: 12px !important;
  color: rgba(255,255,255,0.85) !important;
}

/* === Current row emphasis === */
.scene-flow-row-current{
  background: rgba(60,120,90,0.65) !important;
}


/* ================= HANDLE + HEADER FINAL FIX ================= */

/* ===== Collapsed (before open): upward white triangle on weather-tone bar ===== */
.scene-drawer-collapsed{
  background: rgba(95,95,95,0.55) !important; /* same as weather bar */
  border-radius: 18px !important;
}
.scene-drawer-collapsed .scene-drawer-handle{
  width:0 !important;
  height:0 !important;
  border-left:11px solid transparent !important;
  border-right:11px solid transparent !important;
  border-bottom:13px solid rgba(255,255,255,0.95) !important; /* upward */
  border-top:none !important;
  margin:8px auto !important;
}

/* ================================
 * @deprecated
 * OLD scene-drawer-header styling
 * DO NOT USE â€“ kept for rollback only
 * ================================ */

/*
.scene-drawer-header{
  background: rgba(95,95,95,0.55) !important;
  border-radius: 18px 18px 0 0 !important;
  padding: 8px 14px !important;
}

.scene-drawer-header .scene-drawer-handle{
  width:0 !important;
  height:0 !important;
  border-left:11px solid transparent !important;
  border-right:11px solid transparent !important;
  border-top:13px solid rgba(255,255,255,0.95) !important;
  border-bottom:none !important;
  margin:6px auto 4px !important;
}

.scene-drawer-header,
.scene-drawer-header span{
  font-size:14px !important;
  font-weight:500 !important;
  color:rgba(255,255,255,0.92) !important;
}
*/

</style>
</head>

<body>
<div class="page">

  <div class="map-wrapper">
    <div id="map"></div>

          <!-- === æŠ½å±‰å†…å®¹å±‚ï¼ˆåŠé€æ˜ + è¦†ç›–åœ°å›¾ 1/3ï¼‰=== -->
    <div class="scene-drawer-panel" id="sceneDrawerPanel">
  <div class="scene-drawer-header">
    <div class="scene-drawer-header-left" id="sceneSpeedDisplay" data-pace-min-per-km="" data-mode="pace">å½“å‰è¡Œè¿›é€Ÿåº¦ï¼š--/km</div>
    <div class="scene-drawer-header-center"><button class="scene-drawer-header-button" id="sceneDrawerClose"><span class="scene-drawer-header-arrow"></span></button></div>
    <div class="scene-drawer-header-right" id="sceneTimeDeviation">å½“å‰åå·®æ—¶é—´ï¼š--</div>
  </div>
<!-- LEGACY STRUCTURE: header + list only -->

  <div class="drawer-inner legacy-drawer-inner" id="dynamicDrawerContent">
    <div style="text-align:center; color:rgba(255,255,255,0.4); padding-top:40px; font-size:13px;">ç­‰å¾…è¡Œèµ°æ•°æ®...</div>
  </div>
</div>






    <div class="stats-card" id="statsCard">
      é‡Œç¨‹ï¼š<strong id="statDistance">-- / -- km</strong><br/>
      æµ·æ‹”ï¼š<strong id="statAlt">-- / -- m</strong><br/>
      å¤©æ°”ï¼š<strong id="statWeather">--</strong><br/>
      <!-- é«˜å·®æš‚æ—¶éšè— -->
      <span class="stat-gain-line" style="display:none;">
        é«˜å·®ï¼š<strong id="statGain">-- / -- m</strong>
      </span>
    </div>

    <!-- é¡¶éƒ¨ 1/4 åŠé€æ˜è·¯çº¿å‰–é¢å›¾ -->
    <div class="elev-panel" id="elevPanel">
      <div class="elev-panel-header">
        <div class="elev-panel-title" id="elevTitle"></div>
        <div class="elev-panel-close" id="elevClose">âœ•</div>
      </div>

      <canvas id="elevCanvas"></canvas>
<!-- å¤©æ°”æ ï¼šåŠ¨æ€å†™å…¥å¤©æ°”æ•°æ® -->
<div class="elev-weather-text" id="elevWeatherText"></div>


      <!-- å‰–é¢å°åœ†ç‚¹æ ‡ç­¾ -->
      <div class="elev-tooltip" id="elevTooltip" style="display:none;">
        é‡Œç¨‹ 0 km<br>æµ·æ‹” 0 m<br>å¡åº¦ 0%
      </div>
    </div>

    <div class="map-tools">
      <button class="tool-btn north-btn" id="btnNorth">
        <span class="north-arrow">â–²</span>
        <span class="north-label">N</span>
      </button>

      <button class="tool-btn" id="btnLayerToggle">SAT</button>

      <!-- èŠ‚ç‚¹å›¾å±‚å¼€å…³æŒ‰é’® -->
      <button class="tool-btn" id="btnNodeToggle">
        <span class="icon-layerstack">
          <span class="layer"></span>
          <span class="layer"></span>
          <span class="layer"></span>
        </span>
      </button>
    </div>

    <div class="map-tools-bottom">
      <button class="tool-round" id="btnCache" title="ç¼“å­˜å½“å‰è§†é‡åœ°å›¾">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
             stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 5v14m0 0l-6-6m6 6l6-6"/>
          <path d="M5 19h14"/>
        </svg>
      </button>

      <button class="tool-round" id="btnPlay" title="æ’­æ”¾è·¯çº¿è®²è§£">
        <svg viewBox="0 0 24 24"
             fill="none"
             stroke="currentColor"
             stroke-width="2"
             stroke-linecap="round"
             stroke-linejoin="round">
          <polygon points="7 5 19 12 7 19 7 5"></polygon>
        </svg>
      </button>

      <button class="tool-round" id="btnLocateRoute" title="å®šä½åˆ°å½“å‰ä½ç½®">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
             stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="3"></circle>
          <path d="M12 2v3"></path>
          <path d="M12 19v3"></path>
          <path d="M5 12H2"></path>
          <path d="M22 12h-3"></path>
        </svg>
      </button>
    </div>

    <div class="cache-status" id="cacheStatus">çŠ¶æ€</div>

    <!-- åº•éƒ¨åœºæ™¯æŠ½å±‰å°æŒ‰é’® -->
    <div class="scene-drawer-handle" id="sceneDrawerHandle">
      <div class="scene-drawer-button">
        <span class="scene-drawer-arrow"></span>
      </div>
    </div>
  </div>

  <!-- å…¨å±è§†é¢‘å±‚ -->
  <div class="video-overlay" id="videoOverlay">
    <div class="video-container">
      <video
        id="routeVideo"
        src="assets/video/intro.mp4"
        playsinline
        webkit-playsinline
      ></video>

      <div class="video-controls" id="videoControls">
        <button class="video-btn-icon" id="videoBtnBack">
          <span class="icon-shape icon-back"></span>
        </button>

        <button class="video-btn-icon" id="videoBtnPlayPause">
          <span class="icon-shape icon-play" id="iconPlayPause"></span>
        </button>

        <button class="video-btn-icon" id="videoBtnForward">
          <span class="icon-shape icon-forward"></span>
        </button>

        <button class="video-btn-speed" id="videoBtnSpeed">
          <span id="videoSpeedLabel">1.0</span>
        </button>

        <button class="video-btn-close" id="videoBtnClose">âœ•</button>
      </div>
    </div>
  </div>

  <div class="tab-bar">
    <button class="tab-btn tab-btn-ghost"  data-href="pretrip.html">è¡Œå‰å‡†å¤‡</button>
    <button class="tab-btn tab-btn-primary" data-href="route.html">å¾’æ­¥å‘å¯¼</button>
    <button class="tab-btn tab-btn-ghost"  data-href="guide.html">å¸¦è·¯å®å…¸</button>
  </div>
</div>

<script>
  console.log("ğŸ”¥ JS START");

  /* ============================================================
 * â‘  è¯»å– URL å‚æ•°ä¸­æä¾›çš„ JSONï¼Œå¹¶åŠ è½½æˆä¸ºè·¯çº¿æ¨¡å‹
 * ç”¨æ³•ç¤ºä¾‹ï¼š
 * route.html?json=ROUTE_NODES.json
 * ============================================================ */
async function loadRouteModel() {
const jsonUrl = "routes/route_chino/track.json";

  try {
    const res = await fetch(jsonUrl);
    if (!res.ok) throw new Error("æ— æ³•åŠ è½½ JSONï¼š" + jsonUrl);
    const model = await res.json();
    console.log("âœ… æˆåŠŸåŠ è½½è·¯çº¿ JSONï¼š", jsonUrl);
    return model;
  } catch (err) {
    console.error(err);
    return null;
  }
}

  // ç¦ç”¨é•¿æŒ‰å¼¹å‡ºæµè§ˆå™¨é»˜è®¤èœå•ï¼ˆå¦‚ Copy / Find Selection / åŠ å¤§å¤´é’ˆï¼‰
  document.addEventListener("contextmenu", function(e){
    e.preventDefault();
  }, { passive:false });

  (async function(){
     window.routeLatLngs = [];
  console.log("ğŸ”¥ init routeLatLngs");

  // ===== å¼ºåˆ¶æ¸…ç©ºå·¦ä¸Šè§’å¡ç‰‡ï¼ˆåˆ‡æ–­ HTML æ¼”ç¤ºå€¼ï¼‰====
    const cfgHome = (window.ROUTE_GUIDE_CONFIG && window.ROUTE_GUIDE_CONFIG.home) || {};

    

    const tUsedRaw = cfgHome.timeUsed || 0;
    const tPlanRaw = cfgHome.timePlanned || 0;
    const tUsed = Number(tUsedRaw).toFixed(1);
    const tPlan = Number(tPlanRaw).toFixed(1);

    const a1 = cfgHome.minAltitude || "--";
    const a2 = cfgHome.maxAltitude || "--";

    const h1 = cfgHome.elevationDiff || "--";
    const h2 = cfgHome.elevationAlt || "--";
   


  
    const statGainEl = document.getElementById("statGain");
    if (statGainEl){
   statGainEl.textContent = `-- / -- m`;

    }

    const outdoorUrl = "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png";
    const satUrl     = "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}";

    let map, outdoorLayer, satLayer;
    let currentLayer = "outdoor";
    let routeBounds  = null;
    let userMarker   = null;

    // ==============================
    // è·¯çº¿è½¨è¿¹ï¼ˆå…¨å±€å¯è°ƒè¯•ï¼‰
    // ==============================
    let routeLatLngs = [];
    window.routeLatLngs = routeLatLngs;

    // ==============================
    // å¾’æ­¥èµ·ç‚¹ / è¿›åº¦è®¡ç®—ï¼šçŠ¶æ€å˜é‡ï¼ˆStep 1ï¼‰
    // ==============================
    let routeStartIndex = null;   // å¾’æ­¥èµ·ç‚¹åœ¨ routeLatLngs ä¸­çš„ç´¢å¼•ï¼ˆä¸ elevPoints åŒæ­¥ï¼‰
    let routeStartKm    = 0;      // å¾’æ­¥èµ·ç‚¹å¯¹åº”çš„ kmï¼ˆæ¥è‡ª elevPoints[index].distï¼‰
    let isOnRoute       = false;  // æ˜¯å¦å·²è¿›å…¥å¾’æ­¥è½¨è¿¹ï¼ˆ<=100m è§†ä¸ºè¿›å…¥ï¼‰

    // ğŸ‘‰ åŒæ­¥åˆ° windowï¼Œä¾¿äº Console è°ƒè¯• & åç»­å‡½æ•°ä½¿ç”¨
    window.routeStartIndex = routeStartIndex;
    window.routeStartKm    = routeStartKm;
    window.isOnRoute       = isOnRoute;

    // åç»­çŠ¶æ€å˜æ›´æ—¶ç»Ÿä¸€åŒæ­¥ï¼ˆStep 2 ä¼šç”¨ï¼‰
    function syncRouteStateToWindow(){
      window.routeStartIndex = routeStartIndex;
      window.routeStartKm    = routeStartKm;
      window.isOnRoute       = isOnRoute;
    }

    let sceneNodeLayer    = null;
    let sceneNodeMarkers  = [];

    let elevPoints    = [];
    window.elevPoints = elevPoints; // ä¾›è¿›åº¦çƒæ˜ å°„ä½¿ç”¨ï¼ˆåªè¯»ï¼‰
    let elevTotalDist = 0;
    window.elevTotalDist = elevTotalDist; // ä¾›è¿›åº¦çƒæ˜ å°„ä½¿ç”¨ï¼ˆåªè¯»ï¼‰
    let cursorDist        = null;
    let cursorInfo        = null;
    let currentProgressKm = 0;

    const centerLat = cfgHome.centerLat || -39.2815;
    const centerLng = cfgHome.centerLng || 175.5703;
    const startZoom = cfgHome.mapZoom   || 12;
// ==============================
// Step 2ï¼šGPS â†’ è·¯çº¿æŠ•å½± â†’ èµ·ç‚¹åˆ¤å®š â†’ è¿›åº¦è®¡ç®— â†’ å·¦ä¸Šè§’å¡ç‰‡æ›´æ–°
// ç›®æ ‡ï¼šä¸æ”¹ä½ ç°æœ‰ JSON/profile/track/å‰–é¢ï¼Œåªè¡¥è®¡ç®—å’Œæ˜¾ç¤º
// ==============================

// â‘  æ¯æ¬¡åˆ‡æ¢è·¯çº¿ / é‡è½½è·¯çº¿ï¼Œéƒ½è¦é‡ç½®ï¼ˆä¿è¯å¤šè·¯çº¿é¡ºæ»‘ï¼‰
function resetRouteProgressState(){
  routeStartIndex = null;
  routeStartKm    = 0;
  isOnRoute       = false;
  syncRouteStateToWindow();
}

// â‘¡ GPS æŠ•å½±åˆ°è·¯çº¿ï¼šæ‰¾æœ€è¿‘çš„ routeLatLngs ç‚¹ï¼ˆè¿”å› index + åç¦»è·ç¦»ç±³ï¼‰
function projectGpsToRoute(lat, lng){
  if (!routeLatLngs || routeLatLngs.length < 2) return null;

  let minM = Infinity;
  let bestIdx = -1;

  for (let i = 0; i < routeLatLngs.length; i++){
    const p = routeLatLngs[i];
    const dM = distanceKm(lat, lng, p[0], p[1]) * 1000; // km â†’ m
    if (dM < minM){
      minM = dM;
      bestIdx = i;
    }
  }

  if (bestIdx < 0) return null;
  return { index: bestIdx, offsetM: minM };
}

// â‘¢ æ ¹æ® GPS è®¡ç®— â€œå·²å®Œæˆé‡Œç¨‹ doneKmâ€
// è§„åˆ™ï¼š
// - æœªåˆ°èµ·ç‚¹ï¼šè¿”å› nullï¼ˆå¡ç‰‡æ˜¾ç¤º --/totalï¼‰
// - é¦–æ¬¡è¿›å…¥ <=100mï¼šé”å®š routeStartIndex/routeStartKm
// - åç¦» >100mï¼šdoneKm æ˜¾ç¤ºä¸ºè´Ÿå€¼ï¼ˆ-åç¦»å…¬é‡Œï¼‰
function calcDoneKmFromGps(lat, lng){
  if (!elevPoints || elevPoints.length < 2) return null;

  const proj = projectGpsToRoute(lat, lng);
  if (!proj) return null;

  const idx = proj.index;
  const offsetM = proj.offsetM;

  // è¿›å…¥å¾’æ­¥è½¨è¿¹ï¼ˆ<=100m æ‰ç®—å¼€å§‹ï¼‰
  if (!isOnRoute){
    if (offsetM > 100) return null;

    isOnRoute = true;
    routeStartIndex = idx;
    routeStartKm = (elevPoints[idx] && typeof elevPoints[idx].dist === "number") ? elevPoints[idx].dist : 0;
    syncRouteStateToWindow();
  }

  // æ­£å¸¸å®Œæˆé‡Œç¨‹ï¼šå½“å‰ä½ç½® km - èµ·ç‚¹ km
  const curKm = (elevPoints[idx] && typeof elevPoints[idx].dist === "number") ? elevPoints[idx].dist : 0;
  let doneKm = curKm - routeStartKm;

  // åç¦»ï¼šæ˜¾ç¤ºè´Ÿå€¼
  if (offsetM > 100){
    doneKm = - (offsetM / 1000);
  }

  return { doneKm, idx, offsetM };
}

// â‘£ ç»Ÿä¸€åˆ·æ–°å·¦ä¸Šè§’å¡ç‰‡ï¼ˆé‡Œç¨‹ + æµ·æ‹”ï¼‰
// - æœªåˆ°èµ·ç‚¹ï¼š-- / total
// - åˆ°èµ·ç‚¹åï¼šdone / total
// - æµ·æ‹”ï¼šå½“å‰ ele / å…¨ç¨‹æœ€é«˜ç‚¹ï¼ˆä½ ä¹Ÿå¯æ”¹æˆæ€»çˆ¬å‡ï¼Œåç»­å†åšï¼‰
function updateStatsCardByGps(lat, lng, tsMs){
  console.log(
  "[GPSâ†’Stats]",
  "lat=", lat.toFixed(5),
  "lng=", lng.toFixed(5)
);
  const totalKm = (typeof elevTotalDist === "number" && elevTotalDist > 0)
    ? elevTotalDist
    : (elevPoints && elevPoints.length ? (elevPoints[elevPoints.length - 1].dist || 0) : 0);

  const distEl = document.getElementById("statDistance");
  const altEl  = document.getElementById("statAlt");
  if (!distEl) return;

  const res = calcDoneKmFromGps(lat, lng);

  // æœªåˆ°èµ·ç‚¹
  if (!res){
    distEl.textContent = `-- / ${totalKm.toFixed(1)} km`;
    return;
  }

  // é‡Œç¨‹
  distEl.textContent = `${res.doneKm.toFixed(1)} km / ${totalKm.toFixed(1)} km`;

  // æµ·æ‹”ï¼ˆå½“å‰ / æœ€é«˜ï¼‰
  if (altEl && elevPoints && elevPoints.length){
    const curEle = elevPoints[res.idx] ? elevPoints[res.idx].ele : null;
    let maxEle = -Infinity;
    for (let i = 0; i < elevPoints.length; i++){
      const e = elevPoints[i] ? elevPoints[i].ele : null;
      if (typeof e === "number" && e > maxEle) maxEle = e;
    }
    if (typeof curEle === "number" && isFinite(maxEle)){
      altEl.textContent = `${Math.round(curEle)} m / ${Math.round(maxEle)} m`;
    }
  }

  // åŒæ­¥å‰–é¢ç«–çº¿ï¼ˆè´Ÿå€¼åç¦»æ—¶ï¼šå‰–é¢ä¿æŒ 0ï¼Œä¸å€’é€€ï¼‰
  currentProgressKm = Math.max(0, res.doneKm);
  if (window.setProgressKm){ setProgressKm(currentProgressKm, "gps"); } else { updateCursorByDist(currentProgressKm); }

  // âœ… çœŸå®é€Ÿåº¦/æ—¶é—´ï¼šæŠ•å–‚ doneKmï¼ˆåªä¾èµ– GPSâ†’è½¨è¿¹æŠ•å½±ç»“æœï¼Œä¸ç”¨ä»»ä½•å‡æ•°æ®ï¼‰
  if (typeof window.__RM_feed === "function"){
    window.__RM_feed(res.doneKm, tsMs);
  }
}

/* ============================================================
 * UI_STATEï¼šç»Ÿä¸€ UI çŠ¶æ€æºï¼ˆå½“å‰ä»…æ¥ç®¡é€Ÿåº¦/é…é€Ÿï¼‰
 * ============================================================ */
window.UI_STATE = {
  speedKmh: null,        // å½“å‰é€Ÿåº¦ km/h
  paceMinPerKm: null,    // å½“å‰é…é€Ÿ min/km
  active: false          // æ˜¯å¦å·²æ¿€æ´»ï¼ˆ>=100mï¼‰
};

    

/* ============================================================
 * â‘¤ çœŸå®è¡Œè¿›ç»Ÿè®¡ï¼ˆé€Ÿåº¦/é…é€Ÿ/å·²ç”¨æ—¶é—´/åå·®/åœé¡¿ï¼‰â€”â€”æœ€å°ä¾µå…¥ç‰ˆ
 * ä¾èµ–ï¼šcalcDoneKmFromGps() + updateStatsCardByGps() ä¸­å¾—åˆ°çš„ res.doneKm
 * æ¿€æ´»è§„åˆ™ï¼šæ²¿è½¨è¿¹æ–¹å‘ç´¯è®¡å‰è¿› >= 0.1kmï¼ˆ100mï¼‰åå¼€å§‹è®¡æ—¶ä¸è®¡é€Ÿ
 * ç›®çš„ï¼šè®©å·¦ä¸Šè§’é€Ÿåº¦ä¸æŠ½å±‰å³ä¸Šè§’æ—¶é—´åªæ¥è‡ªçœŸå® GPS + è½¨è¿¹æŠ•å½±ç»“æœ
 * ============================================================ */
(function(){
  const SPEED_PAUSE_KMH = 0.3;      // ä½äºæ­¤é€Ÿåº¦è§†ä¸ºåœé¡¿ï¼ˆè¿‡æ»¤æ¼‚ç§»ï¼‰
  const ACTIVATE_KM = 0.1;          // 100m
  const MAX_DT_SEC = 15;            // è¶…è¿‡è¿™ä¸ªé—´éš”ï¼Œå½“ä½œæ–­ç‚¹ï¼ˆä¸ç”¨äºé€Ÿåº¦ç´¯ç§¯ï¼‰
  const EWM_ALPHA = 0.25;           // é€Ÿåº¦å¹³æ»‘ç³»æ•°ï¼ˆè¶Šå¤§è¶Šçµæ•ï¼‰

  function fmtUsedPlanned(usedSec, plannedSec){
    return `å·²ç”¨æ—¶é—´ ${fmtHMS(usedSec)} / ${fmtHMS(plannedSec)}`;
  }
  function fmtDeviationPause(devSec, pauseSec){
    return `å½“å‰åå·®æ—¶é—´ ${fmtSignedMin(devSec)} / ç´¯è®¡åœé¡¿ ${fmtMin(pauseSec)}`;
  }
  function fmtHMS(sec){
    if (!Number.isFinite(sec) || sec < 0) return "--";
    const h = Math.floor(sec/3600);
    const m = Math.floor((sec%3600)/60);
    // å°äº1å°æ—¶ï¼šæ˜¾ç¤º mm'mï¼›å¦åˆ™ï¼šæ˜¾ç¤º h:mm
    if (h <= 0) return `${m}â€²`;
    return `${h}:${String(m).padStart(2,'0')}h`;
  }
  function fmtMin(sec){
    if (!Number.isFinite(sec) || sec < 0) return "--";
    const m = Math.round(sec/60);
    return `${m}â€²`;
  }
  function fmtSignedMin(sec){
    if (!Number.isFinite(sec)) return "--";
    const sign = sec >= 0 ? "+" : "âˆ’";
    const m = Math.round(Math.abs(sec)/60);
    // å°äº 60 åˆ†é’Ÿï¼šæ˜¾ç¤º 15â€²ï¼›å¦åˆ™ï¼šæ˜¾ç¤º 1.5hï¼ˆä¿ç•™ 1 ä½ï¼‰
    if (m < 60) return `${sign}${m}â€²`;
    const h = Math.round((m/60)*10)/10;
    return `${sign}${h}h`;
  }
  function paceFromSpeedKmh(kmh){
    if (!Number.isFinite(kmh) || kmh <= 0) return null;
    return 60 / kmh; // min / km
  }
  function kmhFromPaceMinPerKm(p){
    if (!Number.isFinite(p) || p <= 0) return null;
    return 60 / p;
  }

  // å…¨å±€çŠ¶æ€ï¼šåªåœ¨è¿™é‡Œç»´æŠ¤ï¼Œé¿å…æ±¡æŸ“å…¶ä»–é€»è¾‘
  const S = window.__REAL_MOVE_STATE = window.__REAL_MOVE_STATE || {
    // æ¿€æ´»é—¨æ§›
    active:false,
    startDoneKm:null,         // é¦–æ¬¡å‘½ä¸­èµ·ç‚¹åçš„ doneKm
    lastDoneKm:null,
    lastTsMs:null,

    // ç´¯è®¡
    movingDistKm:0,
    movingSec:0,
    pausedSec:0,

    // å¹³æ»‘é€Ÿåº¦
    ewSpeedKmh:null,

    // è®¡åˆ’æ€»æ—¶é—´ï¼ˆç§’ï¼‰
    plannedTotalSec:null
  };

  // ä» config è¯»å–è®¡åˆ’æ—¶é—´ï¼ˆå°æ—¶ï¼‰ï¼Œåªè¯»ä¸€æ¬¡ï¼ˆå¦‚æœä½ åé¢æ¢é…ç½®æ¥æºï¼Œåªæ”¹è¿™é‡Œï¼‰
  function ensurePlannedTotalSec(){
    if (Number.isFinite(S.plannedTotalSec)) return;
    const cfgHome = (window.ROUTE_GUIDE_CONFIG && window.ROUTE_GUIDE_CONFIG.home) || {};
    const h = Number(cfgHome.timePlanned);
    S.plannedTotalSec = Number.isFinite(h) && h > 0 ? Math.round(h * 3600) : null;
  }

  // ç»Ÿä¸€æ›´æ–°å·¦ä¸Šè§’é€Ÿåº¦/é…é€Ÿæ˜¾ç¤ºï¼ˆä¸ç›´æ¥æ”¹åˆ«çš„ UIï¼‰
  function updateSpeedUI(kmh){
    const el = document.getElementById("sceneSpeedDisplay");
    if (!el) return;

    if (!Number.isFinite(kmh) || kmh <= 0){
      el.textContent = "å½“å‰è¡Œè¿›é€Ÿåº¦ï¼š--";
      el.setAttribute("data-pace-min-per-km", "");
      el.setAttribute("data-mode", "speed");
      return;
    }

    const pace = paceFromSpeedKmh(kmh);
    if (pace){
      el.setAttribute("data-pace-min-per-km", String(Math.round(pace*10)/10));
    }

    const mode = el.getAttribute("data-mode") || "speed";
    if (mode === "pace" && pace){
      // é…é€Ÿï¼šå°äº 60 åˆ†é’Ÿæ˜¾ç¤º 30â€²/kmï¼›å¤§äºæ˜¾ç¤º 1.5h/km
      const m = pace;
      let pStr;
      if (m < 60) pStr = `${Math.round(m)}â€²/km`;
      else pStr = `${Math.round((m/60)*10)/10}h/km`;
      el.textContent = "å½“å‰è¡Œè¿›é…é€Ÿï¼š" + pStr;
    } else {
      el.textContent = "å½“å‰è¡Œè¿›é€Ÿåº¦ï¼š" + (Math.round(kmh*10)/10).toFixed(1) + " km/h";
      el.setAttribute("data-mode", "speed");
    }
  }

  // ç»Ÿä¸€æ›´æ–°æŠ½å±‰å³ä¸Šè§’æ—¶é—´æ˜¾ç¤ºï¼ˆä¸ç›´æ¥æ”¹åˆ«çš„ UIï¼‰
  function updateTimeUI(){
    const el = document.getElementById("sceneTimeDeviation");
    if (!el) return;
    ensurePlannedTotalSec();

    if (!S.active){
      el.textContent = "å·²ç”¨æ—¶é—´ -- / --";
      el.setAttribute("data-mode", "used");
      return;
    }

    const usedSec = S.movingSec + S.pausedSec;
    const plannedTotal = S.plannedTotalSec;

    // è®¡ç®—â€œå½“å‰åå·®â€ï¼šå¯¹æ¯”â€œæŒ‰è¿›åº¦æ¯”ä¾‹çš„è®¡åˆ’æ—¶é—´â€
    let devSec = null;
    if (Number.isFinite(plannedTotal) && plannedTotal > 0 && typeof window.currentProgressKm === "number"){
      const totalKm = (typeof window.elevTotalDist === "number" && window.elevTotalDist > 0)
        ? window.elevTotalDist
        : null;
      if (Number.isFinite(totalKm) && totalKm > 0){
        const plannedAtNow = plannedTotal * (Math.max(0, window.currentProgressKm) / totalKm);
        devSec = usedSec - plannedAtNow;
      }
    }

    const mode = el.getAttribute("data-mode") || "used";
    if (mode === "dev"){
      el.textContent = fmtDeviationPause(devSec, S.pausedSec);
    } else {
      el.textContent = fmtUsedPlanned(usedSec, plannedTotal);
      el.setAttribute("data-mode", "used");
    }
  }

  // ç‚¹å‡»åˆ‡æ¢ï¼šé€Ÿåº¦ â†” é…é€Ÿ
  // ä½ åŸæ¥çš„ click é€»è¾‘ä»åœ¨ï¼Œä½†å®ƒä¾èµ– data-pace-min-per-kmã€‚
  // ä¸ºé¿å…â€œæœ‰ä¸¤å¥— click äº’ç›¸æ‰“æ¶â€ï¼Œè¿™é‡Œä¸å†åŠ ç¬¬äºŒä¸ªç›‘å¬å™¨ã€‚
  // æˆ‘ä»¬åªä¿è¯ data-pace-min-per-km å§‹ç»ˆæ¥è‡ªçœŸå®æ•°æ®ã€‚

  // ç‚¹å‡»åˆ‡æ¢ï¼šå·²ç”¨/è®¡åˆ’ â†” åå·®/åœé¡¿
  (function bindTimeToggle(){
    const el = document.getElementById("sceneTimeDeviation");
    if (!el) return;
    el.addEventListener("click", function(){
      const mode = el.getAttribute("data-mode") || "used";
      el.setAttribute("data-mode", mode === "used" ? "dev" : "used");
      updateTimeUI();
    });
  })();

  // ä¾›å¤–éƒ¨ï¼ˆupdateStatsCardByGpsï¼‰è°ƒç”¨ï¼šæ¯æ¬¡ GPS æ›´æ–°åï¼ŒæŠ•å–‚ doneKm + timestamp
  window.__RM_feed = function(doneKm, tsMs){
    ensurePlannedTotalSec();

    const t = Number.isFinite(tsMs) ? tsMs : Date.now();

    // æœªå‘½ä¸­èµ·ç‚¹ï¼šé‡ç½®æ˜¾ç¤ºä¸º --
    if (!Number.isFinite(doneKm)){
      S.active = false;
      S.startDoneKm = null;
      S.lastDoneKm = null;
      S.lastTsMs = null;
      S.movingDistKm = 0;
      S.movingSec = 0;
      S.pausedSec = 0;
      S.ewSpeedKmh = null;
      updateSpeedUI(null);
      updateTimeUI();
      return;
    }

    // é¦–æ¬¡åˆå§‹åŒ–
    if (!Number.isFinite(S.startDoneKm)){
      S.startDoneKm = doneKm;
      S.lastDoneKm = doneKm;
      S.lastTsMs = t;
      S.active = false;
      updateSpeedUI(null);
      updateTimeUI();
      return;
    }

    const dtSec = (t - S.lastTsMs) / 1000;
    const dKmRaw = doneKm - S.lastDoneKm;

    // æ›´æ–° last
    S.lastDoneKm = doneKm;
    S.lastTsMs = t;

    if (!Number.isFinite(dtSec) || dtSec <= 0) return;

    // é—´éš”è¿‡å¤§ï¼šè§†ä¸ºæ–­ç‚¹ï¼Œåªæ›´æ–° UIï¼Œä¸å‚ä¸ç´¯ç§¯ï¼ˆé¿å…è·³ç‚¹å¯¼è‡´å‡é«˜é€Ÿï¼‰
    if (dtSec > MAX_DT_SEC){
      updateSpeedUI(S.ewSpeedKmh);
      updateTimeUI();
      return;
    }

    // æ¿€æ´»åˆ¤æ–­ï¼šåªç´¯è®¡â€œå‘å‰è¿›åº¦â€ï¼ˆdKmRaw > 0ï¼‰
    if (!S.active){
      if (dKmRaw > 0){
        const forwardKm = doneKm - S.startDoneKm;
        if (forwardKm >= ACTIVATE_KM){
          S.active = true;
          // æ¿€æ´»ç¬é—´ä¸æŠŠçƒ­èº«æ®µçº³å…¥ç»Ÿè®¡ï¼šä»æ­¤åˆ»å¼€å§‹è®¡æ—¶
          S.movingDistKm = 0;
          S.movingSec = 0;
          S.pausedSec = 0;
          S.ewSpeedKmh = null;
        }
      }
      updateSpeedUI(null);
      updateTimeUI();
      return;
    }

    // ç»Ÿè®¡ï¼šé€Ÿåº¦ç”¨â€œç»å¯¹ç§»åŠ¨è·ç¦»â€æ›´ç¬¦åˆæŠ˜è¿”/åç©¿åœºæ™¯ï¼ˆè¡Œä¸ºçœŸå®ï¼‰
    const dKm = Math.abs(dKmRaw);
    const instKmh = dKm / (dtSec / 3600);

    // åœé¡¿ï¼šé€Ÿåº¦è¿‡ä½è§†ä¸ºåœé¡¿
    if (instKmh < SPEED_PAUSE_KMH){
      S.pausedSec += dtSec;
      // åœé¡¿æœŸé—´ä¸æ›´æ–° ewSpeedï¼ˆé¿å…æ‹–æ…¢ï¼‰
      updateSpeedUI(S.ewSpeedKmh);
      updateTimeUI();
      return;
    }

    // ç§»åŠ¨ç´¯è®¡
    S.movingDistKm += dKm;
    S.movingSec += dtSec;

    // å¹³æ»‘é€Ÿåº¦ï¼šæŒ‡æ•°åŠ æƒ
    if (!Number.isFinite(S.ewSpeedKmh)) S.ewSpeedKmh = instKmh;
    else S.ewSpeedKmh = S.ewSpeedKmh * (1 - EWM_ALPHA) + instKmh * EWM_ALPHA;

    updateSpeedUI(S.ewSpeedKmh);
    updateTimeUI();
  };

  // åˆå§‹ UI è®¾ä¸º --
  updateSpeedUI(null);
  updateTimeUI();
})();


function initBaseMap(){
      map = L.map("map", {
        zoomControl:false,
        attributionControl:true,
        maxZoom:19,
        minZoom:3
      }).setView([centerLat, centerLng], startZoom);
      window.map = map; // ä¾›è¿›åº¦çƒç­‰æ¨¡å—è®¢é˜…ä½¿ç”¨

      outdoorLayer = L.tileLayer(outdoorUrl, {
        subdomains:"abc",
        minZoom:3,
        maxZoom:19,
        attribution:"Tiles Â© OpenStreetMap contributors"
      }).addTo(map);

      satLayer = L.tileLayer(satUrl, {
        minZoom:3,
        maxZoom:19,
        attribution:"Imagery Â© Esri"
      });

      L.circleMarker([centerLat, centerLng], {
        radius:5,
        color:"#ef4444",
        weight:3,
        fillOpacity:0.8
      }).addTo(map);

      map.attributionControl.setPosition("bottomright");
    }

// === JSON â†’ è€å†…éƒ¨æ¨¡å‹ é€‚é…å±‚ ===
function adaptJsonToLegacyModel(raw) {
  if (!raw) return null;

  // â­ å”¯ä¸€æ­£ç¡®çš„è½¨è¿¹æ¥æº
 // âœ… profile å°±æ˜¯è½¨è¿¹æº
const srcTrack = Array.isArray(raw.profile)
  ? raw.profile
  : [];


  console.log("âœ… ä½¿ç”¨ raw.path.points ä½œä¸ºè½¨è¿¹ï¼Œç‚¹æ•° =", srcTrack.length);

 // ğŸŒ¤ å¤©æ°”èŠ‚ç‚¹ï¼šå…¼å®¹å¤šæ¥æºï¼ˆæœ€ç»ˆç‰ˆï¼‰
let weatherNodes = [];

// â‘  é¡¶å±‚ weatherNodesï¼ˆå¦‚æœä½ ä»¥åå•ç‹¬å¯¼å‡ºï¼‰
if (Array.isArray(raw.weatherNodes)) {
  weatherNodes = raw.weatherNodes;
}

// â‘¡ nodes é‡Œå¸¦ type = weather
else if (Array.isArray(raw.nodes)) {
  weatherNodes = raw.nodes.filter(n =>
    n.type === "weather" ||
    n.nodeType === "weather" ||
    n.zType === "Z_WEATHER"
  ).map(n => ({
    km: Number(n.km ?? n.positionKm ?? 0),
    shortName: n.shortName || n.summary || n.weather || "",
    raw: n
  }));
}


// âœ… ç”Ÿæˆâ€œåœºæ™¯èŠ‚ç‚¹â€ï¼ˆäººå·¥/åœ°å½¢ç­‰ï¼‰ï¼Œä¸å«å¤©æ°”èŠ‚ç‚¹ï¼ˆå¤©æ°”èµ° weatherNodesï¼‰
// æ”¯æŒ JSON ç»“æ„ï¼šraw.nodesï¼ˆæ—§ï¼‰ / raw.manualScenesï¼ˆäººå·¥ï¼‰ / raw.segmentsï¼ˆåœ°å½¢æ®µï¼‰
function buildSceneNodes(raw){
  const out = [];

  // â‘  æ—§ç»“æ„ï¼šraw.nodesï¼ˆå¦‚æœå­˜åœ¨å°±ç›´æ¥å¹¶å…¥ï¼Œä½†ä¼šè¿‡æ»¤æ‰ weatherï¼‰
  if (raw && Array.isArray(raw.nodes)){
    raw.nodes.forEach(n=>{
      if (!n) return;
      const t = String(n.nodeType || n.type || "").toLowerCase();
      if (t === "weather") return;
      out.push(n);
    });
  }

  // â‘¡ äººå·¥åœºæ™¯èŠ‚ç‚¹ï¼šraw.manualScenes
  if (raw && Array.isArray(raw.manualScenes)){
    raw.manualScenes.forEach(s=>{
      if (!s) return;
      out.push({
        nodeType: "manual",
        shortName: s.title || s.shortName || s.name || "(æœªå‘½å)",
        desc: s.desc || s.description || "",
        // åæ ‡ï¼ˆä¼˜å…ˆç›´æ¥ç”¨ï¼‰
        startLat: (s.startLat != null ? Number(s.startLat) : undefined),
        startLon: (s.startLon != null ? Number(s.startLon) : undefined),
        // é‡Œç¨‹ï¼ˆå…œåº•ï¼‰
        positionKm: (s.startKm != null ? Number(s.startKm) : undefined),
        startKm: (s.startKm != null ? Number(s.startKm) : undefined),
        endKm: (s.endKm != null ? Number(s.endKm) : undefined),
        raw: s
      });
    });
  }

  // â‘¢ åœ°å½¢æ®µèŠ‚ç‚¹ï¼šraw.segmentsï¼ˆç”¨ startPt / startKm ä½œä¸ºâ€œæ®µèµ·ç‚¹æ ‡ç­¾â€ï¼‰
  if (raw && Array.isArray(raw.segments)){
    raw.segments.forEach(seg=>{
      if (!seg) return;
      const sp = seg.startPt || {};
      out.push({
        nodeType: "terrain",
        shortName: seg.shortName || seg.title || seg.terrainType || seg.surfaceType || "(åœ°å½¢)",
        desc: seg.desc || seg.description || seg.terrainType || "",
        startPt: (sp && sp.lat!=null && sp.lon!=null) ? {lat:Number(sp.lat), lon:Number(sp.lon)} : undefined,
        startKm: (seg.startKm != null ? Number(seg.startKm) : undefined),
        positionKm: (seg.startKm != null ? Number(seg.startKm) : undefined),
        endKm: (seg.endKm != null ? Number(seg.endKm) : undefined),
        raw: seg
      });
    });
  }

  return out;
}

return {
  track: srcTrack.map(p => ({
    lat: Number(p.lat),
    lon: Number(p.lon)
  })),
  profile: Array.isArray(raw.profile) ? raw.profile : [],
  nodes: buildSceneNodes(raw),
  weatherNodes
};

}


    /* ============================================================
 * JSON ä¸“ç”¨ï¼šå‰–é¢å›¾æ¸²æŸ“ renderProfile()
 * æ›¿ä»£ç¼ºå¤±çš„ GPX å‰–é¢å‡½æ•°ï¼Œé¿å…â€œrenderProfile æœªå®šä¹‰â€é”™è¯¯
 * ä¸å½±å“åŸæœ‰ GPX æµç¨‹
 * ============================================================ */




/* ============================================================
 * â‘¡ å¦‚æœåŠ è½½åˆ°äº† JSONï¼Œåˆ™ç”¨ JSON.profile / nodes / track è¦†ç›– GPX
 *    å¹¶è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼å‘Šè¯‰å¤–é¢â€œæœ‰æ²¡æœ‰ç”¨ä¸Š JSONâ€
 * ============================================================ */
async function tryRenderRouteFromJson() {
  const rawModel = await loadRouteModel();
  const model = adaptJsonToLegacyModel(rawModel);

  // å…¥å£åˆ¤æ–­ï¼šæœ‰æ²¡æœ‰ JSON
  if (!model) {
    console.warn("âŒ æ²¡æœ‰åŠ è½½åˆ° JSONï¼Œå›é€€ GPX");
    window.USE_JSON_ROUTE = false;
    return false;
  }

  window.USE_JSON_ROUTE = true;
  window.__model = model;
  console.log("âœ… ä½¿ç”¨ JSON è·¯çº¿æ¨¡å‹ï¼ˆå·²é€‚é…ï¼‰ï¼š", model);

  /* ============================================================
   * â‘  Profileï¼ˆå‰–é¢ / é‡Œç¨‹ / æµ·æ‹”ï¼‰
   * ============================================================ */
  if (Array.isArray(model.profile) && model.profile.length > 0) {
    console.log("ä½¿ç”¨ JSON profileï¼Œç‚¹æ•° =", model.profile.length);
    renderProfile(model.profile);
  } else {
    console.warn("JSON ä¸­æ²¡æœ‰ profile å­—æ®µ");
  }

  /* ============================================================
   * â‘¡ Nodesï¼ˆåªè´Ÿè´£èŠ‚ç‚¹æœ¬èº«ï¼šäººå·¥ / åœ°å½¢ / å¤©æ°”
   *     âš ï¸ èŠ‚ç‚¹å†…éƒ¨æ€ä¹ˆç”»ï¼Œç”± renderNodesFromJson å†³å®š
   * ============================================================ */
  if (typeof renderNodesFromJson === "function") {
    renderNodesFromJson(model);
  }

  /* ============================================================
   * â‘¢ Trackï¼ˆåœ°å›¾çº¢çº¿ï¼‰
   *     âš ï¸ ä¸ä¸ nodes / profile äº’ç›¸å½±å“
   * ============================================================ */
  if (
    typeof renderTrackFromJson === "function" &&
    Array.isArray(model.track) &&
    model.track.length >= 2
  ) {
    renderTrackFromJson(model);
  } else {
    console.warn("JSON ä¸­æ²¡æœ‰æœ‰æ•ˆ trackï¼Œä»…ä¸æ˜¾ç¤ºè·¯çº¿");
  }

  return true;
}




/* ============================================================
 * JSON.profile â†’ å†™å…¥ elevPoints / elevTotalDist å¹¶ç»˜åˆ¶å‰–é¢å›¾
 * ============================================================ */
function renderProfile(profileArr) {
  if (!Array.isArray(profileArr) || profileArr.length === 0) {
    console.warn("renderProfileï¼šprofile æ•°æ®ä¸ºç©º");
    return;
  }

  // ===== 1ï¸âƒ£ profile â†’ elevPointsï¼ˆå”¯ä¸€æµ·æ‹”æ•°æ®æºï¼‰=====
  elevPoints = profileArr.map(p => ({
    dist: Number(p.km ?? p.dist ?? 0),
    ele:  Number(
      p.ele ??
      p.elevation ??
      p.altitude ??
      p.alt ??
      0
    )
  }));

  // ===== æ€»é‡Œç¨‹ï¼šä¼˜å…ˆä½¿ç”¨ JSON.meta.distanceKm =====
const metaDistKm =
  window.__model &&
  window.__model.meta &&
  typeof window.__model.meta.distanceKm === "number"
    ? window.__model.meta.distanceKm
    : null;

elevTotalDist = metaDistKm != null
  ? metaDistKm
  : elevPoints[elevPoints.length - 1].dist;

    window.elevTotalDist = elevTotalDist;
  console.log("JSON profile å·²å†™å…¥ elevPointsï¼Œæ€»è·ç¦» =", elevTotalDist);

  // ===== 2ï¸âƒ£ åˆå§‹åŒ–å·¦ä¸Šè§’ã€é‡Œç¨‹ã€‘=====
  const distEl = document.getElementById("statDistance");
  if (distEl && elevTotalDist > 0) {
    distEl.textContent = `0.0 km / ${elevTotalDist.toFixed(1)} km`;
  }

  // ===== 3ï¸âƒ£ åˆå§‹åŒ–å·¦ä¸Šè§’ã€æµ·æ‹”ï¼šå½“å‰ / æœ€é«˜ã€‘=====
  const altEl = document.getElementById("statAlt");
  if (altEl && elevPoints.length > 0) {
    const startEle = elevPoints[0].ele;
// ===== æœ€é«˜æµ·æ‹”ï¼šä¼˜å…ˆä½¿ç”¨ JSON.meta.maxEle =====
let metaMaxEle =
  window.__model &&
  window.__model.meta &&
  typeof window.__model.meta.maxEle === "number"
    ? window.__model.meta.maxEle
    : null;

    let maxEle = -Infinity;
    for (let i = 0; i < elevPoints.length; i++) {
      const e = elevPoints[i].ele;
      if (typeof e === "number" && e > maxEle) {
        maxEle = e;
      }
    }

   const finalMaxEle = metaMaxEle != null ? metaMaxEle : maxEle;

altEl.textContent =
  `${Math.round(startEle)} m / ${Math.round(finalMaxEle)} m`;

  }

  // ===== 4ï¸âƒ£ ç»˜åˆ¶å‰–é¢å›¾ï¼ˆè¿›åº¦ä¸º 0ï¼‰=====
  currentProgressKm = 0;
  cursorDist = 0;
  drawElevationProfile(0);
}


/* ============================================================
 * â‘¢ JSON.nodes â†’ æ¸²æŸ“èŠ‚ç‚¹ï¼ˆæŠ½å±‰åˆ—è¡¨ / åœ°å›¾æ ‡è®° / å¤©æ°”æ¡ï¼‰
 * ============================================================ */
function renderNodesFromJson(model) {
    console.log("ğŸš¨ renderNodesFromJson CALLED");
  console.log("ğŸ“¦ model =", model);
  if (!model || !Array.isArray(model.nodes)) {
    console.warn("JSON ä¸­æ²¡æœ‰ nodes å­—æ®µ");
    return;
  }

const nodes = model.nodes;
// âš ï¸ åªä¿ç•™äººå·¥èŠ‚ç‚¹ï¼Œå…¶å®ƒèŠ‚ç‚¹ä¸€å¾‹ä¸å‚ä¸åœ°å›¾æ¸²æŸ“


// ==============================
// ğŸŒ¤ æå–å¤©æ°”èŠ‚ç‚¹ï¼ˆå”¯ä¸€æ•°æ®æºï¼‰
// ==============================
// ===== æå–å¤©æ°”èŠ‚ç‚¹ï¼ˆä¼˜å…ˆ weatherNodesï¼Œå…¶æ¬¡ nodesï¼‰ =====
let weatherNodes = [];

// â‘  æ–°ç»“æ„ï¼šç›´æ¥æ¥è‡ª JSON é¡¶å±‚ weatherNodes
if (Array.isArray(model.weatherNodes) && model.weatherNodes.length > 0) {
  weatherNodes = model.weatherNodes.map(w => ({
    ...w,
    positionKm: Number(w.km ?? w.positionKm ?? 0),
    nodeType: "weather"
  }));
  console.log("ğŸŒ¤ ä½¿ç”¨ model.weatherNodesï¼Œå…±", weatherNodes.length);
}

// â‘¡ æ—§ç»“æ„å…œåº•ï¼šnodes é‡Œæ‰¾ nodeType=weather
else if (Array.isArray(model.nodes)) {
  weatherNodes = model.nodes.filter(n => n.nodeType === "weather");
  console.log("ğŸŒ¤ ä½¿ç”¨ model.nodes.weatherï¼Œå…±", weatherNodes.length);
}

// å†™å…¥å…¨å±€ï¼Œä¾› C1 / å¤©æ°”æ¡ / å‰–é¢å…±ç”¨
window.__WEATHER_NODES = weatherNodes;


// âœ… åˆå§‹åŒ–ï¼šé»˜è®¤æ˜¾ç¤ºâ€œèµ·ç‚¹å¤©æ°”èŠ‚ç‚¹â€ï¼ˆä¸åœ¨è½¨è¿¹é™„è¿‘/æ— å…‰æ ‡æ—¶å›é€€ç”¨ 0 kmï¼‰
try{ if (typeof updateWeatherByKm==="function") updateWeatherByKm(0); }catch(e){}
// ğŸ” éªŒè¯æ—¥å¿—ï¼ˆç¬¬ä¸€æ­¥åªçœ‹è¿™ä¸ªï¼‰
console.log("ğŸŒ¤ FINAL WEATHER NODES =", weatherNodes);



  
  // ----- æŠ½å±‰åˆ—è¡¨ï¼ˆç¨³å®šç‰ˆï¼šä»…ç”¨åœºæ™¯èŠ‚ç‚¹ï¼Œä¸å« weatherï¼‰ -----
  const drawer = document.getElementById("dynamicDrawerContent");

  function __swEscapeHtml(s){
    return String(s ?? "")
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#39;");
  }

  if (drawer){
  drawer.innerHTML = ""; // æ¸…ç©ºæ—§å†…å®¹

  const nodesForDrawer = Array.isArray(model.nodes)
    ? model.nodes.filter(n => {
        const t = String(n.nodeType || n.type || "").toLowerCase();
        return t !== "weather";
      })
    : [];

  nodesForDrawer.sort((a,b)=>{
    const ka = Number(a.startKm ?? a.positionKm ?? 0);
    const kb = Number(b.startKm ?? b.positionKm ?? 0);
    return ka - kb;
  });

  if (nodesForDrawer.length === 0){
    drawer.innerHTML = '<div style="text-align:center; color:rgba(255,255,255,0.45); padding:36px 10px; font-size:13px;">æš‚æ— åœºæ™¯èŠ‚ç‚¹</div>';
  }else{
    // ç”Ÿæˆè€ç‰ˆ scene-flow ç»“æ„ï¼ˆä»…è´Ÿè´£ UIï¼Œæ•°æ®ä»æ¥è‡ªæ–°å¼•æ“ï¼‰
    let html = '<div class="scene-flow"><div class="scene-flow-table">';

    // ç”¨é•¿åº¦åšä¸€ä¸ªâ€œå³ä¾§æ¡â€å æ¯”ï¼ˆæ²¡æœ‰é•¿åº¦å°±ç»™å›ºå®šæœ€å°å€¼ï¼‰
    let maxLenM = 0;
    nodesForDrawer.forEach(n=>{
      const raw = n && n.raw ? n.raw : null;
      const lenM = raw && raw.lengthM != null ? Number(raw.lengthM) : 0;
      if (Number.isFinite(lenM)) maxLenM = Math.max(maxLenM, lenM);
    });
    if (!maxLenM || !Number.isFinite(maxLenM)) maxLenM = 1;

    nodesForDrawer.forEach((n, idx)=>{
      const raw = n && n.raw ? n.raw : {};
      const km = Number(n.startKm ?? n.positionKm ?? 0);
      const kmTxt = (Number.isFinite(km) ? km.toFixed(1) : "--") + "km";

      const title = (n.shortName || "(æœªå‘½å)").trim();
      const desc  = (n.desc || "").trim();

      const lenM = raw.lengthM != null ? Number(raw.lengthM) : 0;

      let metricRight = "";
      if (Number.isFinite(lenM) && lenM > 0){
        metricRight = (lenM >= 1000 ? (lenM/1000).toFixed(1) + "km" : Math.round(lenM) + "m");
      }

      const pct = (Number.isFinite(lenM) && lenM > 0) ? Math.max(8, Math.min(100, (lenM/maxLenM)*100)) : 12;

      html += `
        <div class="scene-flow-row" data-idx="${idx}">
          <div class="scene-flow-cell scene-flow-cell-distance">
            <span class="scene-flow-distance scene-flow-distance-green">${__swEscapeHtml(kmTxt)}</span>
          </div>

          <div class="scene-flow-cell scene-flow-cell-main">
            <div class="scene-flow-title">${__swEscapeHtml(title)}</div>
            <div class="scene-flow-sub">${__swEscapeHtml(desc)}</div>
          </div>

          <div class="scene-flow-cell scene-flow-cell-bar">
            <div class="scene-flow-bar-bg">
              <div class="scene-flow-bar-fill" style="width:${pct}%"></div>
            </div>
            <div class="scene-flow-bar-label">${__swEscapeHtml(metricRight)}</div>
          </div>
        </div>
      `;
    });

    html += '</div></div>';
    drawer.innerHTML = html;
  }
}
// ----- åœ°å›¾èŠ‚ç‚¹ -----
// ï¼ˆå·²åºŸå¼ƒï¼šåœ°å›¾ POI èŠ‚ç‚¹ç»Ÿä¸€ç”± renderSceneNodesFromModel() ä½¿ç”¨ .poi-label æ¸²æŸ“ï¼Œé¿å…é‡å¤ï¼‰

// ----- å¤©æ°”æ¡ -----
  const weatherStrip = document.getElementById("weatherStrip");
  if (weatherStrip && Array.isArray(model.profile) && model.profile.length > 0) {
    weatherStrip.innerHTML = "";
    const weatherNodesForStrip = Array.isArray(window.__WEATHER_NODES) ? window.__WEATHER_NODES : [];

    const totalKm = model.profile[model.profile.length - 1].km;

    weatherNodesForStrip.forEach(w => {
      const div = document.createElement("div");
      div.className = "weather-node";
      div.style.left = `${(w.positionKm / totalKm) * 100}%`;
      div.innerHTML = w.shortName || "";
      weatherStrip.appendChild(div);
    });
  }
}


/* ============================================================
 * â‘£ JSON.track â†’ æ¸²æŸ“è·¯çº¿ polylineï¼ˆåœ°å›¾ä¸»è½¨è¿¹ï¼‰
 * ============================================================ */
/* ============================================================
 * â‘£ JSON.track â†’ æ¸²æŸ“è·¯çº¿ polylineï¼ˆåœ°å›¾ä¸»è½¨è¿¹ï¼‰
 *    ä¿®å¤ï¼štrack ä¸å­˜åœ¨æ—¶ï¼Œå›é€€ç”¨ profile ç”»çº¿
 *    åŒæ—¶ï¼šå†™å›è€ç³»ç»Ÿä¾èµ–çš„ routeLatLngsï¼ˆå¹¶æŒ‚åˆ° window æ–¹ä¾¿ä½ åœ¨ Console çœ‹ï¼‰
 * ============================================================ */
function renderTrackFromJson(model) {
  // 1) è½¨è¿¹ç‚¹æ¥æºï¼šä¼˜å…ˆ trackï¼Œå…¶æ¬¡ profile
  const src = (model && Array.isArray(model.track) && model.track.length >= 2)
    ? model.track
    : (model && Array.isArray(model.profile) && model.profile.length >= 2)
      ? model.profile
      : null;

  if (!src) {
    console.warn("renderTrackFromJsonï¼štrack/profile éƒ½æ— æ•ˆï¼Œæ— æ³•ç»˜åˆ¶è·¯çº¿");
    return;
  }

  // 2) æ ‡å‡†åŒ–æˆ Leaflet éœ€è¦çš„ [lat, lon]
  const latlngs = src
    .map(p => [Number(p.lat), Number(p.lon)])
    .filter(a => !isNaN(a[0]) && !isNaN(a[1]));

  if (latlngs.length < 2) {
    console.warn("renderTrackFromJsonï¼šåæ ‡æ— æ•ˆï¼Œç‚¹æ•°ä¸è¶³");
    return;
  }

  // 3) â­è€ç³»ç»Ÿå”¯ä¸€ä¿¡ä»»çš„æ•°æ®æºï¼šrouteLatLngsï¼ˆæ³¨æ„ï¼šè¿™æ˜¯ IIFE é‡Œçš„é‚£ä¸ªå˜é‡ï¼‰
  routeLatLngs = latlngs.slice();
  window.routeLatLngs = routeLatLngs; // æ–¹ä¾¿ä½ åœ¨ Console é‡Œç›´æ¥ window.routeLatLngs çœ‹
  console.log("âœ… routeLatLngs å†™å…¥æˆåŠŸï¼Œç‚¹æ•° =", routeLatLngs.length);
  // ===== FORCE LOAD scene_state.js =====
(function forceLoadSceneState() {
  if (window.SceneState) {
    console.log("[force-load] SceneState already exists");
    return;
  }

  const s = document.createElement("script");
  s.src = "./scene_state.js";
  s.async = false;

  s.onload = () => {
    console.log("[force-load] scene_state.js loaded OK", window.SceneState);
  };

  s.onerror = () => {
    console.error("[force-load] FAILED to load scene_state.js");
  };

  document.head.appendChild(s);
})();


  // 4) ç”»çº¿
  if (window.jsonRouteLine) map.removeLayer(window.jsonRouteLine);

  window.jsonRouteLine = L.polyline(latlngs, {
    color: "#ff3333",
    weight: 4
  }).addTo(map);

  // 5) è§†é‡é€‚é…
  map.fitBounds(window.jsonRouteLine.getBounds().pad(0.15));
  console.log("âœ… JSON è·¯çº¿æ¸²æŸ“å®Œæˆï¼Œç‚¹æ•° =", latlngs.length);
  resetRouteProgressState();
}


// =====================================================
// GPS â†’ è·¯çº¿è¿›åº¦ â†’ å·¦ä¸Šè§’å¡ç‰‡ï¼ˆå”¯ä¸€å‡ºå£ï¼‰
// =====================================================
function updateStatsCardByGps(lat, lng){
  if (!window.routeLatLngs || !Array.isArray(elevPoints) || elevPoints.length === 0){
    console.warn("â›” è·¯çº¿æˆ– profile å°šæœªå°±ç»ª");
    return;
  }

  const totalKm = elevTotalDist || 0;
  const distEl = document.getElementById("statDistance");
  const altEl  = document.getElementById("statAlt");

  let minDist = Infinity;
  let bestIdx = -1;

  for (let i = 0; i < routeLatLngs.length; i++){
    const [rlat, rlng] = routeLatLngs[i];
    const d = distanceKm(lat, lng, rlat, rlng) * 1000;
    if (d < minDist){
      minDist = d;
      bestIdx = i;
    }
  }

  if (!isOnRoute){
    if (minDist > 100){
      distEl.textContent = `-- / ${totalKm.toFixed(1)} km`;
      return;
    }
    isOnRoute = true;
    routeStartIndex = bestIdx;
    routeStartKm = elevPoints[bestIdx]?.dist || 0;
    console.log("âœ… å·²è¿›å…¥å¾’æ­¥èµ·ç‚¹ index =", bestIdx);
  }

  const curKm = elevPoints[bestIdx]?.dist || 0;
  let doneKm = curKm - routeStartKm;

  if (minDist > 100){
    doneKm = - (minDist / 1000);
  }

  distEl.textContent =
    `${doneKm.toFixed(1)} km / ${totalKm.toFixed(1)} km`;

  const curEle = elevPoints[bestIdx]?.ele ?? "--";
  const maxEle = Math.max(...elevPoints.map(p => p.ele || 0));

  altEl.textContent =
    `${Math.round(curEle)} m / ${Math.round(maxEle)} m`;

  currentProgressKm = Math.max(0, doneKm);
  if (typeof updateCursorByDist === "function"){
    if (window.setProgressKm){ setProgressKm(currentProgressKm, "gps"); } else { updateCursorByDist(currentProgressKm); }
  }
}




    function distanceKm(aLat, aLng, bLat, bLng){
      const R = 6371;
      const dLat = (bLat - aLat) * Math.PI / 180;
      const dLng = (bLng - aLng) * Math.PI / 180;
      const la1  = aLat * Math.PI / 180;
      const la2  = bLat * Math.PI / 180;
      const sinDLat = Math.sin(dLat / 2);
      const sinDLng = Math.sin(dLng / 2);
      const c = 2 * Math.asin(
        Math.sqrt(
          sinDLat * sinDLat +
          Math.cos(la1) * Math.cos(la2) * sinDLng * sinDLng
        )
      );
      return R * c;
    }

    const elevCanvas = document.getElementById("elevCanvas");
    const elevCtx    = elevCanvas ? elevCanvas.getContext("2d") : null;
    const elevPanel  = document.getElementById("elevPanel");
    const elevTooltip= document.getElementById("elevTooltip");
    if (elevTooltip){
      elevTooltip.style.left = "12px";
      elevTooltip.style.top  = "12px";
    }

  function drawElevationProfile(progressKm){
  if (!elevCanvas || !elevCtx || !elevPoints.length) return;

  const w = elevCanvas.clientWidth || 320;
  const h = elevCanvas.clientHeight || 120;
  elevCanvas.width  = w;
  elevCanvas.height = h;

  elevCtx.clearRect(0, 0, w, h);

  const total  = elevTotalDist || elevPoints[elevPoints.length - 1].dist || 0.001;
  const maxEle = Math.max(...elevPoints.map(p => p.ele));
  const minEle = Math.min(...elevPoints.map(p => p.ele));

  const paddingBottom = 45;
  const paddingTop    = 8;
  const usableHeight  = h - paddingTop - paddingBottom;
  const baseY         = h - paddingBottom;

  if (typeof progressKm === "number") {
    currentProgressKm = Math.max(0, Math.min(progressKm, total));
  }
  const safeProgress = currentProgressKm;

  function project(p){
    const x = (p.dist / total) * w;
    const y = baseY - ((p.ele - minEle) / (maxEle - minEle || 1)) * usableHeight;
    return { x, y };
  }

  /* ===== å·²å®ŒæˆåŒºåŸŸå¡«å…… ===== */
  if (safeProgress > 0){
    elevCtx.beginPath();
    elevCtx.moveTo(0, baseY);

    for (let i = 0; i < elevPoints.length; i++){
      const p = elevPoints[i];
      if (p.dist > safeProgress){
        const prev = elevPoints[i - 1] || p;
        const r = (safeProgress - prev.dist) / (p.dist - prev.dist || 1);
        const ele = prev.ele + r * (p.ele - prev.ele);
        const proj = project({ dist: safeProgress, ele });
        elevCtx.lineTo(proj.x, proj.y);
        break;
      } else {
        const proj = project(p);
        elevCtx.lineTo(proj.x, proj.y);
      }
    }

    elevCtx.lineTo((safeProgress / total) * w, baseY);
    elevCtx.closePath();
    elevCtx.fillStyle = "rgba(160,130,70,0.9)";
    elevCtx.fill();
  }

  /* ===== ä¸»å‰–é¢çº¿ ===== */
  elevCtx.beginPath();
  elevPoints.forEach((p, i) => {
    const proj = project(p);
    i === 0 ? elevCtx.moveTo(proj.x, proj.y) : elevCtx.lineTo(proj.x, proj.y);
  });
  elevCtx.strokeStyle = "#ffffff";
  elevCtx.lineWidth = 2;
  elevCtx.stroke();

  /* ===== åŸºçº¿ ===== */
  elevCtx.beginPath();
  elevCtx.moveTo(0, baseY + 0.5);
  elevCtx.lineTo(w, baseY + 0.5);
  elevCtx.strokeStyle = "rgba(255,255,255,0.35)";
  elevCtx.lineWidth = 1;
  elevCtx.stroke();

  /* ===== ç«–çº¿ + å°çƒ ===== */
  if (cursorDist != null) {
    const dist = Math.max(0, Math.min(cursorDist, total));

    let nearest = elevPoints[0];
    let minDiff = Math.abs(dist - nearest.dist);
    for (let i = 1; i < elevPoints.length; i++){
      const d = Math.abs(dist - elevPoints[i].dist);
      if (d < minDiff){
        minDiff = d;
        nearest = elevPoints[i];
      }
    }

    const projPoint = project(nearest);

  // â˜… æ˜¯å¦æ­£å¥½å‘½ä¸­å¤©æ°”èŠ‚ç‚¹ï¼ˆä»¥ profile ç‚¹ä¸ºå‡†ï¼‰
// â˜… æ˜¯å¦æ­£å¥½å‘½ä¸­å¤©æ°”èŠ‚ç‚¹ï¼ˆç»Ÿä¸€åˆ°â€œç»å¯¹ kmâ€åæ ‡ç³»ï¼‰
let wxHit = false;
const absKm = (typeof routeStartKm === "number")
  ? routeStartKm + nearest.dist
  : nearest.dist;

if (Array.isArray(window.__WEATHER_NODES)) {
  for (const n of window.__WEATHER_NODES) {
    const km = Number(n.km ?? n.positionKm);
    if (
      Number.isFinite(km) &&
      Math.abs(km - absKm) < 0.05   // 50 ç±³å®¹å·®
    ) {
      wxHit = true;
      break;
    }
  }
}



    /* â€”â€” ç«–çº¿ â€”â€” */
    elevCtx.beginPath();
    elevCtx.moveTo(projPoint.x, baseY);
    elevCtx.lineTo(projPoint.x, projPoint.y);
    elevCtx.strokeStyle = wxHit
      ? "rgba(255,180,0,0.95)"
      : "rgba(255,255,255,0.85)";
    elevCtx.lineWidth = wxHit ? 4 : 1.5;
    elevCtx.stroke();

    /* â€”â€” å°çƒ â€”â€” */
    elevCtx.beginPath();
    elevCtx.arc(projPoint.x, projPoint.y, wxHit ? 5 : 4, 0, Math.PI * 2);
    elevCtx.fillStyle = wxHit
      ? "rgba(255,180,0,0.98)"
      : "#ffffff";
    elevCtx.fill();
  }
}



// ================================
// å·¦ä¸Šè§’ï¼šå¤©æ°”ï¼ˆéšå½“å‰ä½ç½® km å˜åŒ–ï¼‰
// ä¾èµ–ï¼šwindow.__WEATHER_NODESï¼ˆ
// ==============================
// å·¦ä¸Šè§’å¤©æ°”ï¼šç»Ÿä¸€ç®€å†™å‡ºå£ï¼ˆç¦æ­¢ç›´æ¥å†™ DOMï¼‰
// ==============================


// âœ… å…¨å±€å”¯ä¸€ï¼šæŒ‰ km å‘½ä¸­å¤©æ°”èŠ‚ç‚¹ + æ›´æ–°UI
function updateWeatherByKm(currentKm) {
  const nodes = window.__WEATHER_NODES;
  const weatherEl = document.getElementById("statWeather");      // å·¦ä¸Šè§’å¡ç‰‡å¤©æ°”
  const strip = document.getElementById("weatherStrip");         // åº•éƒ¨å¤©æ°”èŠ‚ç‚¹æ¡ï¼ˆå¦‚å­˜åœ¨ï¼‰
  const elevWxEl = document.getElementById("elevWeatherText");   // å‰–é¢å›¾åº•éƒ¨å¤©æ°”æ 

  // æ²¡æœ‰ä»»ä½•èŠ‚ç‚¹ï¼šæ¸…ç©º
  if (!Array.isArray(nodes) || nodes.length === 0) {
    if (weatherEl) weatherEl.textContent = "--";
    if (elevWxEl) elevWxEl.textContent = "--";
    if (strip) strip.querySelectorAll(".weather-node").forEach(el => el.classList.remove("active"));
    window.__WX_HIT_INDEX = 0;
    window.__CURSOR_AT_WX_NODE = false;
    return;
  }

  // è§„åˆ™ï¼šä¸åœ¨è½¨è¿¹é™„è¿‘ / æ— æœ‰æ•ˆ km â†’ å›é€€åˆ°èµ·ç‚¹ï¼ˆ0 kmï¼‰
  const k = Number(currentKm);
  const kmNow = Number.isFinite(k) ? k : 0;

  // å‘½ä¸­è§„åˆ™ï¼šå–æœ€åä¸€ä¸ª positionKm <= kmNowï¼ˆä½ ä¹‹å‰å·²éªŒè¯å¯ç”¨ï¼‰
  let hitIndex = 0;
  for (let i = 0; i < nodes.length; i++) {
    const p = Number(nodes[i]?.positionKm ?? nodes[i]?.km ?? nodes[i]?.distKm ?? 0);
    if (Number.isFinite(p) && p <= kmNow) hitIndex = i;
  }
  const hit = nodes[hitIndex] || nodes[0] || {};

  // --- å–å€¼ï¼šshortNameï¼ˆå¸¦æ¸©åº¦åŒºé—´ï¼‰---
  const shortName = String(
    hit.shortName ?? hit.short ?? hit.brief ?? hit.weatherBrief ?? hit.weather ?? hit.name ?? "--"
  ).trim() || "--";

  // --- é£ / UV / ä½“æ„Ÿï¼ˆåªç»™å‰–é¢æ ç”¨ï¼‰---
  const windVal = (hit.wind ?? hit.windSpeed ?? hit.wind_ms ?? hit.windMps);
  const wind = (windVal != null && String(windVal).trim() !== "") ? String(windVal).trim() : "";

  const uvVal = (hit.uv ?? hit.uvIndex ?? hit.uv_i);
  const uv = (uvVal != null && Number.isFinite(Number(uvVal)))
    ? String(Number(uvVal).toFixed(1)).replace(/\.0$/, "")
    : "";

  const feelsVal = (hit.feelsLike ?? hit.apparentT ?? hit.apparentTemp ?? hit.feels ?? hit.feelsC);
  let feels = "";
  if (feelsVal != null && String(feelsVal).trim() !== "") {
    // å…è®¸ JSON ç›´æ¥ç»™ "18Â°C" æˆ– 18
    const s = String(feelsVal).trim();
    feels = /Â°/.test(s) ? s : `${s}Â°C`;
  }

  // ==============================
  // 1) å·¦ä¸Šè§’å¡ç‰‡ï¼šåªæ˜¾ç¤º shortName
  // ==============================
  if (weatherEl) weatherEl.textContent = shortName;

 // ==============================
// 2) å‰–é¢åº•éƒ¨å¤©æ°”æ ï¼šshortNameï½œé£ï½œUVï½œä½“æ„Ÿï½œé™æ°´
// ==============================
if (elevWxEl) {
  const parts = [];

  // 1ï¸âƒ£ ç®€ç§°ï¼ˆé˜´ï½œ12â€“26â„ƒï¼‰
  parts.push(shortName);

  // 2ï¸âƒ£ é£é€Ÿï¼ˆå…è®¸æ•°å­— 0 / 10ï¼‰
  if (wind !== undefined && wind !== null && String(wind).trim() !== "") {
    parts.push(`ğŸŒ¬ ${wind}m/s`);
  }

  // 5ï¸âƒ£ â­ é™æ°´æ¦‚ç‡ï¼ˆpop = 0 ä¹Ÿå¿…é¡»æ˜¾ç¤ºï¼‰
  if (hit.pop !== undefined && hit.pop !== null) {
    parts.push(`ğŸŒ§ ${hit.pop}%`);
  }
 // 3ï¸âƒ£ UV
  if (uv !== undefined && uv !== null) {
    parts.push(`UV ${uv}`);
  }
  // 4ï¸âƒ£ â­ ä½“æ„Ÿæ¸©åº¦ï¼ˆJSON å­—æ®µå°±æ˜¯ feelï¼‰
  if (hit.feel !== undefined && hit.feel !== null) {
    parts.push(`ä½“æ„Ÿ ${hit.feel}Â°C`);
  }


  elevWxEl.textContent = parts.join("ï½œ");
}


 // ==============================
// 3) åº•éƒ¨å¤©æ°”èŠ‚ç‚¹æ¡ï¼šå‘½ä¸­æ—¶æ˜¾ç¤ºé»„è‰²ç«–æ¡
// ==============================
if (strip) {
  const items = strip.querySelectorAll(".weather-node");

  // 1ï¸âƒ£ èŠ‚ç‚¹ active çŠ¶æ€ï¼ˆä¿ç•™ï¼‰
  items.forEach((el, idx) => {
    el.classList.toggle("active", idx === hitIndex);
  });

  // 2ï¸âƒ£ è®¾ç½® CSS å˜é‡ï¼šå½“å‰å‘½ä¸­ index + æ€»æ•°
  strip.style.setProperty("--wx-hit-index", hitIndex);
  strip.style.setProperty("--wx-count", items.length);

  // 3ï¸âƒ£ ä»…åœ¨â€œå‘½ä¸­èŠ‚ç‚¹â€æ—¶æ˜¾ç¤ºç«–æ¡
  strip.classList.add("wx-hit");

  // 4ï¸âƒ£ å¯é€‰ï¼šçŸ­å»¶æ—¶åæ·¡å‡ºï¼ˆä¸å¸¸é©»ï¼‰
  clearTimeout(strip.__wxHideTimer);
  strip.__wxHideTimer = setTimeout(() => {
    strip.classList.remove("wx-hit");
  }, 300); // 300msï¼Œè¶³å¤Ÿæ˜æ˜¾ä½†ä¸å¹²æ‰°
}


  window.__WX_HIT_INDEX = hitIndex;

// âœ… åªåœ¨â€œéå¸¸æ¥è¿‘èŠ‚ç‚¹kmâ€æ—¶ï¼Œæ‰è®¤ä¸ºå‘½ä¸­ï¼ˆç”¨äºç«–çº¿/å°çƒé«˜äº®ï¼‰
const hitKm = Number(hit?.positionKm ?? hit?.km ?? hit?.distKm ?? 0);
const nearThresholdKm = 0.06; // 60ç±³å·¦å³ï¼Œä½ å¯æ”¹æˆ 0.03/0.1
window.__CURSOR_AT_WX_NODE =
  Number.isFinite(hitKm) && Math.abs(kmNow - hitKm) <= nearThresholdKm;

}

// âœ… å…¼å®¹æ—§è°ƒç”¨ï¼šæ‰€æœ‰åœ°æ–¹ç»§ç»­ call updateStatWeatherByKm
function updateStatWeatherByKm(km) {
  updateWeatherByKm(km);
}


function updateCursorByDist(distKm){
      if (!elevPoints.length || !elevCanvas) return;

      const total = elevTotalDist || elevPoints[elevPoints.length - 1].dist || 0.001;
      cursorDist = Math.max(0, Math.min(distKm, total));

      // âœ… å‰–é¢ç«–çº¿å˜åŒ–æ—¶ï¼šåŒæ­¥æ›´æ–°å¤©æ°”ï¼ˆå·¦ä¸Šè§’ + å‰–é¢åº•éƒ¨å¤©æ°”æ ï¼‰
      if (typeof updateStatWeatherByKm === "function") {
        updateStatWeatherByKm(cursorDist);
      }

      let nearestIdx = 0;
      let minDiff    = Math.abs(cursorDist - elevPoints[0].dist);
      for (let i = 1; i < elevPoints.length; i++){
        const d = Math.abs(cursorDist - elevPoints[i].dist);
        if (d < minDiff){
          minDiff = d;
          nearestIdx = i;
        }
      }

      const p   = elevPoints[nearestIdx];
      const ele = p.ele;

      let slopePct = 0;
      if (nearestIdx > 0 && nearestIdx < elevPoints.length - 1){
        const p1 = elevPoints[nearestIdx - 1];
        const p2 = elevPoints[nearestIdx + 1];
        const rise  = p2.ele - p1.ele;
        const runKm = (p2.dist - p1.dist) || 0.000001;
        const runM  = runKm * 1000;
        slopePct = runM > 0 ? (rise / runM) * 100 : 0;
      }

      cursorInfo = {
        dist:  cursorDist,
        ele:   ele,
        slope: slopePct
      };

      // åŒæ­¥å·¦ä¸Šè§’å¤©æ°”ï¼ˆéšå½“å‰ä½ç½®å˜åŒ–ï¼‰
      updateStatWeatherByKm(cursorDist);

      if (elevPanel && elevTooltip){
        const rectCanvas = elevCanvas.getBoundingClientRect();
        const rectPanel  = elevPanel.getBoundingClientRect();
        const ratio      = cursorDist / total;
        const xInCanvas  = ratio * rectCanvas.width;
        const xInPanel   = rectCanvas.left - rectPanel.left + xInCanvas;

        elevTooltip.style.display = "block";
        //elevTooltip.style.left    = xInPanel + "px";
        //elevTooltip.style.top     = (rectCanvas.top - rectPanel.top + 36) + "px";

        const dLabel = cursorDist.toFixed(1).replace(/\.0$/, "");
        const hLabel = Math.round(ele);
        const sLabel = Math.round(slopePct);

        elevTooltip.innerHTML =
          `<span class="elev-tooltip-label">é‡Œç¨‹</span> ` +
          `<span class="elev-tooltip-value">${dLabel} km</span><br>` +
          `<span class="elev-tooltip-label">æµ·æ‹”</span> ` +
          `<span class="elev-tooltip-value">${hLabel} m</span><br>` +
          `<span class="elev-tooltip-label">å¡åº¦</span> ` +
          `<span class="elev-tooltip-value">${sLabel}%</span>`;
      }

      drawElevationProfile(currentProgressKm);
    }

    function handleElevPointer(clientX){
      if (!elevCanvas || !elevPoints.length) return;

      const rect  = elevCanvas.getBoundingClientRect();
      const total = elevTotalDist || elevPoints[elevPoints.length - 1].dist || 0.001;

      let x = clientX - rect.left;
      x = Math.max(0, Math.min(x, rect.width));

      const ratio  = x / rect.width;
      const distKm = ratio * total;

      updateCursorByDist(distKm);
    }

    function initRouteFromGpx(){
      const gpxPath = cfgHome.gpxFile || "assets/track/tongariro.gpx";

      fetch(gpxPath)
        .then(res => res.ok ? res.text() : "")
        .then(text => {
          if (!text) return;

          const xml = new DOMParser().parseFromString(text, "application/xml");
          const pts = Array.from(xml.getElementsByTagName("trkpt"));
          if (!pts.length) return;

          const latlngs = [];
          elevPoints    = [];
          window.elevPoints = elevPoints;
          elevTotalDist = 0;
          window.elevTotalDist = elevTotalDist;

          let prevLat = null;
          let prevLng = null;

          pts.forEach(function(pt){
            const lat = parseFloat(pt.getAttribute("lat"));
            const lng = parseFloat(pt.getAttribute("lon"));
            const eleNode = pt.getElementsByTagName("ele")[0];
            const ele = eleNode ? parseFloat(eleNode.textContent) : 0;

            latlngs.push([lat, lng]);

            if (prevLat !== null && prevLng !== null){
              elevTotalDist += distanceKm(prevLat, prevLng, lat, lng);
            }
            elevPoints.push({
              dist: elevTotalDist,
              ele:  ele
            });

            prevLat = lat;
            prevLng = lng;
          });

          const line = L.polyline(latlngs, { color:"#ef4444", weight:4 }).addTo(map);
          routeBounds = line.getBounds();
          if (routeBounds) map.fitBounds(routeBounds.pad(0.15));

          routeLatLngs = latlngs.slice();

          let doneKm = 0;

// ğŸš« ä¸å†ä» UI åæ¨è¿›åº¦ï¼ˆUI å·²ç»ä¸å¯ä¿¡ï¼‰
currentProgressKm = doneKm;
cursorDist        = doneKm;

drawElevationProfile(doneKm);

        })
        .catch(()=>{});
    }

    const btnNorth       = document.getElementById("btnNorth");
    const btnLayerToggle = document.getElementById("btnLayerToggle");
    const btnCache       = document.getElementById("btnCache");
    const btnPlay        = document.getElementById("btnPlay");
    const btnLocateRoute = document.getElementById("btnLocateRoute");
    const btnNodeToggle  = document.getElementById("btnNodeToggle");
    const cacheStatus    = document.getElementById("cacheStatus");

    /* å‰–é¢æ ‡ç­¾æ‹–åŠ¨ï¼ˆé¡¶éƒ¨å·¦å³æ‹–ï¼‰ */
    let tooltipDragActive = false;
    let tooltipStartX = 0;
    let tooltipBaseLeft = 0;

    function tooltipDragStart(clientX){
      if (!elevTooltip || !elevPanel) return;
      const panelRect = elevPanel.getBoundingClientRect();
      const tipRect   = elevTooltip.getBoundingClientRect();
      tooltipDragActive = true;
      tooltipStartX     = clientX;
      tooltipBaseLeft   = tipRect.left - panelRect.left;
    }
    function tooltipDragMove(clientX){
      if (!tooltipDragActive || !elevTooltip || !elevPanel) return;
      const panelRect = elevPanel.getBoundingClientRect();
      const tipRect   = elevTooltip.getBoundingClientRect();
      let left = tooltipBaseLeft + (clientX - tooltipStartX);
      const padding = 8;
      const maxLeft = panelRect.width - tipRect.width - padding;
      if (left < padding) left = padding;
      if (left > maxLeft) left = maxLeft;
      elevTooltip.style.left = left + "px";
      elevTooltip.style.top  = "8px";
    }
    function tooltipDragEnd(){
      tooltipDragActive = false;
    }

    if (elevTooltip){
      elevTooltip.addEventListener("mousedown", function(e){
        e.preventDefault();
        tooltipDragStart(e.clientX);
      });
      window.addEventListener("mousemove", function(e){
        tooltipDragMove(e.clientX);
      });
      window.addEventListener("mouseup", tooltipDragEnd);

      elevTooltip.addEventListener("touchstart", function(e){
        const t = e.touches[0];
        tooltipDragStart(t.clientX);
      }, { passive:true });
      window.addEventListener("touchmove", function(e){
        const t = e.touches[0];
        tooltipDragMove(t.clientX);
      }, { passive:true });
      window.addEventListener("touchend", tooltipDragEnd);
      window.addEventListener("touchcancel", tooltipDragEnd);
    }

    let elevDragging = false;
    if (elevCanvas){
      elevCanvas.addEventListener("mousedown", function(e){
        elevDragging = true;
        handleElevPointer(e.clientX);
      });
      window.addEventListener("mousemove", function(e){
        if (elevDragging) handleElevPointer(e.clientX);
      });
      window.addEventListener("mouseup", function(){
        elevDragging = false;
      });

      elevCanvas.addEventListener("touchstart", function(e){
        elevDragging = true;
        handleElevPointer(e.touches[0].clientX);
      });
      window.addEventListener("touchmove", function(e){
        if (elevDragging) handleElevPointer(e.touches[0].clientX);
      }, { passive:true });
      window.addEventListener("touchend", function(){
        elevDragging = false;
      });
    }

         /* æŠ½å±‰å¼€å…³é€»è¾‘ */
    const drawerPanel       = document.getElementById("sceneDrawerPanel");
    const sceneDrawerHandle = document.getElementById("sceneDrawerHandle");
    const sceneDrawerClose  = document.getElementById("sceneDrawerClose");
    const sceneSpeedDisplay = document.getElementById("sceneSpeedDisplay");
    const sceneDrawerHeader = document.querySelector(".scene-drawer-header");

    // æŠ½å±‰é«˜åº¦æ¨¡å¼ï¼šsmall = 1/3ï¼Œé«˜åº¦ï¼›tall = 2/3 é«˜åº¦
    let drawerHeightMode = "small";

    function setDrawerHeightMode(mode){
      if (!drawerPanel) return;
      drawerHeightMode = mode;
      if (mode === "tall"){
        drawerPanel.classList.add("drawer-tall");
      }else{
        drawerPanel.classList.remove("drawer-tall");
      }
    }
    // é»˜è®¤ 1/3 é«˜åº¦
    setDrawerHeightMode("small");

    function toggleDrawer(){
  if (!drawerPanel) return;
  const isOpen = drawerPanel.classList.contains("open");

  if (isOpen){
    // å…³é—­æ—¶é¡ºä¾¿æŠŠé«˜åº¦æ¡£ä½å¤ä½æˆ 1/3
    drawerPanel.classList.remove("open");
    setDrawerHeightMode("small");
  }else{
    // æ¯æ¬¡æ‰“å¼€å‰ï¼Œå…ˆç¡®ä¿æ˜¯ 1/3 é«˜åº¦
    setDrawerHeightMode("small");
    drawerPanel.classList.add("open");
  }
}

    if (sceneDrawerHandle){
      sceneDrawerHandle.addEventListener("click", toggleDrawer);
    }
    if (sceneDrawerClose){
      sceneDrawerClose.addEventListener("click", toggleDrawer);
    }

    // åœ¨æŠ½å±‰å¤´éƒ¨ä¸Š/ä¸‹æ»‘æ‰‹åŠ¿ï¼š1/3 â†” 2/3 é«˜åº¦
    let drawerDragActive = false;
    let drawerDragStartY = 0;

    function drawerDragStart(y){
      drawerDragActive = true;
      drawerDragStartY = y;
    }
    function drawerDragMove(y){
      if (!drawerDragActive) return;
      const delta = y - drawerDragStartY;

      // å‘ä¸Šæ»‘ï¼Œæ‹‰é«˜åˆ° 2/3
      if (drawerHeightMode === "small" && delta < -30){
        setDrawerHeightMode("tall");
        drawerDragActive = false;
      }
      // å‘ä¸‹æ»‘ï¼Œé™å› 1/3
      else if (drawerHeightMode === "tall" && delta > 30){
        setDrawerHeightMode("small");
        drawerDragActive = false;
      }
    }
    function drawerDragEnd(){
      drawerDragActive = false;
    }

    if (sceneDrawerHeader){
      // é¼ æ ‡ï¼ˆè°ƒè¯•ç”¨ï¼‰
      sceneDrawerHeader.addEventListener("mousedown", function(e){
        e.preventDefault();
        drawerDragStart(e.clientY);
      });
      window.addEventListener("mousemove", function(e){
        drawerDragMove(e.clientY);
      });
      window.addEventListener("mouseup", drawerDragEnd);

      // è§¦æ‘¸ï¼ˆæ‰‹æœºå®é™…æ“ä½œï¼‰
      sceneDrawerHeader.addEventListener("touchstart", function(e){
        const t = e.touches[0];
        drawerDragStart(t.clientY);
      }, { passive:true });
      window.addEventListener("touchmove", function(e){
        if (!e.touches || !e.touches[0]) return;
        drawerDragMove(e.touches[0].clientY);
      }, { passive:true });
      window.addEventListener("touchend", drawerDragEnd);
      window.addEventListener("touchcancel", drawerDragEnd);
    }

    // ç‚¹å‡»â€œå½“å‰è¡Œè¿›é€Ÿåº¦â€ åˆ‡æ¢ 30'/km â†” 2km/hï¼ˆæ ¹æ® data-pace-min-per-km è‡ªåŠ¨æ¢ç®—ï¼‰
    if (sceneSpeedDisplay){
      sceneSpeedDisplay.addEventListener("click", function(){
        // è¯»å–é…é€Ÿï¼ˆåˆ†é’Ÿ / å…¬é‡Œï¼‰
    const paceMinPerKm = window.UI_STATE.paceMinPerKm;
if (!paceMinPerKm || paceMinPerKm <= 0) return;

        if (!paceMinPerKm || paceMinPerKm <= 0) return;

        const mode = sceneSpeedDisplay.getAttribute("data-mode") || "pace";

        if (mode === "pace"){
          // åˆ‡æ¢æˆ km/hï¼šæ—¶é€Ÿ = 60 / æ¯å…¬é‡Œåˆ†é’Ÿæ•°
          const kmh = 60 / paceMinPerKm;
          const kmhStr = (Math.round(kmh * 10) / 10).toFixed(1);  // 1 ä½å°æ•°
          sceneSpeedDisplay.textContent = "å½“å‰è¡Œè¿›é€Ÿåº¦ï¼š" + kmhStr + " km/h";
          sceneSpeedDisplay.setAttribute("data-mode", "speed");
        }else{
          // åˆ‡å› 30'/km è¿™ç§é…é€Ÿæ˜¾ç¤º
                    // é…é€Ÿæ˜¾ç¤ºï¼š<60 åˆ†é’Ÿç”¨ 30â€²/kmï¼›>=60 åˆ†é’Ÿç”¨ 1.5h/km
          if (paceMinPerKm < 60){
            sceneSpeedDisplay.textContent = "å½“å‰è¡Œè¿›é…é€Ÿï¼š" + Math.round(paceMinPerKm) + "â€²/km";
          }else{
            const hpk = (Math.round((paceMinPerKm/60)*10)/10);
            sceneSpeedDisplay.textContent = "å½“å‰è¡Œè¿›é…é€Ÿï¼š" + hpk + " h/km";
          }
          sceneSpeedDisplay.setAttribute("data-mode", "pace");
        }
      });
    }

    function setDrawerHandleSceneActive(active){
      if (!sceneDrawerHandle) return;
      if (active){
        sceneDrawerHandle.classList.add("scene-drawer-handle--active");
      }else{
        sceneDrawerHandle.classList.remove("scene-drawer-handle--active");
      }
    }


    function showStatus(msg){
      if (!cacheStatus) return;
      cacheStatus.textContent = msg;
      cacheStatus.style.display = "block";
      setTimeout(function(){
        cacheStatus.style.display = "none";
      }, 2500);
    }

    if (btnNorth){
      btnNorth.addEventListener("click", function(){
        btnNorth.classList.toggle("active");
        if (routeBounds) map.fitBounds(routeBounds.pad(0.15));
      });
    }

    if (btnLayerToggle){
      btnLayerToggle.addEventListener("click", function(){
        btnLayerToggle.classList.toggle("active");
        if (currentLayer === "outdoor"){
          map.removeLayer(outdoorLayer);
          map.addLayer(satLayer);
          currentLayer = "sat";
        }else{
          map.removeLayer(satLayer);
          map.addLayer(outdoorLayer);
          currentLayer = "outdoor";
        }
      });
    }

    if (btnCache){
      btnCache.addEventListener("click", function(){
        showStatus("å½“å‰ç‰ˆæœ¬åªæ”¯æŒåœ¨çº¿åœ°å›¾ï¼Œç¼“å­˜åŠŸèƒ½å…ˆæ”¾ä¸€æ”¾ã€‚");
      });
    }

    if (btnLocateRoute){
      btnLocateRoute.addEventListener("click", function(){
        if (!navigator.geolocation){
          showStatus("å½“å‰è®¾å¤‡ä¸æ”¯æŒå®šä½åŠŸèƒ½");
          return;
        }
        showStatus("æ­£åœ¨è·å–å½“å‰ä½ç½®â€¦");

        navigator.geolocation.getCurrentPosition(
          function(pos){
            var lat = pos.coords.latitude;
            var lng = pos.coords.longitude;
            updateStatsCardByGps(lat, lng, pos.timestamp);

            var latlng = [lat, lng];

            if (!userMarker){
              userMarker = L.circleMarker(latlng, {
                radius:6,
                color:"#2563eb",
                weight:3,
                fillColor:"#3b82f6",
                fillOpacity:0.85
              }).addTo(map);
            } else {
              userMarker.setLatLng(latlng);
            }

            var targetZoom = Math.max(map.getZoom(), 15);
            map.setView(latlng, targetZoom);

            showStatus("å·²å®šä½åˆ°å½“å‰ä½ç½®");

// âœ… å¼€å§‹æŒç»­ GPS è·Ÿè¸ªï¼ˆç”¨äºå®æ—¶é€Ÿåº¦/é…é€Ÿ/æ—¶é—´ï¼‰
// åªåœ¨ç¬¬ä¸€æ¬¡ç‚¹å‡»â€œå®šä½â€æ—¶å¯åŠ¨ä¸€æ¬¡ï¼Œé¿å…é‡å¤ watch
if (!window.__GPS_WATCH_ID && navigator.geolocation && navigator.geolocation.watchPosition){
  window.__GPS_WATCH_ID = navigator.geolocation.watchPosition(
    function(p){
      const lat2 = p.coords.latitude;
      const lng2 = p.coords.longitude;
      updateStatsCardByGps(lat2, lng2, p.timestamp);

      const latlng2 = [lat2, lng2];
      if (userMarker) userMarker.setLatLng(latlng2);
    },
    function(e){
      // ä¸å¼¹çª—ï¼Œåªåœ¨çŠ¶æ€æ æç¤º
      console.warn("watchPosition error", e);
    },
    { enableHighAccuracy:true, maximumAge:1000, timeout:10000 }
  );
}
          },
          function(err){
            var msg = "å®šä½å¤±è´¥";
            if (err.code === 1)      msg = "å®šä½è¢«æ‹’ç»ï¼Œè¯·åœ¨æµè§ˆå™¨ä¸­å…è®¸è®¿é—®ä½ç½®";
            else if (err.code === 2) msg = "æ— æ³•è·å–å½“å‰ä½ç½®ï¼ˆä¿¡å·ä¸ä½³ï¼‰";
            else if (err.code === 3) msg = "å®šä½è¶…æ—¶ï¼Œè¯·ç¨åå†è¯•";
            showStatus(msg);
          },
          {
            enableHighAccuracy:true,
            timeout:10000,
            maximumAge:30000
          }
        );
      });
    }

    document.querySelectorAll(".tab-btn").forEach(function(btn){
      const href = btn.dataset.href;
      if (href){
        btn.addEventListener("click", function(){
          window.location.href = href;
        });
      }
    });

    /* è§†é¢‘é€»è¾‘ */
    const videoOverlay     = document.getElementById("videoOverlay");
    const routeVideo       = document.getElementById("routeVideo");
    const videoBtnBack     = document.getElementById("videoBtnBack");
    const videoBtnPlayPause= document.getElementById("videoBtnPlayPause");
    const iconPlayPause    = document.getElementById("iconPlayPause");
    const videoBtnForward  = document.getElementById("videoBtnForward");
    const videoBtnClose    = document.getElementById("videoBtnClose");
    const videoBtnSpeed    = document.getElementById("videoBtnSpeed");
    const videoSpeedLabel  = document.getElementById("videoSpeedLabel");
    const speedList  = [0.5, 0.8, 1.0, 1.2, 1.5];
    let   speedIndex = 2;

    function updatePlayIcon(){
      if (!iconPlayPause || !routeVideo) return;
      if (routeVideo.paused){
        iconPlayPause.classList.remove("icon-pause");
        iconPlayPause.classList.add("icon-play");
      }else{
        iconPlayPause.classList.remove("icon-play");
        iconPlayPause.classList.add("icon-pause");
      }
    }
    function setPlaybackRate(rate){
      if (!routeVideo || !videoSpeedLabel) return;
      routeVideo.playbackRate = rate;
      videoSpeedLabel.textContent = rate.toFixed(1);
    }
    function cycleSpeed(){
      speedIndex = (speedIndex + 1) % speedList.length;
      setPlaybackRate(speedList[speedIndex]);
    }
    function openVideoOverlay(){
      if (!videoOverlay || !routeVideo) return;
      videoOverlay.classList.add("show");
      routeVideo.pause();
      routeVideo.currentTime = 0;
      routeVideo.load();
      setPlaybackRate(speedList[speedIndex]);
      updatePlayIcon();
      routeVideo.play().catch(function(){
        updatePlayIcon();
      });
    }
    function closeVideoOverlay(){
      if (!videoOverlay || !routeVideo) return;
      routeVideo.pause();
      videoOverlay.classList.remove("show");
    }

    if (btnPlay && videoOverlay && routeVideo){
      btnPlay.addEventListener("click", function(){
        openVideoOverlay();
      });
    }
    if (videoBtnBack && routeVideo){
      videoBtnBack.addEventListener("click", function(){
        routeVideo.currentTime = Math.max(0, routeVideo.currentTime - 10);
      });
    }
    if (videoBtnForward && routeVideo){
      videoBtnForward.addEventListener("click", function(){
        routeVideo.currentTime = routeVideo.currentTime + 10;
      });
    }
    if (videoBtnPlayPause && routeVideo){
      videoBtnPlayPause.addEventListener("click", function(){
        if (routeVideo.paused){
          routeVideo.play().catch(function(){});
        }else{
          routeVideo.pause();
        }
      });
    }
    if (videoBtnClose){
      videoBtnClose.addEventListener("click", function(){
        closeVideoOverlay();
      });
    }
    if (videoBtnSpeed){
      videoBtnSpeed.addEventListener("click", function(){
        cycleSpeed();
      });
    }
    if (routeVideo){
      routeVideo.addEventListener("click", function(){
        if (routeVideo.paused){
          routeVideo.play().catch(function(){});
        }else{
          routeVideo.pause();
        }
      });
      routeVideo.addEventListener("play",  updatePlayIcon);
      routeVideo.addEventListener("pause", updatePlayIcon);
      routeVideo.addEventListener("ended", updatePlayIcon);
    }

    /* å‰–é¢å›¾å¼€/å…³ï¼šå¤§å¡ç‰‡æ‰“å¼€ï¼Œå°å¡ç‰‡å…³é—­ */
    const statsCard      = document.getElementById("statsCard");
    const elevClose      = document.getElementById("elevClose");
    const elevTooltipEl  = document.getElementById("elevTooltip");

    function openElevPanel(){
      if (!elevPanel) return;
      elevPanel.style.display = "block";
      if (typeof cursorDist === "number") {
        updateCursorByDist(cursorDist);
      } else {
        updateCursorByDist(currentProgressKm || 0);
      }
    }
    function closeElevPanel(){
      if (!elevPanel) return;
      elevPanel.style.display = "none";
      if (elevTooltip){
        elevTooltip.style.display = "none";
      }
    }
    if (statsCard && elevPanel){
      statsCard.addEventListener("click", function(){
        openElevPanel();
      });
    }
    if (elevTooltipEl && elevPanel){
      elevTooltipEl.addEventListener("click", function(){
        closeElevPanel();
      });
    }
    if (elevClose && elevPanel){
      elevClose.addEventListener("click", function(){
        closeElevPanel();
      });
    }

    /* æ°”æ³¡é€‰ä¸­çŠ¶æ€æ¸…ç† */
    function clearSceneNodeSelection(){
      sceneNodeMarkers.forEach(function(m){
        const el = m.getElement();
        if (!el) return;
        const label = el.querySelector(".poi-label");
        if (label){
          label.classList.remove("poi-label--active");
        }
      });
      setDrawerHandleSceneActive(false);
    }

    
  // ============================================================
  // âœ… ç”¨ JSON åœºæ™¯èŠ‚ç‚¹æ›¿æ¢â€œæ¼”ç¤ºèŠ‚ç‚¹æ°”æ³¡â€ï¼ˆä¸å½±å“å¤©æ°”æ¡ï¼‰
  // è§„åˆ™ï¼š
  // - åªæ¸²æŸ“ model.nodes ä¸­é weather çš„èŠ‚ç‚¹ï¼ˆmanual/terrain ç­‰ï¼‰
  // - åæ ‡ä¼˜å…ˆï¼šstartLat/startLon â†’ startPt.lat/lon â†’ æŒ‰ positionKm/startKm ä» profile/track æ‰¾æœ€è¿‘ç‚¹
  // - å¤ç”¨åŸæœ‰ poi-label å¤–è§‚ä¸äº¤äº’ï¼ˆç™½åº•çº¢å­—ã€ç‚¹å‡»é«˜äº®ã€ç«–çº¿é˜´å½±ï¼‰
  // - ç¼©å°åˆ°ä½ zoom æ—¶è‡ªåŠ¨éšè—ï¼Œé¿å…æ ‡ç­¾å¤–æº¢
  // ============================================================
  function __escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, ch => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[ch]));
  }

  function __pickNearestByKmFromModel(model, km){
    const k = Number(km);
    if (!Number.isFinite(k)) return null;

    const src =
      (model && Array.isArray(model.track) && model.track.length) ? model.track :
      (model && Array.isArray(model.profile) && model.profile.length) ? model.profile :
      [];
    if (!src.length) return null;

    let best = null, bestDiff = Infinity;
    for (let i=0;i<src.length;i++){
      const p = src[i];
      const pk = Number(p.km ?? p.dist ?? p.positionKm ?? p.startKm);
      if (!Number.isFinite(pk)) continue;
      const d = Math.abs(pk - k);
      if (d < bestDiff){ bestDiff = d; best = p; }
    }
    if (!best) return null;
    const lat = Number(best.lat), lon = Number(best.lon);
    if (!Number.isFinite(lat) || !Number.isFinite(lon)) return null;
    return {lat, lon};
  }

  function __getSceneNodeLatLng(model, n){
    // â‘  startLat/startLon
    const lat1 = Number(n.startLat), lon1 = Number(n.startLon);
    if (Number.isFinite(lat1) && Number.isFinite(lon1)) return {lat:lat1, lon:lon1};

    // â‘¡ startPt
    if (n.startPt && Number.isFinite(Number(n.startPt.lat)) && Number.isFinite(Number(n.startPt.lon))){
      return {lat:Number(n.startPt.lat), lon:Number(n.startPt.lon)};
    }

    // â‘¢ æŒ‰ km å» profile/track æ‰¾æœ€è¿‘ç‚¹
    const km =
      (n.positionKm != null) ? n.positionKm :
      (n.startKm != null) ? n.startKm :
      (typeof n.kmRange === "string" ? Number(String(n.kmRange).split("-")[0]) : NaN);
    return __pickNearestByKmFromModel(model, km);
  }

  function __setActivePoiLabel(marker){
  try{
    sceneNodeMarkers.forEach(m=>{
      const el = m.getElement && m.getElement();
      if (!el) return;
      const label = el.querySelector(".poi-label");
      if (label){
        label.classList.remove("poi-label--active");
      }
    });

    const el = marker.getElement && marker.getElement();
    if (el){
      const label = el.querySelector(".poi-label");
      if (label){
        label.classList.add("poi-label--active");
      }
    }
  }catch(e){}
}


  function __applyPoiLabelVisibility(){
    if (!map) return;
    const z = map.getZoom ? map.getZoom() : 0;
    const visible = (z >= 14); // â­ ä½äº 14 ç›´æ¥éšè—ï¼Œé¿å…ç¼©å°æ—¶â€œå¤–æº¢æ¼‚ç§»â€
    sceneNodeMarkers.forEach(m=>{
      const el = m.getElement && m.getElement();
      if (!el) return;
      el.style.display = visible ? "" : "none";
    });
  }

  function renderSceneNodesFromModel(model){
    if (!map || !sceneNodeLayer) return;

    // æ¸…ç©ºæ—§èŠ‚ç‚¹
    sceneNodeLayer.clearLayers();
    sceneNodeMarkers = [];

    const nodes = (model && Array.isArray(model.nodes)) ? model.nodes : [];
        const sceneNodes = nodes.filter(n => {
      const t = String(n && (n.nodeType || n.type) || "").toLowerCase();
      return t === "manual";
    });

    console.log("âœ… JSON åœºæ™¯èŠ‚ç‚¹(éå¤©æ°”) =", sceneNodes.length);

    if (!sceneNodes.length) return;

    sceneNodes.forEach(n=>{
      const pt = __getSceneNodeLatLng(model, n);
      if (!pt) return;

      const label = __escapeHtml(n.shortName || n.title || n.name || "(æœªå‘½å)");
const html = `
  <div class="poi-label">
    <span class="poi-title">${label}</span>
  </div>
`;

const icon = L.divIcon({
  className: "",
  html,
  iconSize: null,
  iconAnchor: [52, 34]
});



      const marker = L.marker(
  [pt.lat, pt.lon],
  { icon, interactive: true }
).addTo(sceneNodeLayer);

// ä¿å­˜åŸæ ‡é¢˜ï¼ˆç”¨äºè¿˜åŸï¼‰
marker.__baseTitle = __escapeHtml(n.shortName || n.title || n.name || "(æœªå‘½å)");

sceneNodeMarkers.push(marker);

marker.on("click", () => {
  const el = marker.getElement && marker.getElement();
  if (!el) return;

  const titleEl = el.querySelector(".poi-title");
  if (!titleEl) return;

  const labelEl = el.querySelector(".poi-label");
  if (!labelEl) return;

  const wasActive = labelEl.classList.contains("poi-label--active");

  // â‘  å…ˆæ¸…æ‰æ‰€æœ‰èŠ‚ç‚¹çš„å‘½ä¸­æ€ï¼Œå¹¶è¿˜åŸæ ‡é¢˜
  sceneNodeMarkers.forEach(m => {
    const mel = m.getElement && m.getElement();
    if (!mel) return;

    const mLabel = mel.querySelector(".poi-label");
    const mTitle = mel.querySelector(".poi-title");

    if (mLabel) mLabel.classList.remove("poi-label--active");
    if (mTitle && m.__baseTitle) {
      mTitle.textContent = m.__baseTitle;
    }
  });

  // â‘¡ å¦‚æœåˆšæ‰ç‚¹çš„æ˜¯â€œå·²å‘½ä¸­â€ â†’ å…³é—­ï¼ˆä»€ä¹ˆéƒ½ä¸åšï¼‰
  if (wasActive) return;

  // â‘¢ è®¾ç½®å½“å‰èŠ‚ç‚¹ä¸ºå‘½ä¸­æ€
  __setActivePoiLabel(marker);

  // â‘£ å‘½ä¸­æ—¶ï¼šåœ¨æ ‡é¢˜åè¿½åŠ ç®€çŸ­æè¿°ï¼ˆè‹¥æœ‰ï¼‰
  const desc = String(n.desc || "").trim();
  if (desc) {
    const shortDesc =
      desc.length > 3
        ? desc.slice(0, 2) + "..."
        : desc;

    titleEl.textContent = `${marker.__baseTitle}ï½œ${shortDesc}`;
  }
});


      // å¯é€‰ï¼šæœ‰æè¿°å°±æŒ‚ popupï¼ˆä¸å½±å“å¤–è§‚ï¼‰
      //const desc = n.desc || n.description || "";
      //if (desc){
      //  marker.bindPopup(`<b>${label}</b><br><div>${__escapeHtml(desc)}</div>`);
      //}
    });

    // æ·»åŠ åˆ°åœ°å›¾
    sceneNodeLayer.addTo(map);

    // zoom æ§åˆ¶ï¼ˆåªç»‘ä¸€æ¬¡ï¼‰
    if (!window.__POI_ZOOM_VIS_BOUND){
      window.__POI_ZOOM_VIS_BOUND = true;
      map.on("zoomend", __applyPoiLabelVisibility);
    }
    __applyPoiLabelVisibility();
    // ================================
// åœ°å›¾ç©ºç™½ç‚¹å‡»ï¼šæ¸…é™¤èŠ‚ç‚¹å‘½ä¸­æ€
// ================================
if (!window.__POI_CLEAR_ACTIVE_BOUND){
  window.__POI_CLEAR_ACTIVE_BOUND = true;

  map.on("click", function(){
    // 1ï¸âƒ£ æ¸… marker å†…éƒ¨ active çŠ¶æ€
    sceneNodeMarkers.forEach(m=>{
      m.__isActive = false;

      const el = m.getElement && m.getElement();
      if (!el) return;

      // è¿˜åŸæ ‡é¢˜
      const titleEl = el.querySelector(".poi-title");
      if (titleEl && m.__nodeTitle){
        titleEl.textContent = m.__nodeTitle;
      }

      // ç§»é™¤é€‰ä¸­æ€æ ·å¼
      const labelEl = el.querySelector(".poi-label");
      if (labelEl){
        labelEl.classList.remove("poi-label--active");
      }
    });

    // 2ï¸âƒ£ æ¸…é™¤æŠ½å±‰çº¢è‰²æé†’
    //__clearDrawerNotice();
  });
}
  }

function buildSceneNodeLayerIfNeeded(){
      if (!map || !routeLatLngs.length) return;
      if (sceneNodeLayer) return;

      sceneNodeLayer = L.layerGroup();

      // âœ… è‹¥ JSON å·²æä¾›äººå·¥/åœ°å½¢èŠ‚ç‚¹ï¼Œåˆ™ç”¨çœŸå®èŠ‚ç‚¹æ›¿æ¢æ¼”ç¤ºèŠ‚ç‚¹
      const model = window.__model || null;
      const hasRealSceneNodes = !!(model && Array.isArray(model.nodes) && model.nodes.some(n=>{
        const t = String(n.nodeType || n.type || "").toLowerCase();
        return t && t !== "weather";
      }));

      if (hasRealSceneNodes){
        renderSceneNodesFromModel(model);
        return; // ä¸å†åˆ›å»ºæ¼”ç¤ºèŠ‚ç‚¹
      }

      // âœ… æ²¡æœ‰çœŸå®èŠ‚ç‚¹ï¼šæ‰è€ƒè™‘æ¼”ç¤ºèŠ‚ç‚¹ï¼ˆå¯é€šè¿‡å¼€å…³å…³é—­ï¼‰
    if (window.__ENABLE_DEMO_NODES === true) {
  renderDemoNodes(map);
}


      const total = routeLatLngs.length;
      if (total === 0) return;
const idxArray = [];
      idxArray.push(0);
      idxArray.push(Math.floor(total * 0.25));
      idxArray.push(Math.floor(total * 0.5));
      idxArray.push(Math.floor(total * 0.75));
      idxArray.push(total - 1);

      const nameArray = ["èµ·ç‚¹","é€”ä¸­è§‚æ™¯ç‚¹","ä¸­æ®µé«˜ç‚¹","ä¸‹å¡å…¥å£","ç»ˆç‚¹"];
      const used = new Set();

      idxArray.forEach(function(rawIdx, i){
        let idx = Math.max(0, Math.min(total - 1, rawIdx));
        if (used.has(idx)) return;
        used.add(idx);

        const latlng = routeLatLngs[idx];
        const name   = nameArray[i] || ("èŠ‚ç‚¹ " + (i + 1));

        const icon = L.divIcon({
          className: "poi-marker",
          html: `<div class="poi-label">${name}</div>`,
          iconSize: null,
          iconAnchor: [16, 34]
        });

        const marker = L.marker(latlng, { icon });
        sceneNodeMarkers.push(marker);

        marker.on("click", function(){
          const el = marker.getElement();
          if (!el) return;
          const label = el.querySelector(".poi-label");
          if (!label) return;

          const isActive = label.classList.contains("poi-label--active");
          if (isActive){
            clearSceneNodeSelection();
            return;
          }

          clearSceneNodeSelection();
          label.classList.add("poi-label--active");
          setDrawerHandleSceneActive(true);
        });

        marker.addTo(sceneNodeLayer);
      });
    }

    if (btnNodeToggle){
      let sceneNodesVisible = false;
      btnNodeToggle.addEventListener("click", function(){
        if (!sceneNodeLayer){
          buildSceneNodeLayerIfNeeded();
        }
        sceneNodesVisible = !sceneNodesVisible;
        btnNodeToggle.classList.toggle("active", sceneNodesVisible);

        if (sceneNodesVisible && sceneNodeLayer){
          sceneNodeLayer.addTo(map);
        } else if (sceneNodeLayer){
          map.removeLayer(sceneNodeLayer);
          clearSceneNodeSelection();
        }
      });
    }

        /* åˆå§‹åŒ– */
initBaseMap();

// å°è¯•ä½¿ç”¨ JSON è·¯çº¿
const usedJson = await tryRenderRouteFromJson();

if (!usedJson) {
  // JSON ä¸å¯ç”¨ â†’ å›é€€ GPX
  console.log("â¡ï¸ å›é€€åˆ° GPX çº¿è·¯");
  initRouteFromGpx();
} else {
  console.log("âœ… å·²ä½¿ç”¨ JSON çº¿è·¯ï¼Œè·³è¿‡ GPX");
}


  })();
  console.log("ğŸ”¥ JS END");
</script>

<!-- =========================================================
     HikingEngine Â· ç‹¬ç«‹æŠ½å±‰æ¸²æŸ“å¼•æ“ï¼ˆä¸å¹²æ‰°åŸç³»ç»Ÿï¼‰
     è¯´æ˜ï¼š
     - åªå†™ #dynamicDrawerContent
     - åªè¯» session.jsonï¼ˆæ”¯æŒå¤šè·¯å¾„å°è¯•ï¼‰
     - 2 ç§’åˆ·æ–°ä¸€æ¬¡
========================================================== -->
<script id="hiking-engine">
(function(){
  "use strict";

  // 1) è½»é‡ CSS ä¿®æ­£ï¼šç¡®ä¿æŠ½å±‰å…³é—­ç®­å¤´å±…ä¸­ï¼ˆä¸å½±å“å…¶å®ƒå¸ƒå±€ï¼‰
  try{
    var style = document.createElement("style");
    style.textContent = `
      #sceneDrawerPanel .scene-drawer-header{display:flex; justify-content:center; align-items:center;}
      #sceneDrawerPanel .scene-drawer-header-center{margin:0 auto; display:flex; justify-content:center; align-items:center;}
      #sceneDrawerPanel .scene-drawer-header-button{margin:0 auto;}
    `;
    document.head.appendChild(style);
  }catch(e){}

  var LOG_PREFIX = "HikingEngine";
  var containerId = "__drawerStatsHidden";

  // session.json å¯èƒ½å­˜åœ¨çš„ç›¸å¯¹è·¯å¾„ï¼ˆæŒ‰ä¼˜å…ˆçº§å°è¯•ï¼‰
  var CANDIDATE_URLS = [
    "session.json",
    "./session.json",
    "../session.json",
    "data/session.json",
    "assets/session.json"
  ];

  function fmtHMS(totalSec){
    totalSec = Math.max(0, Math.floor(Number(totalSec)||0));
    var h = Math.floor(totalSec / 3600);
    var m = Math.floor((totalSec % 3600) / 60);
    var s = totalSec % 60;
    if (h > 0) return h + ":" + String(m).padStart(2,"0") + ":" + String(s).padStart(2,"0");
    return m + ":" + String(s).padStart(2,"0");
  }

  function calculate(data){
    // session.json v1.1ï¼štimeline + summary
    if (!data) return null;
    var tl = data.timeline || {};
    var sum = data.summary || {};

    var elapsedSec = Number(tl.elapsedSec || 0);
    var distanceKm = Number(sum.distanceKm || tl.distanceKm || 0);

    // speed km/h
    var speed = (elapsedSec > 0)
      ? (distanceKm / (elapsedSec / 3600))
      : 0;

    // pace min'sec"
    var pace = "--'--\"";
    if (distanceKm > 0.005 && elapsedSec > 0){
      var totalMin = (elapsedSec / 60) / distanceKm;
      var mm = Math.floor(totalMin);
      var ss = Math.round((totalMin - mm) * 60);
      if (ss === 60){ mm += 1; ss = 0; }
      pace = mm + "'" + String(ss).padStart(2,"0") + '"';
    }

    return {
      pace: pace,
      speedKmh: (Number.isFinite(speed) ? speed : 0),
      distKm: (Number.isFinite(distanceKm) ? distanceKm : 0),
      elapsedSec: elapsedSec,
      state: String(tl.state || "")
    };
  }

  function render(stats){
    var el = document.getElementById(containerId);
    if (!el) return;

    // stats ä¸ºç©ºä¹Ÿè¦æ¸²æŸ“ï¼ˆå½»åº•è¦†ç›–â€œç­‰å¾…è¡Œèµ°æ•°æ®...â€ï¼‰
    var pace = (stats && stats.pace) ? stats.pace : "--'--\"";
    var speed = (stats && Number.isFinite(stats.speedKmh)) ? stats.speedKmh.toFixed(1) : "0.0";
    var dist  = (stats && Number.isFinite(stats.distKm)) ? stats.distKm.toFixed(2) : "0.00";
    var used  = (stats && Number.isFinite(stats.elapsedSec)) ? fmtHMS(stats.elapsedSec) : "--:--";
    var state = (stats && stats.state) ? stats.state : "PREPARE";

    el.innerHTML =
      '<div style="padding:24px 16px; color:#fff; text-align:center;">' +
        '<div style="font-size:13px; opacity:.6; margin-bottom:8px;">å½“å‰å¹³å‡é…é€Ÿ</div>' +
        '<div style="font-size:52px; font-weight:800; font-variant-numeric:tabular-nums; letter-spacing:-1px;">' + pace + '</div>' +
        '<div style="display:flex; justify-content:space-around; margin-top:28px; padding-top:18px; border-top:1px solid rgba(255,255,255,.15);">' +
          '<div>' +
            '<div style="font-size:12px; opacity:.5;">æ—¶é€Ÿ</div>' +
            '<div style="font-size:20px; font-weight:600;">' + speed + ' <small style="font-size:12px;">km/h</small></div>' +
          '</div>' +
          '<div>' +
            '<div style="font-size:12px; opacity:.5;">ç´¯è®¡é‡Œç¨‹</div>' +
            '<div style="font-size:20px; font-weight:600;">' + dist + ' <small style="font-size:12px;">km</small></div>' +
          '</div>' +
        '</div>' +
        '<div style="margin-top:14px; font-size:12px; opacity:.45;">ç”¨æ—¶ ' + used + ' Â· çŠ¶æ€ ' + state + '</div>' +
      '</div>';
  }

  async function fetchFirstOk(){
    for (var i=0;i<CANDIDATE_URLS.length;i++){
      var url = CANDIDATE_URLS[i] + "?t=" + Date.now();
      try{
        var res = await fetch(url, { cache: "no-store" });
        if (!res.ok) continue;
        var data = await res.json();
        return { data: data, url: CANDIDATE_URLS[i] };
      }catch(e){
        // continue
      }
    }
    return null;
  }

  var inited = false;
  async function tick(){
    // DOM å°šæœªå‡†å¤‡æ—¶ï¼Œå…ˆæ¸²æŸ“ä¸€æ¬¡å ä½ï¼Œé¿å…ç”¨æˆ·çœ‹åˆ°â€œç­‰å¾…...â€é•¿æœŸä¸å˜
    if (!inited){
      render(null);
      inited = true;
      console.log("ğŸ”¥", LOG_PREFIX, "LOADED");
    }

    var result = await fetchFirstOk();
    if (!result){
      // æ²¡æ‰¾åˆ° session.jsonï¼šä¿æŒå ä½ UIï¼Œä¸åˆ·æ§åˆ¶å°
      return;
    }

    var stats = calculate(result.data);
    render(stats);
  }

  // 2 ç§’ä¸€æ¬¡
  setInterval(tick, 2000);

  // é¦–æ¬¡å°½å¿«åˆ·æ–°ä¸€æ¬¡
  if (document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", function(){ tick(); });
  } else {
    tick();
  }
})();
</script>
<!-- DEBUG: force load scene_state.js -->
<script>
  console.log(">>> about to load scene_state.js");
</script>

<script src="./scene_state.js"></script>

<script>
  console.log(">>> after load scene_state.js", window.SceneState);
</script>



<script>
(function(){
  /* ========= é…ç½® ========= */
  const DRAWER_ID = "sceneDrawerPanel";
  const OPEN_CLASS = "open";
  const OPEN_BTN_ID = "drawerOpenButton";
  const CLOSE_BAR_ID = "sceneDrawerCloseBar";

  /* ========= å·¥å…· ========= */
  function $(id){ return document.getElementById(id); }
  function getDrawer(){ return $(DRAWER_ID); }
  function getHeader(){
    const d = getDrawer();
    if (!d) return null;
    // åªå–â€œæŠ½å±‰å†…éƒ¨â€çš„é‚£ä¸ª headerï¼ˆé¿å¼€ä½ é¡µé¢ä¸Šå…¶ä»– 9 å¤„åŒåï¼‰
    return d.querySelector(":scope > .scene-drawer-header") || d.querySelector(".scene-drawer-header");
  }
  function isOpen(){
    const d = getDrawer();
    return !!(d && d.classList.contains(OPEN_CLASS));
  }

  function openDrawer(){
    const d = getDrawer();
    if (!d) return;
    if (!d.classList.contains(OPEN_CLASS)){
      if (typeof window.setDrawerHeightMode === "function"){
        try{ window.setDrawerHeightMode("small"); }catch(e){}
      }
      d.classList.add(OPEN_CLASS);
    }
  }

  function closeDrawer(){
    const d = getDrawer();
    if (!d) return;
    if (d.classList.contains(OPEN_CLASS)){
      d.classList.remove(OPEN_CLASS);
      if (typeof window.setDrawerHeightMode === "function"){
        try{ window.setDrawerHeightMode("small"); }catch(e){}
      }
    }
  }

  /* ========= A) å¼ºåˆ¶ header æ¯›ç»ç’ƒåº•æ¿å¯è§ï¼ˆæŠŠåŸèƒŒæ™¯æ‰“ç©¿ï¼‰ ========= */
  function ensureHeaderBase(){
    const header = getHeader();
    if (!header || header.dataset.baseAdded) return;
    header.dataset.baseAdded = "1";

    header.style.position = "relative";
    header.style.zIndex = "2";
    // å…³é”®ï¼šæŠŠåŸ header èƒŒæ™¯â€œæ‰“ç©¿â€ï¼Œå¦åˆ™ ::before çœ‹ä¸è§
    header.style.setProperty("background","transparent","important");
    header.style.setProperty("box-shadow","none","important");

    const style = document.createElement("style");
    style.textContent = `
      /* header æ¯›ç»ç’ƒ */
      #${DRAWER_ID} > .scene-drawer-header::before{
        content:"";
        position:absolute;
        inset:0;
        background:rgba(20,20,20,0.52);
        backdrop-filter:blur(16px);
        -webkit-backdrop-filter:blur(16px);
        border-top-left-radius:14px;
        border-top-right-radius:14px;
        z-index:0;
        pointer-events:none;
      }
      #${DRAWER_ID} > .scene-drawer-header > *{
        position:relative;
        z-index:1;
      }

      /* å…³é—­ä¸‰è§’çš„â€œç‚¹æŒ‰å°åº•æ¿â€ï¼ˆåªç»™ä¸‰è§’é™„è¿‘ä¸€ç‚¹æš—è‰²ï¼‰ */
      #${CLOSE_BAR_ID} .closebar-hit{
        position:absolute;
        left:50%;
        top:45%;
        transform:translate(-50%,-50%);
        width:54px;
        height:26px;
        border-radius:10px;
        background:rgba(20,20,20,0.52);
        backdrop-filter:blur(16px);
        -webkit-backdrop-filter:blur(14px);
        box-shadow:0 6px 16px rgba(0,0,0,0.18);
        pointer-events:auto;
      }
    `;
    document.head.appendChild(style);
  }
/* ========= E) æŠ½å±‰æ•´ä½“æ¯›ç»ç’ƒåº•æ¿ï¼ˆä¸åƒæ‰‹åŠ¿ï¼‰ ========= */
function ensureDrawerBase(){
  const d = getDrawer();
  if (!d || d.dataset.baseAdded) return;
  d.dataset.baseAdded = "1";

  // æŠŠåŸ panel èƒŒæ™¯æ‰“ç©¿
  d.style.setProperty("background","transparent","important");

  const style = document.createElement("style");
  style.textContent = `
    #sceneDrawerPanel::before{
      content:"";
      position:absolute;
      inset:0;
      background:rgba(20,20,30,0.60);
      backdrop-filter:blur(18px);
      -webkit-backdrop-filter:blur(18px);
      border-top-left-radius:16px;
      border-top-right-radius:16px;
      z-index:0;
      pointer-events:none;
    }
    #sceneDrawerPanel > *{
      position:relative;
      z-index:1;
    }
  `;
  document.head.appendChild(style);
}

  /* ========= B) å…³é—­æ ï¼šä¸åƒæ‰‹åŠ¿ï¼Œåªç•™ä¸‰è§’èƒ½ç‚¹ï¼ˆå¹¶ç»™ä¸‰è§’ä¸€ä¸ªåŠé€æ˜åº•æ¿ï¼‰ ========= */
  function ensureCloseBar(){
    const d = getDrawer();
    if (!d) return;

    let bar = $(CLOSE_BAR_ID);
    if (!bar){
      bar = document.createElement("div");
      bar.id = CLOSE_BAR_ID;

      // closebar-hit æ˜¯åŠé€æ˜åº•æ¿ï¼ˆåªåœ¨ä¸‰è§’å‘¨å›´ï¼‰
      bar.innerHTML = `
        <div class="closebar-hit"></div>
        <div class="closebar-arrow"></div>
      `;

      d.insertBefore(bar, d.firstChild);

      Object.assign(bar.style,{
        position:"absolute",
        left:"0",
        top:"0",
        width:"100%",
        height:"36px",
        zIndex:"3",
        background:"transparent",
        pointerEvents:"none" // â­ æ”¾è¡Œæ‹–æ‹½/è½»æ‰«ç»™åŸ header
      });

      const hit = bar.querySelector(".closebar-hit");
      const arrow = bar.querySelector(".closebar-arrow");

      Object.assign(arrow.style,{
        position:"absolute",
        left:"50%",
        top:"50%",
        transform:"translate(-50%,-40%)",
        width:"0",
        height:"0",
        borderLeft:"7px solid transparent",
        borderRight:"7px solid transparent",
        borderTop:"9px solid #fff",
        opacity:"0.95",
        pointerEvents:"none" // è®©ç‚¹å‡»è½åˆ° hit ä¸Š
      });

      // åªç‚¹â€œä¸‰è§’é™„è¿‘åº•æ¿â€æ‰å…³é—­
      hit.addEventListener("click", function(e){
        e.stopPropagation();
        closeDrawer();
        syncOpenBtn();
      }, true);
    }
  }

  /* ========= C) æŠŠä¸¤ç»„æ•°å­—æ‰¾å›æ¥ï¼ˆå¦‚æœä¹‹å‰è¢«æŒªèµ°äº†ï¼Œå°±å¡å› headerï¼‰ ========= */
  function ensureTwoNumbers(){
    const header = getHeader();
    const d = getDrawer();
    if (!header || !d) return;

    const leftId  = "sceneSpeedDisplay";
    const rightId = "sceneTimeDeviation";

    // è¿™ä¿©æ˜¯ä½ åŸç»“æ„é‡Œçš„â€œçœŸèŠ‚ç‚¹â€
    let left  = document.getElementById(leftId);
    let right = document.getElementById(rightId);

    // å¦‚æœå®ƒä»¬ä¸åœ¨ header é‡Œï¼Œå°±æŠŠå®ƒä»¬ç§»åŠ¨å› headerï¼ˆè€Œä¸æ˜¯ cloneï¼‰
    if (left && !header.contains(left)){
      // ç¡®ä¿ header é‡Œæœ‰ left å®¹å™¨ä½ï¼ˆæ²¡æœ‰å°±æ’æœ€å‰ï¼‰
      const leftSlot = header.querySelector(".scene-drawer-header-left");
      if (leftSlot && leftSlot !== left){
        leftSlot.replaceWith(left);
      }else{
        header.insertBefore(left, header.firstChild);
      }
    }

    if (right && !header.contains(right)){
      const rightSlot = header.querySelector(".scene-drawer-header-right");
      if (rightSlot && rightSlot !== right){
        rightSlot.replaceWith(right);
      }else{
        header.appendChild(right);
      }
    }

    // æŠŠä¸­é—´ä¸‘æŒ‰é’®éšè—æ‰ï¼ˆä¿ç•™ DOM ä¸åŠ¨é€»è¾‘ï¼‰
    const center = header.querySelector(".scene-drawer-header-center");
    if (center) center.style.display = "none";
  }

  /* ========= D) æ‰“å¼€æŒ‰é’® ========= */
  function ensureOpenBtn(){
    let btn = $(OPEN_BTN_ID);
    if (!btn){
      btn = document.createElement("div");
      btn.id = OPEN_BTN_ID;
      btn.innerHTML = `
        <div style="
          width:0;height:0;
          border-left:8px solid transparent;
          border-right:8px solid transparent;
          border-bottom:10px solid #fff;
          pointer-events:none;
          opacity:.95;
        "></div>
      `;
      Object.assign(btn.style,{
        position:"fixed",
        left:"50%",
        bottom:"60px",
        transform:"translateX(-50%)",
        width:"88px",
        height:"30px",
        borderRadius:"15px",
        background:"rgba(35,35,35,.75)",
        backdropFilter:"blur(10px)",
        WebkitBackdropFilter:"blur(10px)",
        display:"flex",
        alignItems:"center",
        justifyContent:"center",
        zIndex:999999,
        cursor:"pointer"
      });
      document.body.appendChild(btn);
    }

    if (!btn.dataset.bound){
      btn.addEventListener("click", function(e){
        e.preventDefault();
        e.stopPropagation();
        openDrawer();
        syncOpenBtn();
      }, true);
      btn.dataset.bound = "1";
    }
  }

  function syncOpenBtn(){
    const btn = $(OPEN_BTN_ID);
    if (!btn) return;
    btn.style.display = isOpen() ? "none" : "flex";
  }

  function keepAlive(){
      ensureDrawerBase(); 
    ensureHeaderBase();
    ensureCloseBar();
    ensureTwoNumbers();
    ensureOpenBtn();
    syncOpenBtn();
  }

  setTimeout(keepAlive,50);
  setTimeout(keepAlive,300);
  setTimeout(keepAlive,800);

  const mo = new MutationObserver(keepAlive);
  mo.observe(document.documentElement,{childList:true,subtree:true});
  setInterval(keepAlive,400);
})();
</script>


</body>
</html>
